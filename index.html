<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUDY QUEST | Stationary Master</title>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base & Reset */
        body { font-family: 'BIZ UDPGothic', sans-serif; text-align: center; background-color: #2c3e50; color: #ecf0f1; margin: 0; padding: 0; touch-action: manipulation; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button { cursor: pointer; font-family: inherit; user-select: none; -webkit-tap-highlight-color: transparent; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: #2c3e50; z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; }

        /* Animations */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes damageFloat { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 15% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; } }
        .cutin { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 5em; font-weight: 900; color: #f1c40f; -webkit-text-stroke: 3px #c0392b; text-shadow: 4px 4px 0 #000; pointer-events: none; z-index: 2000; animation: damageFloat 1.2s ease-out forwards; white-space: nowrap; }
        
        /* UI Components */
        .header { padding: 5px 10px; background: #34495e; border-bottom: 4px solid #2c3e50; display: flex; justify-content: space-between; align-items: center; height: 55px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; gap: 8px; width: 100%; box-sizing: border-box; }
        .life-container { font-size: 1.2em; color: #e74c3c; letter-spacing: 1px; flex-shrink: 0; }
        .timer-container { flex-grow: 1; background: #444; height: 16px; position: relative; border: 2px solid #fff; border-radius: 8px; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .timer-bar-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.1s linear; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-timer-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; line-height: 16px; font-weight: bold; text-shadow: 1px 1px 0 #000; font-size: 0.8em; color: #fff; letter-spacing: 1px; }
        .stats-container { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .stats-box { font-size: 0.7em; background: rgba(0,0,0,0.3); padding: 4px 6px; border-radius: 4px; border: 1px solid #555; font-weight: bold; white-space: nowrap; color: #ecf0f1; }
        .header-pause-btn { background: #f39c12; color: #fff; border: 2px solid #fff; border-radius: 5px; width: 36px; height: 36px; font-size: 1.0em; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 0 #d35400; flex-shrink: 0; padding: 0; }
        .header-pause-btn:active { transform: translateY(2px); box-shadow: none; }

        /* Title Area */
        .title-screen-bg { background: linear-gradient(135deg, #2c3e50, #1a252f); }
        .title-logo { font-size: 3.5em; font-weight: 900; margin-top: 40px; color: #f1c40f; text-shadow: 4px 4px 0 #e67e22, 0 0 20px rgba(241, 196, 15, 0.5); line-height: 1.1; letter-spacing: 0.05em; }
        .version-text { color:#bdc3c7; margin-bottom: 20px; cursor: pointer; text-decoration: underline; font-size: 0.9em; transition: color 0.2s; }
        .version-text:hover { color: #fff; }
        
        .menu-btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; width: 90%; max-width: 400px; margin-left: auto; margin-right: auto; }
        
        /* Menu Buttons */
        .menu-btn { 
            flex: 1; min-width: 120px; height: 65px; margin: 0; padding: 5px 10px;
            background: #e67e22; color: white; border: none; border-radius: 15px; 
            font-weight: bold; border-bottom: 6px solid #d35400; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.1s; 
            position: relative;
            display: flex; align-items: center; justify-content: center; 
            flex-direction: row; gap: 5px;
            font-family: 'BIZ UDPGothic', sans-serif; font-size: 1.0em; 
            white-space: nowrap;
        }
        .menu-btn:active { transform: translateY(6px); border-bottom: none; box-shadow: none; margin-bottom: 6px; }

        /* Gacha Button (2 lines) */
        .menu-btn.multi-line {
            flex-direction: column; line-height: 1.3; font-size: 0.9em; height: 75px; white-space: normal;
        }
        
        /* Modal Buttons */
        .modal .menu-btn, .pause-menu-box .menu-btn, #result-overlay .menu-btn {
            height: auto; padding: 12px; font-size: 1.1em; display: block; width: 100%; flex: none; min-width: auto;
        }

        .select-box { margin: 5px; padding: 12px; font-size: 1.0em; width: 90%; max-width: 320px; border-radius: 8px; border: 2px solid #95a5a6; background: #ecf0f1; font-family: inherit; font-weight: bold;}
        .badge { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.9em; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white; z-index: 10; }

        /* Game & Modals */
        .battle-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; background: #222; background-image: radial-gradient(#333 15%, transparent 16%), radial-gradient(#333 15%, transparent 16%); background-size: 20px 20px; background-position: 0 0, 10px 10px; overflow: hidden; padding: 10px 0; min-height: 0; }
        .enemy-visual-box { animation: float 3s ease-in-out infinite; margin-bottom: 10px; flex-grow: 1; display: flex; align-items: center; justify-content: center; max-height: 180px; min-height: 80px; width: 100%; }
        .enemy-visual { font-size: 80px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); display: flex; justify-content: center; align-items: center; }
        .enemy-visual img { width: 120px; height: 120px; object-fit: contain; }
        .enemy-stats-row { display: flex; align-items: center; justify-content: center; gap: 10px; width: 90%; max-width: 500px; margin-bottom: 10px; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 12px; border: 1px solid #555; flex-shrink: 0; }
        #ui-enemy-name { font-weight: bold; color: #f1c40f; text-shadow: 1px 1px 0 #000; white-space: nowrap; font-size: 1.1em; max-width: 40%; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.05em;}
        .enemy-hp-frame { flex-grow: 1; height: 20px; background: #111; border: 2px solid #fff; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 2px 0 rgba(0,0,0,0.5); }
        .enemy-hp-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); width: 100%; transition: width 0.3s ease-out; }
        #ui-hp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; text-shadow: 1px 1px 2px #000; color: #fff; z-index: 5; letter-spacing: 1px;}
        .question-box { background: #fff; color: #2c3e50; width: 90%; max-width: 600px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.4em; min-height: 80px; max-height: 180px; overflow-y: auto; display: flex; align-items: center; justify-content: center; border: 4px solid #bdc3c7; box-shadow: 0 6px 0 #7f8c8d; margin-bottom: 15px; text-align: center; line-height: 1.5; flex-shrink: 0; font-family: 'BIZ UDPGothic', sans-serif; }
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 94%; max-width: 600px; padding: 10px; padding-bottom: 20px; margin: 0 auto; flex-shrink: 0; }
        .choice-btn { padding: 15px 5px; background: #3498db; border: none; border-radius: 12px; color: white; font-size: 1.1em; font-weight: bold; border-bottom: 6px solid #2980b9; transition: transform 0.05s, background 0.2s; position: relative; overflow: hidden; min-height: 60px; display: flex; align-items: center; justify-content: center; line-height: 1.3; font-family: 'BIZ UDPGothic', sans-serif;}
        .choice-btn:active { transform: translateY(6px); border-bottom: none; margin-bottom: 6px; background: #2980b9; }
        .choice-btn.btn-correct { background: #27ae60 !important; border-bottom: 6px solid #1e8449 !important; transform: translateY(4px); border-bottom-width: 2px !important; margin-bottom: 4px; opacity: 1 !important; }
        .choice-btn.btn-wrong { background: #7f8c8d !important; border-bottom: 6px solid #555 !important; opacity: 0.6 !important; }
        .choice-btn.btn-miss-answer { background: #e74c3c !important; border-color: #c0392b !important; color: #fff !important; opacity: 1 !important; animation: pulseRed 0.8s ease-in-out infinite alternate; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #fdfefe; color: #333; width: 92%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; text-align: center; border: 6px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3); }
        .pause-menu-box { background: #2c3e50; padding: 30px; border: 4px solid #ecf0f1; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; width: 280px; text-align: center; }
        .pause-note { color: #bdc3c7; font-size: 0.8em; margin-top: 10px; }

        /* Cards & Shop & Mission */
        .char-card { border: 2px solid #ddd; padding: 8px; border-radius: 10px; margin: 4px; display: inline-block; width: 70px; font-size: 0.7em; cursor: pointer; background: #f9f9f9; vertical-align: top; transition: all 0.2s; position: relative; }
        .char-card:hover { transform: translateY(-3px); }
        .char-card.owned { background: #fff; border-color: #bdc3c7; }
        .char-card.active { background: #fffbe6; border: 3px solid #e67e22; transform: scale(1.05); box-shadow: 0 0 10px rgba(230, 126, 34, 0.4); }
        .char-img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 4px; }
        
        .char-lvl-badge { position: absolute; top: -5px; right: -5px; background: #3498db; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7em; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); z-index: 2; }
        .char-stock-badge { position: absolute; bottom: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7em; font-weight: bold; border: 1px solid white; z-index: 2; }
        
        /* â˜… Shop Item Layout */
        .shop-item { display: flex; align-items: center; justify-content: space-between; background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 10px; border: 2px solid #bdc3c7; text-align: left; transition: transform 0.1s; width: 100%; box-sizing: border-box; gap: 10px; }
        .shop-item:active { transform: scale(0.98); }
        .shop-icon { width: 50px; height: 50px; font-size: 2.2em; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .shop-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .shop-name { font-weight: bold; font-size: 1.1em; color: #2c3e50; line-height: 1.3; }
        .shop-desc { font-size: 0.85em; color: #7f8c8d; margin-top: 3px; line-height: 1.3; }
        .shop-right { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 80px; flex-shrink: 0; gap: 5px; }
        .shop-level-tag { font-size: 0.85em; font-weight: bold; color: #2980b9; background: #ecf0f1; padding: 2px 8px; border-radius: 10px; white-space: nowrap; }
        .shop-buy-btn { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #1e8449; width: 100%; font-size: 0.9em; min-width: 70px; }
        .shop-buy-btn:active { transform: translateY(4px); border-bottom: none; }
        .shop-buy-btn:disabled { background: #95a5a6; border-bottom: none; cursor: default; transform: none; }

        .rarity-SSR { color: #f1c40f; text-shadow: 0 0 1px #000; font-weight: 900; } .rarity-SR { color: #e74c3c; font-weight: bold; } .rarity-R { color: #3498db; font-weight: bold; } .rarity-N { color: #7f8c8d; }
        .gacha-result-card { background: #fff; padding: 20px; border-radius: 15px; border: 4px solid #ccc; text-align: center; margin-bottom: 20px; position: relative; }
        .gr-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .gr-mini-card { background: #fff; border: 2px solid #ccc; border-radius: 8px; padding: 5px; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; }
        .gr-mini-img { width: 60px; height: 60px; object-fit: contain; margin: 5px 0; }
        .detail-img { width: 100px; height: 100px; object-fit: contain; margin: 10px auto; background: #eee; border-radius: 10px; padding: 10px; border: 2px solid #ccc; }
        .detail-stat-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #ccc; }
        .detail-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .detail-btn { flex: 1; padding: 10px; border-radius: 5px; border: none; font-weight: bold; color: white; cursor: pointer; }
        .exp-bar-container { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .exp-bar-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        .material-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .mat-card { border: 1px solid #ccc; border-radius: 5px; padding: 5px; text-align: center; cursor: pointer; background: #fff; font-size: 0.7em; }
        .mat-card:hover { background: #eef; }
        .mat-exp-val { color: #e67e22; font-weight: bold; }
        .mission-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .mission-item { background: #fff; padding: 10px; border-radius: 10px; border: 2px solid #bdc3c7; text-align: left; }
        .mission-title { font-weight: bold; color: #2c3e50; display: flex; justify-content: space-between; }
        .mission-reward { color: #e67e22; font-size: 0.9em; font-weight: bold; }
        .mission-progress-bg { background: #eee; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .mission-progress-fill { background: #3498db; height: 100%; width: 0%; transition: width 0.3s; }
        .mission-btn { margin-top: 5px; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .mission-btn.active { background: #e67e22; border-bottom: 3px solid #d35400; }
        .mission-btn.disabled { background: #bdc3c7; color: #7f8c8d; cursor: default; }
        .mission-complete { background: #d4edda; border-color: #c3e6cb; }
        /* Version History */
        .version-list { text-align: left; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 0.9em; line-height: 1.6; }
        .version-list h4 { color: #e67e22; margin: 10px 0 5px 0; border-bottom: 1px solid #ddd; }
        .version-list ul { margin: 0; padding-left: 20px; }
        #loading-screen { z-index: 200; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top: 5px solid #f1c40f; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        #error-message { color: #e74c3c; margin-top: 20px; font-weight: bold; max-width: 80%; background: white; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div id="loading-screen" class="screen">
    <div style="margin: auto; width: 100%; max-width: 400px;">
        <div class="spinner"></div>
        <h2 style="margin:0;">CONNECTING...</h2>
        <div id="error-message"></div>
    </div>
</div>

<div id="title-screen" class="screen title-screen-bg hidden">
    <div class="title-logo">STUDY<br>QUEST</div>
    <div class="version-text" onclick="openVersionHistory()">Ver 5.14.29</div>
    
    <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; width: 92%; max-width: 380px; margin: 0 auto;">
        <select id="grade-select" class="select-box" onchange="filterSubjects()">
            <option value="">å­¦å¹´ã‚’é¸æŠ</option>
        </select>
        <select id="subject-select" class="select-box" onchange="filterUnits()">
            <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
        </select>
        <select id="unit-select" class="select-box">
            <option value="">å˜å…ƒã‚’é¸æŠ</option>
        </select>
    </div>
    
    <div class="menu-btn-container">
        <button class="menu-btn" onclick="startGame()">
            â–¶ ã‚¯ã‚¨ã‚¹ãƒˆ
        </button>
        
        <button class="menu-btn" style="background:#e74c3c; border-color:#c0392b;" onclick="openMissions()">
            ğŸ“ MISSION
            <div id="mission-badge" class="badge hidden">!</div>
        </button>
        
        <button class="menu-btn multi-line" style="background:#8e44ad; border-color:#6c3483;" onclick="openGacha()">
            <span>ğŸ’ ã‚¬ãƒãƒ£</span>
            <span>ğŸ“– å›³é‘‘</span>
        </button>
        
        <button class="menu-btn" style="background:#27ae60; border-color:#1e8449;" onclick="openShop()">
            ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—
        </button>
    </div>
    
    <div style="position: absolute; bottom: 15px; width: 100%; color: #95a5a6; font-size: 0.9em; display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div id="title-chara-img" style="width: 40px; height: 40px; background: #333; border-radius: 5px; overflow: hidden;"></div>
        <div>è£…å‚™: <span id="title-equipped-name" style="color:#fff; font-weight:bold;">ãªã—</span><br>æ‰€æŒXP: <span id="title-xp" style="color:#f1c40f;">0</span></div>
    </div>
</div>

<div id="game-screen" class="screen hidden">
    <div class="header">
        <div class="life-container" id="ui-life">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="timer-container"><div id="ui-timer" class="timer-bar-fill"></div><div id="ui-timer-text">10.0</div></div>
        <div class="stats-container"><div class="stats-box">SCORE <span id="ui-score">0</span></div><div class="stats-box">COMBO <span id="ui-combo" style="color:#f1c40f;">0</span></div></div>
        <button class="header-pause-btn" onclick="togglePause()">â¸</button>
    </div>
    <div class="battle-area">
        <div class="enemy-visual-box"><div class="enemy-visual" id="ui-enemy-icon">ğŸ‘¾</div></div>
        <div class="enemy-stats-row"><div id="ui-enemy-name">BOSS</div><div class="enemy-hp-frame"><div id="ui-hp" class="enemy-hp-fill"></div><div id="ui-hp-text">1000 / 1000</div></div></div>
        <div id="ui-question" class="question-box">READY?</div>
    </div>
    <div class="choices-grid" id="ui-choices"></div>
    <div id="pause-overlay" class="overlay hidden">
        <div class="pause-menu-box">
            <h2 style="color:#f1c40f; margin:0;">PAUSE</h2>
            <button class="menu-btn" style="background:#27ae60;" onclick="resumeGame()">ã¤ã¥ãã‹ã‚‰</button>
            <button class="menu-btn" style="background:#e67e22;" onclick="retryGame()">æœ€åˆã‹ã‚‰</button>
            <button class="menu-btn" style="background:#c0392b;" onclick="backToTitleFromPause()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            <p class="pause-note">â€»ã€Œæœ€åˆã‹ã‚‰ã€ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸ã€ã‚’é¸ã¶ã¨<br>ã“ã®ãƒ—ãƒ¬ã‚¤ã§ç¨¼ã„ã çµŒé¨“å€¤ã¯<span style="color:#e74c3c">æ¶ˆæ»…</span>ã—ã¾ã™ã€‚</p>
        </div>
    </div>
</div>

<div id="result-overlay" class="overlay hidden"><div class="modal"><h2 id="res-title">QUEST CLEAR!</h2><div id="res-icon" style="font-size: 4em;"></div><p>ç²å¾—ã‚¹ã‚³ã‚¢: <span id="res-score">0</span></p><div style="background:#eee; padding:15px; border-radius:10px; margin:10px 0;">ç²å¾—XP<br><span id="res-xp" style="color:#f1c40f; font-weight:900; font-size:2.5em;">+0</span></div><button class="menu-btn" onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button></div></div>
<div id="login-bonus-overlay" class="overlay hidden" style="z-index: 300;"><div class="modal"><h2 style="color:#f1c40f; margin-top:0;">LOGIN BONUS</h2><div style="font-size:4em;">ğŸ</div><p style="margin:20px 0;">ä»Šæ—¥ã‚‚å­¦ç¿’ãŠç–²ã‚Œæ§˜ã§ã™ï¼<br>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</p><div style="background:#fef5e7; padding:20px; border-radius:10px; border:2px solid #e67e22; margin-bottom:20px;"><div style="font-size:1.2em; font-weight:bold; color:#e67e22;">+3000 EXP</div></div><button class="menu-btn" style="width:100%;" onclick="closeLoginBonus()">å—ã‘å–ã‚‹</button></div></div>
<div id="mission-overlay" class="overlay hidden" style="z-index: 250;"><div class="modal" style="max-width:500px;"><h2 style="color:#e74c3c; margin-top:0;">ğŸ“ DAILY MISSION</h2><div id="mission-list" class="mission-list"></div><div id="mission-all-clear" class="hidden" style="margin-top:10px; padding:10px; background:#fef5e7; border:2px solid #e67e22; border-radius:10px;"><div style="font-weight:bold; color:#e67e22;">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå ±é…¬</div><button id="btn-all-clear" class="menu-btn" style="width:100%; margin-top:5px; background:#f1c40f; border-color:#d35400;">3000 XPã‚’å—ã‘å–ã‚‹</button></div><button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeMissions()">é–‰ã˜ã‚‹</button></div></div>
<div id="gacha-overlay" class="overlay hidden"><div class="modal" style="max-width:500px;"><h2 style="color:#8e44ad; margin-top:0;">æ–‡æˆ¿å…·å›³é‘‘ & ã‚¬ãƒãƒ£</h2><div style="background:#f0f0f0; padding:10px; border-radius:10px; margin-bottom:15px; border: 2px solid #ccc;"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><span>æ‰€æŒXP: <span id="gacha-xp" style="color:#f39c12; font-weight:bold;">0</span></span></div><button onclick="rollGacha(1)" style="background:linear-gradient(to bottom, #3498db, #2980b9); border:none; padding:12px 25px; border-radius:25px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 4px 0 #1f618d; width:100%; font-size:1em; margin-bottom:10px;">ğŸ’ 3,000 XP (1å›)</button><button onclick="rollGacha(10)" style="background:linear-gradient(to bottom, #f1c40f, #f39c12); border:none; padding:12px 25px; border-radius:25px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 4px 0 #d35400; width:100%; font-size:1.1em; border: 2px solid white;">ğŸ’ 30,000 XP (10é€£!)</button></div><div id="zukan-grid" style="max-height: 400px; overflow-y: auto; text-align: left;"></div><button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeGacha()">é–‰ã˜ã‚‹</button></div></div>
<div id="chara-detail-overlay" class="overlay hidden" style="z-index: 150;"><div class="modal" style="max-width:350px;"><h3 id="cd-name" style="margin:0; font-size:1.5em; color:#2c3e50;">ã‚­ãƒ£ãƒ©å</h3><div class="rarity-SSR" id="cd-rarity" style="margin-bottom:10px;">SSR</div><img id="cd-img" src="" class="detail-img"><div style="background:#f9f9f9; padding:10px; border-radius:8px; text-align:left; font-size:0.9em;"><div class="detail-stat-row"><span>ãƒ¬ãƒ™ãƒ«</span><span id="cd-lv" style="font-weight:bold; color:#2980b9;">Lv.0 / 20</span></div><div class="detail-stat-row" style="align-items:center;"><span>EXP</span><div style="flex:1; margin-left:10px;"><div class="exp-bar-container"><div id="cd-exp-bar" class="exp-bar-fill"></div></div><div id="cd-exp-text" style="font-size:0.7em; text-align:right;">0 / 100</div></div></div><div class="detail-stat-row"><span>ã‚¹ã‚­ãƒ«</span><span id="cd-type">ATK</span></div><div class="detail-stat-row"><span>åŠ¹æœ</span><span id="cd-val" style="font-weight:bold; color:#e74c3c;">x1.5</span></div><div class="detail-stat-row"><span>åœ¨åº«æ•°</span><span id="cd-stock" style="font-weight:bold;">0å€‹</span></div></div><p id="cd-desc" style="font-size:0.8em; color:#7f8c8d; margin:10px 0; min-height:3em;">èª¬æ˜æ–‡</p><div class="detail-btn-row"><button class="detail-btn" style="background:#2ecc71;" onclick="equipCurrentChara()">è£…å‚™ã™ã‚‹</button></div><div class="detail-btn-row"><button id="btn-enhance" class="detail-btn" style="background:#e67e22;" onclick="openEnhanceMenu()">å¼·åŒ–<br><span style="font-size:0.7em;">ç´ æé¸æŠã¸</span></button><button id="btn-sell" class="detail-btn" style="background:#95a5a6;" onclick="sellCharaStock()">å£²å´</button></div><button class="menu-btn" style="margin-top:20px; font-size:0.9em; padding:8px; background:#bdc3c7; border-color:#95a5a6;" onclick="closeCharaDetail()">é–‰ã˜ã‚‹</button></div></div>
<div id="material-select-overlay" class="overlay hidden" style="z-index: 160;"><div class="modal" style="max-width:350px;"><h3 style="margin:0; color:#e67e22;">å¼·åŒ–ç´ æã‚’é¸æŠ</h3><div id="material-list" class="material-list"></div><button class="menu-btn" style="margin-top:20px; background:#bdc3c7;" onclick="closeEnhanceMenu()">æˆ»ã‚‹</button></div></div>
<div id="gacha-result-overlay" class="overlay hidden"><div class="modal" style="max-width:400px;"><div id="gr-container"></div><button class="menu-btn" style="margin-top:20px;" onclick="closeGachaResult()">OK</button></div></div>
<div id="shop-overlay" class="overlay hidden"><div class="modal"><h2 style="color:#27ae60;">ğŸ›’ å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ </h2><div style="text-align:right;">æ‰€æŒXP: <span id="shop-xp">0</span></div><div id="shop-list"></div><button class="menu-btn" style="margin-top:20px;" onclick="closeShop()">é–‰ã˜ã‚‹</button></div></div>
<div id="version-overlay" class="overlay hidden"><div class="modal" style="max-width:500px;"><h2 style="color:#2c3e50;">æ›´æ–°å±¥æ­´</h2><div class="version-list"><h4>Ver 5.14.29 (Official)</h4><ul><li><b>BugFix</b>: ã‚·ãƒ§ãƒƒãƒ—ç”»é¢ã§æ‰€æŒXPãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã‚’ä¿®æ­£</li><li><b>BugFix</b>: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ç²å¾—çµŒé¨“å€¤ã‚’ã‚¹ã‚³ã‚¢ç­‰å€(1.0å€)ã«ä¿®æ­£</li><li><b>System</b>: AIè‡ªå‹•ç”Ÿæˆã®å¼·åŒ–(å•é¡Œæ•°æŒ‡å®š)</li></ul></div><button class="menu-btn" style="margin-top:20px;" onclick="closeVersionHistory()">é–‰ã˜ã‚‹</button></div></div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycby54ewlale8B2ivoL-nUvEFPdNYRmYCo2GeS1noeBHZOAs6GIQ9_IxAVQV95e_o7w9M/exec';
    
    // Settings
    const RARITY_CAPS = { 'N': 5, 'R': 10, 'SR': 15, 'SSR': 20 };
    const LV_BONUS_RATE = 0.01;
    const EXP_REQ = 100;
    const MAT_EXP = { 'N': 25, 'R': 50, 'SR': 100, 'SSR': 200 };
    const SELL_PRICES = { 'N': 250, 'R': 500, 'SR': 1000, 'SSR': 2000 };
    const LOGIN_BONUS_EXP = 3000;
    const MAX_ITEM_LEVEL = 10;
    const MISSIONS = [
        { id: 'play', target: 1, reward: 500, title: "æœ¬æ—¥ã®æŒ‘æˆ¦", desc: "ã‚¯ã‚¨ã‚¹ãƒˆã‚’1å›ãƒ—ãƒ¬ã‚¤" },
        { id: 'kill', target: 1, reward: 1000, title: "ãƒœã‚¹æ’ƒç ´ï¼", desc: "ãƒœã‚¹ã‚’1ä½“å€’ã™" },
        { id: 'correct', target: 10, reward: 1000, title: "ä¿®è¡Œã®æˆæœ", desc: "åˆè¨ˆ10å•æ­£è§£ã™ã‚‹" },
        { id: 'maxCombo', target: 5, reward: 1000, title: "ã‚³ãƒ³ãƒœãƒã‚¹ã‚¿ãƒ¼", desc: "5ã‚³ãƒ³ãƒœä»¥ä¸Šé”æˆ" },
        { id: 'enhance', target: 1, reward: 500, title: "è£…å‚™ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹", desc: "ã‚­ãƒ£ãƒ©ã‚’1å›å¼·åŒ–" }
    ];
    const MISSION_ALL_CLEAR = 3000;

    let rawData = {};
    let playData = { questions: [], qIndex: 0, currentBoss: null };
    let gameState = { score: 0, combo: 0, lives: 3, enemyHP: 100, maxHP: 100, timer: null, timeLeft: 0, maxTime: 10, xp: 0, equipped: '1', itemLevels: {}, charaInventory: {} };
    let dailyMissions = { date: "", progress: { play: 0, kill: 0, correct: 0, maxCombo: 0, enhance: 0 }, claimed: { play: false, kill: false, correct: false, maxCombo: false, enhance: false, allClear: false } };
    let viewingCharaId = null, isGameActive = false, isPaused = false;

    window.onload = async () => { 
        loadSaveData(); 
        await fetchData(); 
        initTitle(); 
        checkLoginBonus(); 
        checkMissionDate(); 
    };

    // â˜… Data Migration
    function loadSaveData() {
        try {
            gameState.xp = parseInt(localStorage.getItem('sq_xp') || '0');
            gameState.equipped = localStorage.getItem('sq_equip') || '1';
            gameState.itemLevels = JSON.parse(localStorage.getItem('sq_items_v2') || '{}');

            let inv = localStorage.getItem('sq_inventory');
            if (!inv) {
                const oldCharas = localStorage.getItem('sq_charas');
                if (oldCharas) {
                    const idList = JSON.parse(oldCharas);
                    gameState.charaInventory = {};
                    idList.forEach(id => {
                        gameState.charaInventory[id] = { level: 1, count: 1, exp: 0 };
                    });
                } else {
                    gameState.charaInventory = { "1": { level: 1, count: 1, exp: 0 } };
                }
            } else {
                gameState.charaInventory = JSON.parse(inv);
            }
        } catch(e) {
            console.error("Save Data Error:", e);
            gameState.charaInventory = { "1": { level: 1, count: 1, exp: 0 } }; 
        }
    }

    function saveGame() {
        localStorage.setItem('sq_xp', gameState.xp);
        localStorage.setItem('sq_equip', gameState.equipped);
        localStorage.setItem('sq_items_v2', JSON.stringify(gameState.itemLevels));
        localStorage.setItem('sq_inventory', JSON.stringify(gameState.charaInventory));
        localStorage.setItem('sq_missions', JSON.stringify(dailyMissions));
    }

    // --- Fetch Data ---
    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error("Network response was not ok");
            const data = await res.json();
            
            // â˜… FIX: Helper to preserve "0" as string
            const getVal = (obj, keys) => {
                for (const k of keys) {
                    const v = obj[k];
                    if (v !== undefined && v !== null && v !== "") return String(v);
                }
                return "";
            };

            rawData = {};
            for (let key in data) {
                const lowerKey = key.toLowerCase();
                try {
                    if (lowerKey.includes('questions') || lowerKey.includes('question')) {
                        
                        rawData.questions = data[key].filter(d => d).map(q => ({
                            grade: getVal(q, ['grade', 'å­¦å¹´']),
                            subject: getVal(q, ['subject', 'æ•™ç§‘']),
                            unit: getVal(q, ['unit', 'å˜å…ƒ']),
                            q: getVal(q, ['q', 'question', 'å•é¡Œ', 'å•é¡Œæ–‡']),
                            a: getVal(q, ['a', 'answer', 'æ­£è§£']),
                            choices: q.choices ? String(q.choices).split(',') : [
                                getVal(q, ['èª¤ç­”1']), getVal(q, ['èª¤ç­”2']), getVal(q, ['èª¤ç­”3']), getVal(q, ['a', 'æ­£è§£'])
                            ].filter(x => x !== "")
                        }));
                    } else if (lowerKey.includes('character')) {
                        rawData.characters = data[key].filter(d => d).map(c => ({
                            id: String(c.id || c.ID || Math.random()), name: String(c.name || c.åå‰ || "Unknown"), rarity: String(c.rarity || c.ãƒ¬ã‚¢ || "N"),
                            type: String(c.type || c.ã‚¿ã‚¤ãƒ— || "ATK"), value: Number(c.value || c.è£œæ­£å€¤ || c.åŠ¹æœå€¤ || 1.0), desc: String(c.desc || c.è§£èª¬ || ""),
                            imageUrl: String(c.imageUrl || c.ç”»åƒURL || c.ç”»åƒ || "").replace('http:', 'https:')
                        }));
                    } else if (lowerKey.includes('boss')) {
                        rawData.bosses = data[key].filter(d => d).map(b => ({
                            grade: String(b.grade || b.å­¦å¹´ || ""), unit: String(b.unit || b.å˜å…ƒ || ""), name: String(b.name || b.bossName || b.ãƒœã‚¹å || "Boss"),
                            hp: Number(b.hp || b.bossHP || b.ãƒœã‚¹HP || 1000), icon: String(b.icon || b.bossIcon || b.ãƒœã‚¹ç”»åƒ || "ğŸ‘¾")
                        }));
                    } else if (lowerKey.includes('shop')) {
                        rawData.shopItems = data[key].filter(d => d).map(i => ({
                            id: String(i.id || i.ID || Math.random()), name: String(i.name || i.ã‚¢ã‚¤ãƒ†ãƒ å || "Item"), price: Number(i.price || i.ä¾¡æ ¼ || 1000),
                            type: String(i.type || i.ã‚¿ã‚¤ãƒ— || "ATK"), value: Number(i.value || i.åŠ¹æœå€¤ || 0.1), desc: String(i.desc || i.èª¬æ˜ || ""), icon: String(i.icon || i.ã‚¢ã‚¤ã‚³ãƒ³ || "ğŸ")
                        }));
                    }
                } catch(e) { console.warn("Skip row"); }
            }

            if (!rawData.questions || rawData.questions.length === 0) throw new Error("Questions not found.");

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
        } catch(e) { 
            document.getElementById('error-message').innerText = e.message;
            document.getElementById('error-message').style.display = 'block';
        }
    }

    // --- UI Logic ---
    function initTitle() {
        if(!rawData.questions) return;
        const grades = [...new Set(rawData.questions.map(q => q.grade))].filter(g=>g);
        const gSelect = document.getElementById('grade-select');
        gSelect.innerHTML = '<option value="">å­¦å¹´ã‚’é¸æŠ</option>';
        grades.forEach(g => gSelect.innerHTML += `<option value="${g}">${g}</option>`);
        filterSubjects(); updateTitleInfo();
    }
    function filterSubjects() {
        const gVal = document.getElementById('grade-select').value;
        const sSelect = document.getElementById('subject-select');
        sSelect.innerHTML = '<option value="">æ•™ç§‘ã‚’é¸æŠ</option>';
        document.getElementById('unit-select').innerHTML = '<option value="">å˜å…ƒã‚’é¸æŠ</option>';
        if(!gVal) return;
        let targetList = rawData.questions.filter(q => q.grade == gVal);
        const subjects = [...new Set(targetList.map(q => q.subject))].filter(s=>s);
        subjects.forEach(s => sSelect.innerHTML += `<option value="${s}">${s}</option>`);
    }
    function filterUnits() {
        const gVal = document.getElementById('grade-select').value;
        const sVal = document.getElementById('subject-select').value;
        const uSelect = document.getElementById('unit-select');
        uSelect.innerHTML = '<option value="">å˜å…ƒã‚’é¸æŠ</option>';
        if(!gVal || !sVal) return;
        let targetList = rawData.questions.filter(q => q.grade == gVal && q.subject == sVal);
        const units = [...new Set(targetList.map(q => q.unit))].filter(u=>u);
        units.forEach(u => uSelect.innerHTML += `<option value="${u}">${u}</option>`);
    }
    function updateTitleInfo() {
        const chara = rawData.characters ? rawData.characters.find(c => c.id == gameState.equipped) : null;
        let lv = (gameState.charaInventory[gameState.equipped] || {}).level || 0;
        document.getElementById('title-equipped-name').innerText = (chara ? chara.name : "ãªã—") + " Lv." + lv;
        document.getElementById('title-xp').innerText = gameState.xp;
        const imgContainer = document.getElementById('title-chara-img');
        if(chara?.imageUrl && chara.imageUrl.startsWith('http')) imgContainer.innerHTML = `<img src="${chara.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
        else imgContainer.innerHTML = `<div style="text-align:center;line-height:40px;">âœï¸</div>`;
    }

    // --- Game Engine ---
    function startGame() {
        const g = document.getElementById('grade-select').value, s = document.getElementById('subject-select').value, u = document.getElementById('unit-select').value;
        if(!g || !s || !u) return alert("å…¨ã¦é¸æŠã—ã¦ãã ã•ã„");
        let qList = rawData.questions.filter(q => q.grade == g && q.subject == s && q.unit == u);
        if(qList.length === 0) return alert("å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
        
        let boss = rawData.bosses ? rawData.bosses.find(b => b.unit == u && b.grade == g) : null;
        if(!boss) boss = { name: "ãƒ†ã‚¹ãƒˆã®é­”äºº", hp: 1000, icon: "ğŸ˜ˆ" };
        
        playData.questions = qList.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        const charaStats = getCharaStats();
        // â˜… FIX: Combo Reset Here too
        gameState.score = 0; gameState.combo = 0; 
        gameState.lives = 3; gameState.enemyHP = Number(boss.hp)||1000; gameState.maxHP = gameState.enemyHP; 
        gameState.maxTime = 10 * charaStats.time;
        isGameActive = true; isPaused = false;
        
        document.getElementById('pause-overlay').classList.add('hidden');
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('ui-enemy-name').innerText = boss.name;
        const ic = document.getElementById('ui-enemy-icon');
        if(boss.icon.startsWith('http')) ic.innerHTML = `<img src="${boss.icon}" style="width:100px;height:100px;object-fit:contain;">`; else ic.innerHTML = boss.icon;
        
        updateUI(); nextQuestion();
    }
    function getCharaStats() {
        let stats = { atk: 1.0, time: 1.0, exp: 1.0 };
        if(rawData.characters) {
            const charaData = rawData.characters.find(c => c.id == gameState.equipped);
            if(charaData) {
                let userChara = gameState.charaInventory[gameState.equipped];
                let level = userChara ? userChara.level : 0;
                let val = Number(charaData.value);
                let finalVal = val + (level * LV_BONUS_RATE);
                if(charaData.type === 'ATK') stats.atk = finalVal;
                if(charaData.type === 'TIME') stats.time = finalVal;
                if(charaData.type === 'EXP') stats.exp = finalVal;
            }
        }
        if(gameState.itemLevels && rawData.shopItems) {
            Object.keys(gameState.itemLevels).forEach(itemId => {
                const item = rawData.shopItems.find(i => i.id === itemId);
                const level = gameState.itemLevels[itemId];
                if(item && level > 0) {
                    if(item.type === 'ATK') stats.atk += (Number(item.value) * level);
                    if(item.type === 'TIME') stats.time += (Number(item.value) * level);
                    if(item.type === 'EXP') stats.exp += (Number(item.value) * level);
                }
            });
        }
        return stats;
    }

    function nextQuestion() {
        if(!isGameActive) return;
        if(playData.qIndex >= playData.questions.length) { playData.questions.sort(()=>Math.random()-0.5); playData.qIndex = 0; }
        const q = playData.questions[playData.qIndex];
        playData.currentQ = q;
        document.getElementById('ui-question').innerText = q.q;
        const choices = [...q.choices].sort(() => Math.random() - 0.5);
        const div = document.getElementById('ui-choices'); div.innerHTML = '';
        choices.forEach(c => {
            const btn = document.createElement('button'); btn.className = 'choice-btn'; btn.innerText = c;
            // â˜… FIX: String comparison for "0"
            btn.onclick = () => judge(String(c) === String(q.a), btn); 
            div.appendChild(btn);
        });
        startTimer();
    }
    function startTimer() { if(gameState.timer) clearInterval(gameState.timer); if(!isGameActive) return; gameState.timeLeft = gameState.maxTime; const bar = document.getElementById('ui-timer'); gameState.timer = setInterval(() => { if(isPaused || !isGameActive) return; gameState.timeLeft -= 0.1; bar.style.width = (gameState.timeLeft / gameState.maxTime * 100) + '%'; document.getElementById('ui-timer-text').innerText = Math.max(0, gameState.timeLeft).toFixed(1); if(gameState.timeLeft <= 0) { clearInterval(gameState.timer); judge(false, null); } }, 100); }
    
    function judge(isCorrect, btn) {
        if(isPaused || !isGameActive) return;
        clearInterval(gameState.timer);
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
        if(btn) btn.classList.add(isCorrect ? 'btn-correct' : 'btn-wrong');
        
        if(!isCorrect) {
            // â˜… FIX: String comparison here too
            document.querySelectorAll('.choice-btn').forEach(b => { 
                if(String(b.innerText) === String(playData.currentQ.a)) b.classList.add('btn-miss-answer'); 
            });
        }

        if(isCorrect) {
            const stats = getCharaStats();
            const damage = Math.floor(50 * stats.atk * (0.2 + (gameState.timeLeft / gameState.maxTime) * 1.8) * (1 + (gameState.combo * 0.1)));
            gameState.enemyHP = Math.max(0, gameState.enemyHP - damage);
            gameState.score += damage; gameState.combo++;
            showCutIn("-" + damage);
            updateMissionProgress('correct', 1); updateMissionProgress('maxCombo', gameState.combo);
            updateUI();
            if(gameState.enemyHP <= 0) setTimeout(() => isGameActive && finishGame(true), 1000);
            else { playData.qIndex++; setTimeout(() => isGameActive && nextQuestion(), 1000); }
        } else {
            gameState.lives--; gameState.combo = 0;
            showCutIn("MISS..."); updateUI();
            if(gameState.lives <= 0) setTimeout(() => isGameActive && finishGame(false), 1500);
            else setTimeout(() => isGameActive && nextQuestion(), 1500);
        }
    }
    
    function showCutIn(t) { const d = document.createElement('div'); d.className='cutin'; d.innerText=t; if(t.includes('MISS')) { d.style.color='#bdc3c7'; d.style.webkitTextStroke='2px #2c3e50'; } document.body.appendChild(d); setTimeout(()=>d.remove(), 1500); }
    function updateUI() { document.getElementById('ui-life').innerText = 'â¤ï¸'.repeat(Math.max(0, gameState.lives)); document.getElementById('ui-score').innerText = gameState.score; document.getElementById('ui-combo').innerText = gameState.combo; document.getElementById('ui-hp').style.width = (gameState.enemyHP/gameState.maxHP*100)+'%'; document.getElementById('ui-hp-text').innerText = `${gameState.enemyHP}/${gameState.maxHP}`; }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-overlay').classList.toggle('hidden', !isPaused); }
    function resumeGame() { isPaused = false; document.getElementById('pause-overlay').classList.add('hidden'); }
    function retryGame() { if(confirm("ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")){ isGameActive=false; clearInterval(gameState.timer); resumeGame(); startGame(); } }
    function backToTitleFromPause() { if(confirm("æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")){ isGameActive=false; clearInterval(gameState.timer); backToTitle(); } }
    
    function finishGame(isClear) { 
        isGameActive=false; clearInterval(gameState.timer); 
        const stats=getCharaStats(); 
        // â˜…ä¿®æ­£: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚(false)ã®å€ç‡ã‚’0.5ã‹ã‚‰1.0ã«å¤‰æ›´ (ã‚¯ãƒªã‚¢æ™‚ã¯1.2)
        let earned = Math.floor((isClear ? gameState.score * 1.2 : gameState.score * 1.0) * stats.exp); 
        gameState.xp += earned; 
        saveGame(); 
        updateMissionProgress('play',1); 
        if(isClear) updateMissionProgress('kill',1); 
        document.getElementById('res-title').innerText=isClear?"QUEST CLEAR!":"GAME OVER"; 
        document.getElementById('res-icon').innerText=isClear?"ğŸ‰":"ğŸ’”"; 
        document.getElementById('res-title').style.color=isClear?"#f1c40f":"#bdc3c7"; 
        document.getElementById('res-score').innerText=gameState.score; 
        document.getElementById('res-xp').innerText="+"+earned; 
        document.getElementById('game-screen').classList.add('hidden'); 
        document.getElementById('result-overlay').classList.remove('hidden'); 
    }
    
    function backToTitle() { 
        document.getElementById('result-overlay').classList.add('hidden'); 
        document.getElementById('game-screen').classList.add('hidden'); 
        document.getElementById('title-screen').classList.remove('hidden'); 
        document.getElementById('pause-overlay').classList.add('hidden'); 
        isGameActive = false; isPaused = false; clearInterval(gameState.timer);
        updateTitleInfo(); updateMissionBadge(); 
    }
    
    // --- System Functions ---
    function checkLoginBonus() { const d=new Date().toLocaleDateString('ja-JP'); if(localStorage.getItem('sq_last_login')!==d){ gameState.xp+=LOGIN_BONUS_EXP; localStorage.setItem('sq_last_login',d); saveGame(); document.getElementById('login-bonus-overlay').classList.remove('hidden'); updateTitleInfo(); } }
    function closeLoginBonus() { document.getElementById('login-bonus-overlay').classList.add('hidden'); }
    function checkMissionDate() { const d=new Date().toLocaleDateString('ja-JP'); dailyMissions=JSON.parse(localStorage.getItem('sq_missions')||'{"date":"","progress":{},"claimed":{}}'); if(dailyMissions.date!==d){ dailyMissions={date:d,progress:{play:0,kill:0,correct:0,maxCombo:0,enhance:0},claimed:{}}; saveGame(); } updateMissionBadge(); }
    function updateMissionProgress(t,v) { if(t==='maxCombo') dailyMissions.progress[t]=Math.max(dailyMissions.progress[t]||0,v); else dailyMissions.progress[t]=(dailyMissions.progress[t]||0)+v; saveGame(); updateMissionBadge(); }
    function updateMissionBadge() { let c=0; MISSIONS.forEach(m=>{ if((dailyMissions.progress[m.id]||0)>=m.target && !dailyMissions.claimed[m.id]) c++; }); document.getElementById('mission-badge').classList.toggle('hidden', c===0); }
    
    function openMissions() { document.getElementById('mission-overlay').classList.remove('hidden'); renderMissions(); }
    function closeMissions() { document.getElementById('mission-overlay').classList.add('hidden'); }
    function renderMissions() { const l=document.getElementById('mission-list'); l.innerHTML=''; let all=true; MISSIONS.forEach(m=>{ const p=dailyMissions.progress[m.id]||0; const fin=p>=m.target; const clm=dailyMissions.claimed[m.id]; if(!fin)all=false; l.innerHTML+=`<div class="mission-item"><b>${m.title}</b> (${p}/${m.target})<br><small>${m.desc}</small><button class="mission-btn ${fin&&!clm?'active':'disabled'}" onclick="claimMission('${m.id}',${m.reward})">${clm?'å—å–æ¸ˆ':'å—å–'}</button></div>`; }); 
        const ac=document.getElementById('mission-all-clear'); if(all){ ac.classList.remove('hidden'); document.getElementById('btn-all-clear').innerText=dailyMissions.claimed.allClear?"å—å–æ¸ˆ":"3000 XPå—å–"; document.getElementById('btn-all-clear').onclick=()=>claimAllClear(); } else ac.classList.add('hidden'); }
    function claimMission(id,r) { if(dailyMissions.claimed[id])return; dailyMissions.claimed[id]=true; gameState.xp+=r; saveGame(); renderMissions(); updateTitleInfo(); updateMissionBadge(); alert(r+"XPç²å¾—"); }
    function claimAllClear() { if(dailyMissions.claimed.allClear)return; dailyMissions.claimed.allClear=true; gameState.xp+=MISSION_ALL_CLEAR; saveGame(); renderMissions(); updateTitleInfo(); updateMissionBadge(); alert(MISSION_ALL_CLEAR+"XPç²å¾—"); }

    function openGacha() { document.getElementById('gacha-overlay').classList.remove('hidden'); document.getElementById('gacha-xp').innerText=gameState.xp; renderZukan(); }
    function closeGacha() { document.getElementById('gacha-overlay').classList.add('hidden'); updateTitleInfo(); }
    
    function rollGacha(count) {
        const cost = 3000 * count;
        if (gameState.xp < cost) return alert("XPãŒè¶³ã‚Šã¾ã›ã‚“ï¼\nå¿…è¦: " + cost + " XP");
        
        gameState.xp -= cost;
        let results = [];
        
        for (let i = 0; i < count; i++) {
            let rand = Math.random(), rarity = 'N';
            if (rand < 0.02) rarity = 'SSR';
            else if (rand < 0.10) rarity = 'SR';
            else if (rand < 0.40) rarity = 'R';
            
            let targets = rawData.characters.filter(c => c.rarity === rarity);
            if (targets.length === 0) targets = rawData.characters;
            
            const hit = targets[Math.floor(Math.random() * targets.length)];
            
            if (!gameState.charaInventory[hit.id]) {
                gameState.charaInventory[hit.id] = { level: 0, count: 0, exp: 0 };
                results.push({ char: hit, isNew: true });
            } else {
                gameState.charaInventory[hit.id].count++;
                results.push({ char: hit, isNew: false });
            }
        }
        
        saveGame();
        renderZukan();
        updateTitleInfo();
        showGachaResults(results);
    }
    
    function showGachaResults(results) {
        const container = document.getElementById('gr-container');
        if(results.length === 1) { 
            const r = results[0]; 
            let visual = (r.char.imageUrl && r.char.imageUrl.startsWith('http')) ? `<img src="${r.char.imageUrl}" style="width:120px;height:120px;">` : `<div style="font-size:80px;">ğŸ“¦</div>`;
            container.innerHTML = `<div class="gacha-result-card">${r.isNew?'<div class="gr-new">NEW!</div>':''}<div class="gr-rarity rarity-${r.char.rarity}">â˜… ${r.char.rarity}</div>${visual}<div style="font-weight:bold;font-size:1.5em;">${r.char.name}</div><div style="color:#7f8c8d;">${r.isNew?'æ–°è¦å…¥æ‰‹':'åœ¨åº«(ç´ æ)+1'}</div></div>`; 
        } 
        else { 
            let html = '<h3 style="color:#f1c40f;">10é€£çµæœ!</h3><div class="gr-grid">'; 
            results.forEach(r => { 
                let visual = (r.char.imageUrl && r.char.imageUrl.startsWith('http')) ? `<img src="${r.char.imageUrl}" class="gr-mini-img">` : `<div style="font-size:30px;">ğŸ“¦</div>`;
                html += `<div class="gr-mini-card">${r.isNew?'<div class="gr-mini-new">NEW</div>':''}<div class="rarity-${r.char.rarity}" style="font-size:0.8em;">${r.char.rarity}</div>${visual}<div style="font-size:0.7em;font-weight:bold;">${r.char.name}</div></div>`; 
            }); 
            container.innerHTML = html + '</div>'; 
        }
        document.getElementById('gacha-overlay').classList.add('hidden'); document.getElementById('gacha-result-overlay').classList.remove('hidden');
    }
    function closeGachaResult() { document.getElementById('gacha-result-overlay').classList.add('hidden'); }

    function renderZukan() { 
        const g=document.getElementById('zukan-grid'); g.innerHTML=''; 
        if(rawData.characters) {
            rawData.characters.forEach(c=>{ 
                const data = gameState.charaInventory[c.id]; 
                const isOwned = !!data;
                const div = document.createElement('div');
                div.className = `char-card ${isOwned?'owned':''} ${gameState.equipped==c.id?'active':''}`;
                
                let visual, nameText, lvlBadge = '', stockBadge = '';
                
                if(isOwned) {
                    visual = (c.imageUrl && c.imageUrl.startsWith('http')) ? `<img src="${c.imageUrl}" class="char-img">` : `<div style="font-size:2em;line-height:50px">ğŸ“¦</div>`;
                    nameText = `${c.rarity} / ${c.type}`;
                    lvlBadge = `<div class="char-lvl-badge">Lv.${data.level}</div>`;
                    if(data.count > 0) stockBadge = `<div class="char-stock-badge">+${data.count}</div>`;
                    div.onclick = () => openCharaDetail(c.id);
                } else {
                    visual = `<div style="font-size:2em;line-height:50px;color:#bdc3c7;">?</div>`;
                    nameText = "???";
                }
                
                div.innerHTML = `${lvlBadge}${stockBadge}${visual}<div style="font-weight:bold;font-size:0.8em;">${nameText}</div>`;
                g.appendChild(div);
            });
        }
    }

    function openCharaDetail(id) { 
        viewingCharaId=id; 
        const c=rawData.characters.find(x=>x.id==id); 
        const o=gameState.charaInventory[id]; 
        if(!c||!o)return; 
        
        document.getElementById('cd-name').innerText=c.name; 
        document.getElementById('cd-rarity').innerText=c.rarity; 
        document.getElementById('cd-rarity').className = "rarity-" + c.rarity; 
        document.getElementById('cd-lv').innerText='Lv.'+o.level; 
        document.getElementById('cd-type').innerText=c.type; 
        
        // â˜… Value Update
        let val = c.value + (o.level * LV_BONUS_RATE);
        document.getElementById('cd-val').innerText='x'+val.toFixed(2); 
        
        document.getElementById('cd-stock').innerText=o.count + "å€‹"; 
        document.getElementById('cd-desc').innerText = c.desc || "";
        
        // â˜… EXP Bar Update (using Correct ID)
        document.getElementById('cd-exp-text').innerText = o.exp + ' / ' + EXP_REQ;
        document.getElementById('cd-exp-bar').style.width = (o.exp / EXP_REQ * 100) + '%';
        
        document.getElementById('chara-detail-overlay').classList.remove('hidden'); 
        if(c.imageUrl.startsWith('http')) document.getElementById('cd-img').src=c.imageUrl; else document.getElementById('cd-img').src=''; 
    }
    
    function closeCharaDetail() { 
        document.getElementById('chara-detail-overlay').classList.add('hidden'); 
        renderZukan(); // Update Zukan view
    }
    
    function equipCurrentChara() { gameState.equipped=viewingCharaId; saveGame(); alert("è£…å‚™ã—ã¾ã—ãŸ"); closeCharaDetail(); renderZukan(); updateTitleInfo(); }
    function sellCharaStock() { const o=gameState.charaInventory[viewingCharaId]; if(o.count>0 && confirm("å£²å´ã—ã¾ã™ã‹ï¼Ÿ")){ o.count--; gameState.xp+=200; saveGame(); openCharaDetail(viewingCharaId); } }
    
    function openEnhanceMenu() { 
        document.getElementById('material-select-overlay').classList.remove('hidden'); 
        document.getElementById('chara-detail-overlay').classList.add('hidden'); 
        const l=document.getElementById('material-list'); 
        l.innerHTML=''; 
        rawData.characters.forEach(c=>{ 
            const o=gameState.charaInventory[c.id]; 
            if(o && o.count > 0) { 
                const gain = MAT_EXP[c.rarity] || 25;
                let visual = (c.imageUrl && c.imageUrl.startsWith('http')) ? `<img src="${c.imageUrl}" style="width:40px;height:40px;">` : `<span>ğŸ“¦</span>`;
                l.innerHTML+=`<div class="mat-card" onclick="executeEnhance('${c.id}', ${gain})">
                    <div class="rarity-${c.rarity}">${c.rarity}</div>${visual}
                    <div style="font-weight:bold;">${c.name}</div>
                    <div>æ‰€æŒ:${o.count}</div>
                    <div class="mat-exp-val">+${gain} EXP</div>
                </div>`; 
            } 
        }); 
    }
    
    function closeEnhanceMenu() { document.getElementById('material-select-overlay').classList.add('hidden'); openCharaDetail(viewingCharaId); }
    
    // â˜… FIX: Refresh Detail Immediately after Enhance
    function executeEnhance(mid, gain) { 
        if(!confirm("å¼·åŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const t = gameState.charaInventory[viewingCharaId];
        const m = gameState.charaInventory[mid];
        
        if(t.level >= 10) return alert("ä¸Šé™ã§ã™");
        
        m.count--;
        t.exp = (Number(t.exp) || 0) + Number(gain);
        
        let lvUp = 0;
        while(t.exp >= EXP_REQ) {
            if(t.level >= 10) { t.exp = 0; break; }
            t.exp -= EXP_REQ;
            t.level++;
            lvUp++;
        }
        
        updateMissionProgress('enhance', 1);
        saveGame();
        
        document.getElementById('material-select-overlay').classList.add('hidden');
        
        // â˜… Force update DOM immediately
        const chara = rawData.characters.find(x => x.id === viewingCharaId);
        if(chara) {
            document.getElementById('cd-lv').innerText = 'Lv.' + t.level;
            document.getElementById('cd-exp-text').innerText = t.exp + ' / ' + EXP_REQ;
            document.getElementById('cd-exp-bar').style.width = (t.exp / EXP_REQ * 100) + '%';
            document.getElementById('cd-val').innerText='x'+(chara.value+(t.level*LV_BONUS_RATE)).toFixed(2);
        }
        
        // â˜… Also call openCharaDetail to be sure
        openCharaDetail(viewingCharaId);
        
        // â˜… Delay alert slightly so user sees the change first
        setTimeout(() => {
            if(lvUp > 0) alert(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${t.level}`);
            else alert(`å¼·åŒ–æˆåŠŸï¼ EXP +${gain}\nç¾åœ¨: ${t.exp}/${EXP_REQ}`);
        }, 100);
    }
    
    function openShop() { 
        document.getElementById('shop-overlay').classList.remove('hidden'); 
        // â˜…ä¿®æ­£: ã‚·ãƒ§ãƒƒãƒ—ã‚’é–‹ã„ãŸæ™‚ã«XPã‚’æ›´æ–°
        document.getElementById('shop-xp').innerText = gameState.xp;
        
        const l=document.getElementById('shop-list'); 
        l.innerHTML=''; 
        if(rawData.shopItems) rawData.shopItems.forEach(i=>{ 
            const lv=gameState.itemLevels[i.id]||0; 
            const p=i.price*(lv+1); 
            l.innerHTML+=`<div class="shop-item">
                <div class="shop-icon">${i.icon}</div>
                <div class="shop-info">
                    <div class="shop-name">${i.name}</div>
                    <div class="shop-desc">${i.desc}</div>
                </div>
                <div class="shop-right">
                    <div class="shop-level-tag">Lv.${lv} / ${MAX_ITEM_LEVEL}</div>
                    <button class="shop-buy-btn" onclick="buyItem('${i.id}',${p})">${lv>=10?'MAX':'â¬† '+p+'XP'}</button>
                </div>
            </div>`; 
        }); 
    }
    
    function closeShop() { document.getElementById('shop-overlay').classList.add('hidden'); }
    
    function buyItem(id,p) { 
        if((gameState.itemLevels[id]||0)>=10)return; 
        if(gameState.xp<p)return alert("XPä¸è¶³"); 
        gameState.xp-=p; 
        gameState.itemLevels[id]=(gameState.itemLevels[id]||0)+1; 
        saveGame(); 
        openShop(); // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°
        updateTitleInfo(); 
    }

    function openVersionHistory() { document.getElementById('version-overlay').classList.remove('hidden'); }
    function closeVersionHistory() { document.getElementById('version-overlay').classList.add('hidden'); }
</script>
</body>
</html>
