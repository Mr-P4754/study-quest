<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUDY QUEST | Stationary Master</title>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base & Reset */
        body { font-family: 'BIZ UDPGothic', sans-serif; text-align: center; background-color: #2c3e50; color: #ecf0f1; margin: 0; padding: 0; touch-action: manipulation; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button { cursor: pointer; font-family: inherit; user-select: none; -webkit-tap-highlight-color: transparent; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: #2c3e50; z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes damageFloat { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 15% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; } }
        @keyframes shake { 0% { transform: translate(0, 0) rotate(0deg); } 20% { transform: translate(-10px, 0) rotate(-5deg); } 40% { transform: translate(10px, 0) rotate(5deg); } 60% { transform: translate(-10px, 0) rotate(-5deg); } 80% { transform: translate(10px, 0) rotate(5deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        @keyframes pulseRed { 
            0% { transform: scale(1.0); filter: brightness(100%); } 
            100% { transform: scale(1.05); filter: brightness(150%); text-shadow: 0 0 8px #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.5); } 
        }
        .shake-anim { animation: shake 0.4s ease-in-out; }
        .fade-out { opacity: 0 !important; transform: scale(0.8) !important; transition: all 1.0s ease-out; }
        .anim-paused { animation-play-state: paused !important; }
        .cutin { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 5em; font-weight: 900; color: #f1c40f; -webkit-text-stroke: 3px #c0392b; text-shadow: 4px 4px 0 #000; pointer-events: none; z-index: 2000; animation: damageFloat 1.2s ease-out forwards; white-space: nowrap; }
        
        .header { padding: 5px 10px; background: #34495e; border-bottom: 4px solid #2c3e50; display: flex; justify-content: space-between; align-items: center; height: 55px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; gap: 8px; width: 100%; box-sizing: border-box; }
        .life-container { font-size: 1.2em; color: #e74c3c; letter-spacing: 1px; flex-shrink: 0; }
        .timer-container { flex-grow: 1; background: #444; height: 16px; position: relative; border: 2px solid #fff; border-radius: 8px; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .timer-bar-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.1s linear; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-timer-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; line-height: 16px; font-weight: bold; text-shadow: 1px 1px 0 #000; font-size: 0.8em; color: #fff; letter-spacing: 1px; }
        .stats-container { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .stats-box { font-size: 0.7em; background: rgba(0,0,0,0.3); padding: 4px 6px; border-radius: 4px; border: 1px solid #555; font-weight: bold; white-space: nowrap; color: #ecf0f1; }
        .header-pause-btn { background: #f39c12; color: #fff; border: 2px solid #fff; border-radius: 5px; width: 36px; height: 36px; font-size: 1.0em; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 0 #d35400; flex-shrink: 0; padding: 0; }
        .header-pause-btn:active { transform: translateY(2px); box-shadow: none; }

        .title-screen-bg { background: linear-gradient(135deg, #2c3e50, #1a252f); }
.title-logo { font-size: 1.8em; font-weight: 900; margin-top: 2px; margin-bottom: 2px; color: #f1c40f; text-shadow: 3px 3px 0 #e67e22, 0 0 15px rgba(241, 196, 15, 0.5); line-height: 1.0; letter-spacing: 0.05em; white-space: nowrap; }
        .version-text { color:#bdc3c7; margin-bottom: 5px; cursor: pointer; text-decoration: underline; font-size: 0.8em; transition: color 0.2s; }
        .version-text:hover { color: #fff; }
        
        .menu-btn-container { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; width: 90%; max-width: 400px; margin-left: auto; margin-right: auto; }
        .menu-btn { width: 100%; height: 50px; margin: 0; padding: 5px; background: #e67e22; color: white; border: none; border-radius: 12px; font-weight: bold; border-bottom: 5px solid #d35400; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.1s; position: relative; display: flex; align-items: center; justify-content: center; flex-direction: row; gap: 5px; font-family: 'BIZ UDPGothic', sans-serif; font-size: 0.95em; white-space: nowrap; box-sizing: border-box; }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-btn.multi-line { flex-direction: column; line-height: 1.1; font-size: 0.85em; height: 50px; white-space: normal; }
        .menu-btn.full-width { grid-column: span 2; }
        
        .menu-btn.revenge { background: #2c3e50; border-bottom-color: #1a252f; color: #ecf0f1; border: 2px solid #e74c3c; }
        .menu-btn.revenge:disabled { background: #95a5a6; border-color: #7f8c8d; color: #bdc3c7; border-bottom: none; transform: none; box-shadow: none; }

        .select-box { margin: 2px; padding: 8px; font-size: 0.95em; width: 90%; max-width: 320px; border-radius: 8px; border: 2px solid #95a5a6; background: #ecf0f1; font-family: inherit; font-weight: bold;}
        .badge { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.9em; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white; z-index: 10; }

        .battle-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; background: #222; background-image: radial-gradient(#333 15%, transparent 16%), radial-gradient(#333 15%, transparent 16%); background-size: 20px 20px; background-position: 0 0, 10px 10px; overflow: hidden; padding: 10px 0; min-height: 0; }
        .enemy-visual-box { animation: float 3s ease-in-out infinite; margin-bottom: 5px; flex-grow: 1; display: flex; align-items: center; justify-content: center; max-height: 35vh; min-height: 150px; width: 100%; }
        .enemy-visual { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; font-size: 120px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); }
        .enemy-visual img { width: auto; height: auto; max-width: 90%; max-height: 100%; object-fit: contain; }

        .enemy-stats-row { display: flex; align-items: center; justify-content: center; gap: 10px; width: 90%; max-width: 500px; margin-bottom: 10px; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 12px; border: 1px solid #555; flex-shrink: 0; }
        #ui-enemy-name { font-weight: bold; color: #f1c40f; text-shadow: 1px 1px 0 #000; white-space: nowrap; font-size: 1.1em; max-width: 40%; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.05em;}
        .enemy-hp-frame { flex-grow: 1; height: 20px; background: #111; border: 2px solid #fff; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 2px 0 rgba(0,0,0,0.5); }
        .enemy-hp-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); width: 100%; transition: width 0.3s ease-out; }
        #ui-hp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; text-shadow: 1px 1px 2px #000; color: #fff; z-index: 5; letter-spacing: 1px;}
        .question-box { background: #fff; color: #2c3e50; width: 90%; max-width: 600px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.4em; min-height: 80px; max-height: 180px; overflow-y: auto; display: flex; align-items: center; justify-content: center; border: 4px solid #bdc3c7; box-shadow: 0 6px 0 #7f8c8d; margin-bottom: 15px; text-align: center; line-height: 1.5; flex-shrink: 0; font-family: 'BIZ UDPGothic', sans-serif; }
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 94%; max-width: 600px; padding: 10px; padding-bottom: 20px; margin: 0 auto; flex-shrink: 0; }
        .choice-btn { padding: 15px 5px; background: #3498db; border: none; border-radius: 12px; color: white; font-size: 1.1em; font-weight: bold; border-bottom: 6px solid #2980b9; transition: transform 0.05s, background 0.2s; position: relative; overflow: hidden; min-height: 60px; display: flex; align-items: center; justify-content: center; line-height: 1.3; font-family: 'BIZ UDPGothic', sans-serif;}
        .choice-btn:active { transform: translateY(4px); border-bottom: 6px solid #2980b9; margin-bottom: 0; background: #2980b9; }
        .choice-btn.btn-correct { background: #27ae60 !important; border-bottom: 6px solid #1e8449 !important; transform: translateY(4px); opacity: 1 !important; }
        .choice-btn.btn-wrong { background: #7f8c8d !important; border-bottom: 6px solid #555 !important; opacity: 0.6 !important; }
        .choice-btn.btn-miss-answer { background: #e74c3c !important; border-color: #c0392b !important; color: #fff !important; opacity: 1 !important; animation: pulseRed 0.8s ease-in-out infinite alternate; }

        /* Overlay & Modal */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #fdfefe; color: #333; width: 92%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow: hidden; text-align: center; border: 6px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3); display: flex; flex-direction: column; }
        .modal .menu-btn, .pause-menu-box .menu-btn, #result-overlay .menu-btn { height: auto; padding: 12px; font-size: 1.1em; display: block; width: 100%; flex: none; min-width: auto; }

        .pause-menu-box { background: #2c3e50; padding: 20px; border: 4px solid #ecf0f1; border-radius: 15px; display: flex; flex-direction: column; gap: 10px; width: 300px; text-align: center; }
        #pause-chara-info { background: #34495e; border-radius: 10px; padding: 10px; margin: 5px 0; border: 2px solid #95a5a6; color: #fff; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .pause-note { color: #bdc3c7; font-size: 0.7em; margin-top: 5px; }

        /* Cards & Shop & Mission */
        .char-card { border: 2px solid #ddd; padding: 8px; border-radius: 10px; margin: 4px; display: inline-block; width: 70px; font-size: 0.7em; cursor: pointer; background: #f9f9f9; vertical-align: top; transition: all 0.2s; position: relative; }
        .char-card:hover { transform: translateY(-3px); }
        .char-card.owned { background: #fff; border-color: #bdc3c7; }
        .char-card.active { background: #fffbe6; border: 3px solid #e67e22; transform: scale(1.05); box-shadow: 0 0 10px rgba(230, 126, 34, 0.4); }
        .char-img { width: 50px; height: 50px; object-fit: contain; margin-bottom: 4px; }
        .char-lvl-badge { position: absolute; top: -5px; right: -5px; background: #3498db; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7em; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); z-index: 2; }
        .char-stock-badge { position: absolute; bottom: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7em; font-weight: bold; border: 1px solid white; z-index: 2; }
        
        .shop-item { display: flex; align-items: center; justify-content: space-between; background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 10px; border: 2px solid #bdc3c7; text-align: left; transition: transform 0.1s; width: 100%; box-sizing: border-box; gap: 10px; }
        .shop-item:active { transform: scale(0.98); }
        .shop-icon { width: 50px; height: 50px; font-size: 2.2em; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .shop-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .shop-name { font-weight: bold; font-size: 1.1em; color: #2c3e50; line-height: 1.3; }
        .shop-desc { font-size: 0.85em; color: #7f8c8d; margin-top: 3px; line-height: 1.3; }
        .shop-right { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 80px; flex-shrink: 0; gap: 5px; }
        .shop-level-tag { font-size: 0.85em; font-weight: bold; color: #2980b9; background: #ecf0f1; padding: 2px 8px; border-radius: 10px; white-space: nowrap; }
        .shop-buy-btn { background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #1e8449; width: 100%; font-size: 0.9em; min-width: 70px; }
        .shop-buy-btn:active { transform: translateY(4px); border-bottom: none; }
        .shop-buy-btn:disabled { background: #95a5a6; border-bottom: none; cursor: default; transform: none; }

        .mat-card { border: 2px solid #ccc; position: relative; transition: all 0.1s; }
        .mat-card.selected { border-color: #e67e22; background: #fffbe6; transform: scale(0.95); }
        .mat-select-badge { position: absolute; top: -5px; right: -5px; background: #e67e22; color: white; width: 24px; height: 24px; border-radius: 50%; font-weight: bold; font-size: 0.9em; display: flex; justify-content: center; align-items: center; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); z-index: 5; }

        .enhance-footer { border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .enhance-info { display: flex; justify-content: space-between; font-weight: bold; color: #2c3e50; font-size: 0.9em; }
        .enhance-preview { color: #27ae60; }

        .title-item { background: #fdfefe; border: 2px solid #bdc3c7; border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: left; opacity: 0.7; transition: all 0.2s; position: relative; }
        .title-item.unlocked { border-color: #f1c40f; opacity: 1; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.2); background: #fffbe6; }
        .title-item.claimed { border-color: #27ae60; background: #eafaf1; opacity: 0.8; }
        .title-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .title-name { font-weight: bold; font-size: 1.1em; color: #2c3e50; }
        .title-req { font-size: 0.8em; color: #7f8c8d; }
        .title-reward-btn { padding: 6px 12px; font-size: 0.8em; border-radius: 15px; border: none; cursor: pointer; font-weight: bold; background: #95a5a6; color: white; border-bottom: 3px solid #7f8c8d; }
        .title-item.unlocked .title-reward-btn { background: #f1c40f; border-bottom-color: #d35400; animation: pulseRed 1s infinite alternate; }
        .title-item.claimed .title-reward-btn { background: #27ae60; border: none; cursor: default; transform: none; animation: none; }

        .rarity-SSR { color: #f1c40f; text-shadow: 0 0 1px #000; font-weight: 900; } .rarity-SR { color: #e74c3c; font-weight: bold; } .rarity-R { color: #3498db; font-weight: bold; } .rarity-N { color: #7f8c8d; }
        
        .rarity-UR { color: #e056fd; font-weight: 900; text-shadow: 0 0 5px #fff, 0 0 10px #e056fd; animation: pulseRed 1s infinite alternate; }
        .char-card.mastered { border: 3px solid transparent; background-image: linear-gradient(#fff, #fff), linear-gradient(45deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); background-origin: border-box; background-clip: content-box, border-box; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); transform: scale(1.02); }
        .char-card.mastered .char-stock-badge { background: linear-gradient(45deg, #f1c40f, #e67e22); border: 1px solid #fff; box-shadow: 0 0 5px #f1c40f; }
        
        .gacha-result-card { background: #fff; padding: 20px; border-radius: 15px; border: 4px solid #ccc; text-align: center; margin-bottom: 20px; position: relative; }
        .gr-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 400px; overflow-y: auto; padding: 5px; }
        .gr-mini-card { background: #fff; border: 2px solid #ccc; border-radius: 8px; padding: 5px; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center; }
        .gr-mini-img { width: 60px; height: 60px; object-fit: contain; margin: 5px 0; }
        .detail-img { width: 100px; height: 100px; object-fit: contain; margin: 10px auto; background: #eee; border-radius: 10px; padding: 10px; border: 2px solid #ccc; }
        .detail-stat-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #ccc; }
        .detail-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .detail-btn { 
            width: 100%;
            height: 50px;
            margin: 0;
            padding: 5px;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            transition: all 0.1s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'BIZ UDPGothic', sans-serif;
            font-size: 0.95em;
            box-sizing: border-box;
            cursor: pointer;
            /* åšã¿ã®ã‚³ã‚¢ï¼šrgbaã§ã¯ãªãä¸é€æ˜ãªæ¿ƒã„è‰²ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚HTMLå´ã§è‰²ã‚’æŒ‡å®š */
            border-bottom: 5px solid #000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* æŠ¼ã—è¾¼ã‚“ã æ™‚ã®å‹•ãã‚’menu-btnã¨å®Œå…¨ã«åŒæœŸ */
        .detail-btn:active {
            transform: translateY(4px);
            box-shadow: none;
            border-bottom: none;
        }
        .exp-bar-container { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin: 5px 0; overflow: hidden; }
        .exp-bar-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        /* ä¿®æ­£: overflow-y: scroll ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼é ˜åŸŸã‚’å›ºå®šã—ã€ã‚¬ã‚¿ã¤ã(flicker)ã‚’é˜²æ­¢ */
        .material-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; max-height: 250px; overflow-y: scroll; margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px; }
        .mat-card { border: 1px solid #ccc; border-radius: 5px; padding: 5px; text-align: center; cursor: pointer; background: #fff; font-size: 0.7em; }
        .mat-card:hover { background: #eef; }
        .mat-exp-val { color: #e67e22; font-weight: bold; }
        .mission-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .mission-item { background: #fff; padding: 10px; border-radius: 10px; border: 2px solid #bdc3c7; text-align: left; }
        .mission-title { font-weight: bold; color: #2c3e50; display: flex; justify-content: space-between; }
        .mission-reward { color: #e67e22; font-size: 0.9em; font-weight: bold; }
        .mission-progress-bg { background: #eee; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .mission-progress-fill { background: #3498db; height: 100%; width: 0%; transition: width 0.3s; }
        .mission-btn { margin-top: 5px; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .mission-btn.active { background: #e67e22; border-bottom: 3px solid #d35400; }
        .mission-btn.disabled { background: #bdc3c7; color: #7f8c8d; cursor: default; }
        .mission-complete { background: #d4edda; border-color: #c3e6cb; }
        .version-list { text-align: left; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 0.9em; line-height: 1.6; }
        .version-list h4 { color: #e67e22; margin: 10px 0 5px 0; border-bottom: 1px solid #ddd; }
        .version-list ul { margin: 0; padding-left: 20px; }
        #loading-screen { z-index: 200; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top: 5px solid #f1c40f; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        #error-message { color: #e74c3c; margin-top: 20px; font-weight: bold; max-width: 80%; background: white; padding: 10px; border-radius: 5px; display: none; }

        .record-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .chart-box { position: relative; width: 280px; height: 280px; margin: 10px auto; background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; }
        .grade-table { width: 95%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; background: #fff; }
        .grade-table th, .grade-table td { border: 1px solid #ddd; padding: 8px; text-align: center; color: #2c3e50; }
        .grade-table th { background: #f2f2f2; font-weight: bold; }
        .rank-S { color: #e056fd; font-weight: 900; text-shadow: 0 0 5px rgba(224, 86, 253, 0.3); }
        .rank-A { color: #e74c3c; font-weight: bold; }
        .rank-B { color: #e67e22; font-weight: bold; }
        .rank-C { color: #f1c40f; font-weight: bold; }
        .rank-D { color: #2ecc71; font-weight: bold; }
        .rank-E { color: #3498db; }
        .rank-F, .rank-G { color: #95a5a6; }
        
        .campaign-banner { background: linear-gradient(90deg, #c0392b, #e74c3c); color: #fff; width: 100%; padding: 5px 0; font-weight: bold; font-size: 0.9em; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); margin-bottom: 5px; display: none; }
        .campaign-text { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        .menu-btn.oath { background: #8e44ad; border-bottom-color: #6c3483; border: 2px solid #a569bd; }
        .oath-options { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .oath-option { background: #fdfefe; border: 2px solid #bdc3c7; padding: 15px; border-radius: 10px; text-align: left; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .oath-option.selected { border-color: #8e44ad; background: #f4ecf7; box-shadow: 0 0 10px rgba(142, 68, 173, 0.3); }
        .oath-icon { font-size: 1.5em; width: 40px; text-align: center; }
        .oath-desc { font-size: 0.85em; color: #7f8c8d; }
        .oath-name { font-weight: bold; color: #2c3e50; }

        .typing-area { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 90%; max-width: 600px; margin: 10px auto; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; min-height: 120px; }
        .typing-japanese { font-size: 2.0em; font-weight: 900; color: #fff; text-shadow: 2px 2px 0 #2c3e50; margin-bottom: 5px; }
        .typing-romaji { font-size: 1.5em; font-family: 'Courier New', monospace; letter-spacing: 2px; color: #7f8c8d; font-weight: bold; background: #fff; padding: 5px 20px; border-radius: 5px; border-bottom: 4px solid #bdc3c7; }
        .typing-char-done { color: #2ecc71; }
        .typing-char-current { color: #e67e22; text-decoration: underline; }
        .typing-char-rest { color: #95a5a6; }

        .gift-list { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; text-align: left; }
        .gift-item { background: #fff; border: 2px solid #e67e22; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gift-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 5px; }
        .gift-title { font-weight: bold; color: #d35400; }
        .gift-exp { background: #f1c40f; color: #fff; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 0.9em; text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }
        /* ...æ—¢å­˜ã®CSS... */
        .gift-msg { font-size: 0.85em; color: #555; }

        /* â–¼â–¼â–¼ è¿½åŠ : é€²åŒ–ãƒ»è»¢ç”Ÿã‚·ã‚¹ãƒ†ãƒ ç”¨CSS â–¼â–¼â–¼ */
        .name-deco-evo { color: #f1c40f; text-shadow: 0 0 3px #d35400; animation: pulseRed 2s infinite; }
        .name-deco-reborn { color: #00d2ff; text-shadow: 0 0 3px #0055ff; font-weight: bold; }
        
        .skill-tag-container { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; justify-content: flex-start; }
        .skill-tag { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #fff; background: #34495e; border: 1px solid rgba(255,255,255,0.3); }
        .skill-tag.ATK { background: #e74c3c; } .skill-tag.TIME { background: #f39c12; } .skill-tag.EXP { background: #2ecc71; }
        .skill-tag.ALL { background: linear-gradient(45deg, #8e44ad, #f1c40f); border: 1px solid #fff; box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }

        .evo-btn-container { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #bdc3c7; }
        .evo-btn { padding: 10px; border-radius: 8px; font-weight: bold; color: white; border: none; cursor: pointer; text-shadow: 1px 1px 0 rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .evo-btn:active { transform: scale(0.98); }
        .btn-evolution { background: linear-gradient(to bottom, #f1c40f, #e67e22); border-bottom: 3px solid #d35400; color: #2c3e50; }
        .btn-reincarnation { background: linear-gradient(to right, #3498db, #8e44ad); border-bottom: 3px solid #5b2c6f; }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

        /* â–¼â–¼â–¼ è¿½åŠ : ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›ãƒ»ä½¿ç”¨ã‚·ã‚¹ãƒ†ãƒ ç”¨CSS â–¼â–¼â–¼ */
        .page-counter-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 8px; }
        .page-item { font-weight: bold; font-size: 0.9em; color: #2c3e50; }
        .item-tab-container { display: flex; border-bottom: 2px solid #bdc3c7; margin-bottom: 10px; }
        .item-tab { flex: 1; padding: 8px; cursor: pointer; background: #eee; color: #7f8c8d; font-size: 0.8em; font-weight: bold; }
        .item-tab.active { background: #27ae60; color: white; }
        .item-use-area { margin-top: 10px; padding: 8px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd; }
        .book-use-btn { background: #3498db; color: white; border: none; padding: 4px; border-radius: 4px; font-size: 0.75em; border-bottom: 3px solid #2980b9; cursor: pointer; }
        .book-use-btn:disabled { background: #ccc; border: none; cursor: default; }
        /* â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² */

    </style>
</head>
<body>

<div id="loading-screen" class="screen">
    <div style="margin: auto; width: 100%; max-width: 400px;">
        <div class="spinner"></div>
        <h2 style="margin:0;">CONNECTING...</h2>
        <div id="error-message"></div>
    </div>
</div>

<div id="title-screen" class="screen title-screen-bg hidden">
    <div id="campaign-banner" class="campaign-banner">
        <div id="campaign-text" class="campaign-text"></div>
    </div>
    <div class="title-logo">STUDY QUEST</div>
    <div class="version-text" onclick="openVersionHistory()">Ver 7.1.1</div>
    
    <div class="menu-btn-container">
        <button class="menu-btn" onclick="openUnitSelection()">
            â–¶ ã‚¯ã‚¨ã‚¹ãƒˆ
        </button>

        <button id="btn-revenge" class="menu-btn revenge" onclick="startRevengeMode()" disabled>
            ğŸ’€ ãƒªãƒ™ãƒ³ã‚¸ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³
            <div id="revenge-badge" class="badge hidden">0</div>
        </button>
        
        <button class="menu-btn" style="background:#8e44ad; border-color:#6c3483;" onclick="openTypingMenu()">
            âŒ¨ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°
        </button>

        <button class="menu-btn" style="background:#7f8c8d; border-color:#636e72;" onclick="openRandomMenu()">
            ğŸ² ãƒ©ãƒ³ãƒ€ãƒ 
        </button>

        <button class="menu-btn" style="background:#e74c3c; border-color:#c0392b;" onclick="openMissions()">
            ğŸ“ MISSION
            <div id="mission-badge" class="badge hidden">!</div>
        </button>
        
        <button class="menu-btn multi-line" style="background:#e84393; border-color:#d63031;" onclick="openGacha()">
            <span>ğŸ’ ã‚¬ãƒãƒ£</span>
            <span>ğŸ“– å›³é‘‘</span>
        </button>
        
        <button class="menu-btn" style="background:#f39c12; border-color:#d35400;" onclick="openTitles()">
            ğŸ† ç§°å·
            <div id="title-badge" class="badge hidden">!</div>
        </button>

        <button class="menu-btn" style="background:#27ae60; border-color:#1e8449;" onclick="openShop()">
            ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—
        </button>

        <button class="menu-btn" style="background:#16a085; border-color:#1abc9c;" onclick="openRecord()">
            ğŸ“Š æˆç¸¾è¡¨
        </button>

        <button class="menu-btn" style="background:#3498db; border-color:#2980b9;" onclick="openSyncMenu()">
            â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‚»ãƒ¼ãƒ–
        </button>

        <button class="menu-btn" style="background:#1abc9c; border-color:#16a085;" onclick="openHowToPlay()">
            ğŸ“– ãƒ—ãƒ¬ã‚¤ã‚¬ã‚¤ãƒ‰
        </button>

        <button id="btn-gift" class="menu-btn" style="background:#ff6b81; border-color:#d63031;" onclick="openGiftMenu()" disabled>
            ğŸ ã‚®ãƒ•ãƒˆ
            <div id="gift-badge" class="badge hidden">0</div>
        </button>
    </div>
    
    <div style="margin-top: 15px; padding-bottom: 20px; width: 100%; color: #95a5a6; font-size: 0.9em; display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div id="title-chara-img" style="width: 40px; height: 40px; background: #333; border-radius: 5px; overflow: hidden;"></div>
        <div>è£…å‚™: <span id="title-equipped-name" style="color:#fff; font-weight:bold;">ãªã—</span><br>æ‰€æŒXP: <span id="title-xp" style="color:#f1c40f;">0</span></div>
    </div>
</div>

<div id="unit-select-overlay" class="overlay hidden" style="z-index: 250;">
    <div class="modal" style="max-width:400px;">
        <h2 id="unit-select-title" style="color:#2c3e50; margin-top:0;">ã‚¯ã‚¨ã‚¹ãƒˆå‡ºç™º</h2>
        <p style="font-size:0.9em; color:#7f8c8d;">æŒ‘æˆ¦ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„</p>
        
        <div style="background: #ecf0f1; padding: 15px; border-radius: 10px; margin: 15px 0; border: 2px solid #bdc3c7;">
            <select id="grade-select" class="select-box" style="width:100%; margin-bottom:10px; font-size:1.1em;" onchange="filterSubjects()">
                <option value="">å­¦å¹´ã‚’é¸æŠ</option>
            </select>
            <select id="subject-select" class="select-box" style="width:100%; margin-bottom:10px; font-size:1.1em;" onchange="filterUnits()">
                <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
            </select>
            <select id="unit-select" class="select-box" style="width:100%; font-size:1.1em;">
                <option value="">å˜å…ƒã‚’é¸æŠ</option>
            </select>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="menu-btn" style="background:#e67e22;" onclick="startNormalGameCheck()">
                é€šå¸¸å‡ºæ’ƒ
            </button>
            <button class="menu-btn oath" style="background:#8e44ad; border-color:#6c3483;" onclick="goToOathMenuCheck()">
                ğŸ˜ˆ èª“ç´„ã¸
            </button>
        </div>

        <button class="menu-btn" style="margin-top:15px; background:#95a5a6;" onclick="closeUnitSelection()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
    </div>
</div>
<div id="sync-overlay" class="overlay hidden" style="z-index: 400;">
    <div class="modal" style="max-width: 400px;">
        <h2 style="color:#3498db; margin-top:0;">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‚»ãƒ¼ãƒ–</h2>
        <p style="text-align:left; font-size:0.9em;">ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã†ã¨ã€ã‚¹ãƒãƒ›ã‚„åˆ¥ã®PCã«ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã’ã¾ã™ã€‚</p>
        
        <div style="background:#eee; padding:10px; border-radius:8px; margin:10px 0;">
            <div style="font-weight:bold; color:#2c3e50;">ã‚ãªãŸã®ID</div>
            <div id="my-user-id" style="font-size:2em; font-weight:900; letter-spacing:2px; color:#3498db;">--------</div>
            <button class="menu-btn" style="height:40px; font-size:0.9em; margin-top:5px; background:#2980b9;" onclick="uploadData()">â˜ï¸ ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>
        </div>

        <hr style="margin:20px 0; border:1px dashed #ccc;">

        <div style="text-align:left; font-size:0.9em; font-weight:bold; color:#e67e22;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ (ä¸Šæ›¸ãæ³¨æ„)</div>
        <input type="text" id="input-sync-id" placeholder="IDã‚’å…¥åŠ› (ä¾‹: a1b2c3d4)" style="width:90%; padding:10px; font-size:1.2em; border:2px solid #ccc; border-radius:5px; text-align:center; margin-top:5px;">
        <button class="menu-btn" style="margin-top:10px; background:#e67e22;" onclick="downloadData()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

        <button class="menu-btn" style="margin-top:20px; background:#95a5a6;" onclick="closeSyncMenu()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="game-screen" class="screen hidden">
    <div class="header">
        <div class="life-container" id="ui-life">â¤ï¸â¤ï¸â¤ï¸</div>
        <div class="timer-container"><div id="ui-timer" class="timer-bar-fill"></div><div id="ui-timer-text">10.0</div></div>
        <div class="stats-container"><div class="stats-box">SCORE <span id="ui-score">0</span></div><div class="stats-box">COMBO <span id="ui-combo" style="color:#f1c40f;">0</span></div></div>
        <button class="header-pause-btn" onclick="togglePause()">â¸</button>
    </div>
    <div class="battle-area">
        <div class="enemy-visual-box"><div class="enemy-visual" id="ui-enemy-icon">ğŸ‘¾</div></div>
        <div class="enemy-stats-row"><div id="ui-enemy-name">BOSS</div><div class="enemy-hp-frame"><div id="ui-hp" class="enemy-hp-fill"></div><div id="ui-hp-text">1000 / 1000</div></div></div>
        <div id="ui-question" class="question-box">READY?</div>
        
        <div id="ui-typing-area" class="typing-area hidden">
            <div id="ui-typing-jp" class="typing-japanese">æ—¥æœ¬èª</div>
            <div id="ui-typing-romaji" class="typing-romaji">ROMAJI</div>
        </div>

    </div>
    <div class="choices-grid" id="ui-choices"></div>
    <div id="pause-overlay" class="overlay hidden">
        <div class="pause-menu-box">
            <h2 style="color:#f1c40f; margin:0;">PAUSE</h2>
            <div id="pause-chara-info">è£…å‚™æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            
            <button id="btn-mute" class="menu-btn" style="background:#95a5a6; border-color:#7f8c8d;" onclick="toggleMute()">ğŸ”‡ éŸ³é‡: OFF</button>
            
            <button class="menu-btn" style="background:#27ae60;" onclick="resumeGame()">ã¤ã¥ãã‹ã‚‰</button>
            <button class="menu-btn" style="background:#e67e22;" onclick="retryGame()">æœ€åˆã‹ã‚‰</button>
            <button class="menu-btn" style="background:#c0392b;" onclick="backToTitleFromPause()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
            <p class="pause-note">â€»ã€Œæœ€åˆã‹ã‚‰ã€ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸ã€ã‚’é¸ã¶ã¨<br>ã“ã®ãƒ—ãƒ¬ã‚¤ã§ç¨¼ã„ã çµŒé¨“å€¤ã¯<span style="color:#e74c3c">æ¶ˆæ»…</span>ã—ã¾ã™ã€‚</p>
        </div>
    </div>
</div>

<div id="result-overlay" class="overlay hidden"><div class="modal"><h2 id="res-title">QUEST CLEAR!</h2><div id="res-icon" style="font-size: 4em;"></div><p>ç²å¾—ã‚¹ã‚³ã‚¢: <span id="res-score">0</span></p><div style="background:#eee; padding:15px; border-radius:10px; margin:10px 0;">ç²å¾—XP<br><span id="res-xp" style="color:#f1c40f; font-weight:900; font-size:2.5em;">+0</span></div><button class="menu-btn" onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button></div></div>
<div id="login-bonus-overlay" class="overlay hidden" style="z-index: 300;"><div class="modal"><h2 style="color:#f1c40f; margin-top:0;">LOGIN BONUS</h2><div style="font-size:4em;">ğŸ</div><p style="margin:20px 0;">ä»Šæ—¥ã‚‚å­¦ç¿’ãŠç–²ã‚Œæ§˜ã§ã™ï¼<br>ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</p><div style="background:#fef5e7; padding:20px; border-radius:10px; border:2px solid #e67e22; margin-bottom:20px;"><div style="font-size:1.2em; font-weight:bold; color:#e67e22;">+3000 EXP</div></div><button class="menu-btn" style="width:100%;" onclick="closeLoginBonus()">å—ã‘å–ã‚‹</button></div></div>
<div id="mission-overlay" class="overlay hidden" style="z-index: 250;"><div class="modal" style="max-width:500px;"><h2 style="color:#e74c3c; margin-top:0;">ğŸ“ DAILY MISSION</h2><div id="mission-list" class="mission-list" style="flex: 1; max-height: none; overflow-y: auto; min-height: 0;"></div><button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeMissions()">é–‰ã˜ã‚‹</button></div></div>
<div id="gacha-overlay" class="overlay hidden">
    <div class="modal" style="max-width:500px;">
        <h2 style="color:#8e44ad; margin-top:0;">æ–‡æˆ¿å…·å›³é‘‘ & ã‚¬ãƒãƒ£</h2>
        
        <div style="background:#f0f0f0; padding:10px; border-radius:10px; margin-bottom:15px; border: 2px solid #ccc;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:bold; color:#2c3e50;">æ‰€æŒXP: <span id="gacha-xp" style="color:#f39c12;">0</span></span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                
                <button onclick="rollGacha(1)" style="background:linear-gradient(to bottom, #3498db, #2980b9); border:none; padding:10px 5px; border-radius:15px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 3px 0 #1f618d; width:100%; font-size:0.95em; height:60px; line-height:1.2;">
                    ğŸ’ 3,000 XP<br>
                    <span style="font-size:0.8em; opacity:0.9;">é€šå¸¸ 1å›</span>
                </button>

                <button onclick="rollGacha(10)" style="background:linear-gradient(to bottom, #f1c40f, #f39c12); border:none; padding:10px 5px; border-radius:15px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 3px 0 #d35400; width:100%; font-size:0.95em; border: 2px solid white; height:60px; line-height:1.2;">
                    ğŸ’ 30,000 XP<br>
                    <span style="font-size:0.8em; opacity:0.9;">é€šå¸¸ 10é€£</span>
                </button>

                <button onclick="rollGuaranteedTenGacha('SSR', 100000)" style="background:linear-gradient(to bottom, #e67e22, #d35400); border:none; padding:10px 5px; border-radius:15px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 3px 0 #a04000; width:100%; font-size:0.95em; border: 2px solid #f1c40f; height:60px; line-height:1.2;">
                    ğŸ‘‘ 100,000 XP<br>
                    <span style="font-size:0.8em; opacity:0.9;">SSRç¢ºå®š 10é€£</span>
                </button>

                <button onclick="rollGuaranteedTenGacha('UR', 150000)" style="background:linear-gradient(to right, #8e44ad, #3498db); border:none; padding:10px 5px; border-radius:15px; font-weight:900; color:#fff; cursor:pointer; box-shadow: 0 3px 0 #5b2c6f; width:100%; font-size:0.95em; border: 2px solid #e056fd; text-shadow: 0 0 3px #e056fd; height:60px; line-height:1.2;">
                    ğŸŒˆ 150,000 XP<br>
                    <span style="font-size:0.8em; opacity:0.9;">URç¢ºå®š 10é€£</span>
                </button>

            </div>
        </div>
        <div style="text-align: right; margin-bottom: 5px;">
            <select id="zukan-sort-select" class="select-box" style="width: auto; padding: 5px; font-size: 0.9em;" onchange="changeZukanSort()">
                <option value="default">æ¨™æº– (IDé †)</option>
                <option value="rarity_desc">ãƒ¬ã‚¢åº¦ (é«˜ã„é †)</option>
                <option value="rarity_asc">ãƒ¬ã‚¢åº¦ (ä½ã„é †)</option>
                <option value="type">ã‚¹ã‚­ãƒ«å±æ€§é †</option>
                <option value="level">ãƒ¬ãƒ™ãƒ«é †</option>
                <option value="stock">åœ¨åº«æ•°é †</option>
            </select>
        </div>
        <div id="zukan-grid" style="flex: 1; overflow-y: auto; text-align: left; min-height: 0;"></div>
        <button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeGacha()">é–‰ã˜ã‚‹</button>
    </div>
</div>
<div id="chara-detail-overlay" class="overlay hidden" style="z-index: 150;">
    <div class="modal" style="max-width:350px;">
        <div style="flex: 1; overflow-y: auto; width: 100%; padding: 5px;">
            <h3 id="cd-name" style="margin:0; font-size:1.5em; color:#2c3e50;">ã‚­ãƒ£ãƒ©å</h3>
            <div class="rarity-SSR" id="cd-rarity" style="margin-bottom:10px;">SSR</div>
            <img id="cd-img" src="" class="detail-img">
            
            <div style="background:#f9f9f9; padding:10px; border-radius:8px; text-align:left; font-size:0.9em;">
                <div class="detail-stat-row"><span>ãƒ¬ãƒ™ãƒ«</span><span id="cd-lv" style="font-weight:bold; color:#2980b9;">Lv.0 / 20</span></div>
                <div class="detail-stat-row" style="align-items:center;"><span>EXP</span><div style="flex:1; margin-left:10px;"><div class="exp-bar-container"><div id="cd-exp-bar" class="exp-bar-fill"></div></div><div id="cd-exp-text" style="font-size:0.7em; text-align:right;">0 / 100</div></div></div>
                <div class="detail-stat-row"><span>ã‚¹ã‚­ãƒ«</span><span id="cd-type">ATK</span></div>
                <div class="detail-stat-row"><span>åŠ¹æœ</span><span id="cd-val" style="font-weight:bold; color:#e74c3c;">x1.5</span></div>
                <div class="detail-stat-row"><span>åœ¨åº«æ•°</span><span id="cd-stock" style="font-weight:bold;">0å€‹</span></div>
            </div>
            
            <p id="cd-desc" style="font-size:0.8em; color:#7f8c8d; margin:10px 0; min-height:3em;">èª¬æ˜æ–‡</p>
            
            <div class="detail-btn-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                <button class="detail-btn" style="background:#2ecc71; border-bottom: 5px solid #27ae60; grid-column: span 2;" onclick="equipCurrentChara()">
                    ğŸ›¡ï¸ ã“ã®ã‚­ãƒ£ãƒ©ã‚’è£…å‚™
                </button>
                <button id="btn-enhance" class="detail-btn" style="background:#e67e22; border-bottom: 5px solid #d35400;" onclick="openEnhanceMenu()">
                    ğŸ”¥ å¼·åŒ–åˆæˆ
                </button>
                <button id="btn-sell" class="detail-btn" style="background:#95a5a6; border-bottom: 5px solid #7f8c8d;" onclick="sellCharaStock()">
                    ğŸ’° ç´ æå£²å´
                </button>
            </div>

            <div id="evo-container" class="evo-btn-container hidden" style="margin-top: 10px;"></div>
            
            <button class="menu-btn" style="margin-top:20px; background:#bdc3c7; border-bottom:5px solid #95a5a6; color:#2c3e50; font-size: 0.9em; height: 45px; width: 100%;" onclick="closeCharaDetail()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>
<div id="material-select-overlay" class="overlay hidden" style="z-index: 160;">
    <div class="modal" style="max-width:350px;">
        <h3 style="margin:0; color:#e67e22;">å¼·åŒ–ç´ æã‚’é¸æŠ</h3>
        <div id="material-list" class="material-list" style="flex: 1; overflow-y: auto; min-height: 0; padding: 5px; margin: 10px 0;"></div>
        <div class="enhance-footer">
            <div class="enhance-info">
                <span>ç²å¾—EXP: <span id="enhance-total-exp">0</span></span>
                <span id="enhance-lv-preview" class="enhance-preview">Lv.ãã®ã¾ã¾</span>
            </div>
            <button class="menu-btn" style="background:#e67e22; margin:0;" onclick="executeBulkEnhance()">å¼·åŒ–ã™ã‚‹</button>
            <button class="menu-btn" style="background:#bdc3c7; border-color:#95a5a6; font-size:0.9em; padding:8px; margin-top:5px;" onclick="closeEnhanceMenu()">æˆ»ã‚‹</button>
        </div>
    </div>
</div>
<div id="gacha-result-overlay" class="overlay hidden"><div class="modal" style="max-width:400px;"><div id="gr-container"></div><button class="menu-btn" style="margin-top:20px;" onclick="closeGachaResult()">OK</button></div></div>
<div id="shop-overlay" class="overlay hidden"><div class="modal"><h2 style="color:#27ae60;">ğŸ›’ å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ </h2><div style="text-align:right;">æ‰€æŒXP: <span id="shop-xp">0</span></div><div id="shop-list" style="flex: 1; overflow-y: auto; min-height: 0;"></div><button class="menu-btn" style="margin-top:20px;" onclick="closeShop()">é–‰ã˜ã‚‹</button></div></div>

<div id="gift-overlay" class="overlay hidden" style="z-index: 350;">
    <div class="modal" style="max-width:400px;">
        <h2 style="color:#e67e22; margin-top:0;">ğŸ ã‚®ãƒ•ãƒˆãƒœãƒƒã‚¯ã‚¹</h2>
        <p style="font-size:0.9em;">é‹å–¶ã‹ã‚‰ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆãŒå±Šã„ã¦ã„ã¾ã™ï¼</p>
        <div id="gift-list" class="gift-list"></div>
        <button class="menu-btn" style="margin-top:20px; background:#27ae60;" onclick="receiveAllGifts()">ã¾ã¨ã‚ã¦å—ã‘å–ã‚‹</button>
        <button class="menu-btn" style="margin-top:10px; background:#95a5a6;" onclick="closeGiftMenu()">é–‰ã˜ã‚‹</button>
    </div>
</div>
<div id="titles-overlay" class="overlay hidden" style="z-index: 260;">
    <div class="modal" style="max-width:500px;">
        <h2 style="color:#f39c12; margin-top:0;">ğŸ† ç§°å·ãƒªã‚¹ãƒˆ</h2>
        <div id="titles-list" style="flex: 1; overflow-y: auto; min-height: 0;"></div>
        <button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeTitles()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="record-overlay" class="overlay hidden" style="z-index: 280;">
    <div class="modal" style="max-width:400px;">
        <h2 style="color:#8e44ad; margin-top:0;">ğŸ“Š å­¦åŠ›ãƒ¬ãƒãƒ¼ãƒˆ</h2>
        <div style="flex: 1; overflow-y: auto; width: 100%; padding: 5px;">
            <div class="record-container">
                <div class="chart-box">
                    <canvas id="radar-chart" width="260" height="260"></canvas>
                </div>
                <table class="grade-table">
                    <thead>
                        <tr><th>æ•™ç§‘</th><th>æ­£ç­”ç‡</th><th>ãƒ©ãƒ³ã‚¯</th></tr>
                    </thead>
                    <tbody id="grade-tbody"></tbody>
                </table>
            </div>
        </div>
        <button class="menu-btn" style="margin-top:10px; background:#95a5a6;" onclick="closeRecord()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="oath-overlay" class="overlay hidden" style="z-index: 290;">
    <div class="modal" style="max-width:400px;">
        <h2 style="color:#8e44ad; margin-top:0;">ğŸ˜ˆ èª“ç´„ã®å„€</h2>
        <p style="font-size:0.9em;">è‡ªã‚‰ã«ãƒãƒ³ãƒ‡ã‚’èª²ã—ã€é«˜ã¿ã‚’ç›®æŒ‡ã›ã€‚<br>ï¼ˆå ±é…¬EXP <span style="color:#e67e22; font-weight:bold;">1.5ã€œ2.0å€</span>ï¼‰</p>
    
        <div class="oath-options">
            <div class="oath-option" id="oath-rapid" onclick="toggleOath('rapid')">
                <div class="oath-icon">â±ï¸</div>
                <div>
                    <div class="oath-name">è¿…é€Ÿã®èª“ç´„</div>
                    <div class="oath-desc">åˆ¶é™æ™‚é–“ãŒåŠåˆ†ã«ãªã‚‹</div>
                </div>
            </div>
            <div class="oath-option" id="oath-backwater" onclick="toggleOath('backwater')">
                <div class="oath-icon">ğŸ’”</div>
                <div>
                    <div class="oath-name">èƒŒæ°´ã®èª“ç´„</div>
                    <div class="oath-desc">ãƒ©ã‚¤ãƒ•ãŒã€Œ1ã€ã«ãªã‚‹</div>
                </div>
            </div>
            <div class="oath-option" id="oath-weak" onclick="toggleOath('weak')">
                <div class="oath-icon">âš”ï¸</div>
                <div>
                    <div class="oath-name">éåŠ›ã®èª“ç´„</div>
                    <div class="oath-desc">æ”»æ’ƒåŠ›ãŒåŠåˆ†ã«ãªã‚‹</div>
                </div>
            </div>
        </div>

        <button class="menu-btn" style="background:#8e44ad;" onclick="startOathGame()">ã“ã®æ¡ä»¶ã§å‡ºæ’ƒ</button>
        <button class="menu-btn" style="margin-top:10px; background:#95a5a6;" onclick="closeOathMenu()">ã‚„ã‚ã‚‹</button>
    </div>
</div>

<div id="random-overlay" class="overlay hidden" style="z-index: 290;">
    <div class="modal" style="max-width:350px;">
        <h2 style="color:#34495e; margin-top:0;">ğŸ² æœªçŸ¥ã®è¿·å®®</h2>
        <p style="font-size:0.9em; text-align:left;">
            å­¦å¹´ã®ã¿ã‚’æŒ‡å®šã—ã€å…¨ç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã‚‹å•é¡Œã«æŒ‘æˆ¦ã—ã¾ã™ã€‚<br>
            <br>
            ğŸ”¥ <b>å ±é…¬EXP 1.5å€</b>
        </p>
        
        <div style="margin: 20px 0;">
            <label style="font-weight:bold; color:#2c3e50;">æŒ‘æˆ¦ã™ã‚‹å­¦å¹´</label>
            <select id="random-grade-select" class="select-box" style="width:100%; margin-top:5px; font-size:1.1em; padding:10px;">
                <option value="">å­¦å¹´ã‚’é¸æŠ...</option>
            </select>
        </div>

        <button class="menu-btn" style="background:#34495e;" onclick="startRandomGame()">æ¢ç´¢é–‹å§‹</button>
        <button class="menu-btn" style="margin-top:10px; background:#95a5a6;" onclick="closeRandomMenu()">ã‚„ã‚ã‚‹</button>
    </div>
</div>

<div id="typing-menu-overlay" class="overlay hidden" style="z-index: 290;">
    <div class="modal" style="max-width:400px;">
        <h2 style="color:#8e44ad; margin-top:0;">âŒ¨ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¯ã‚¨ã‚¹ãƒˆ</h2>
        
        <div style="background:#fdedec; border:2px solid #e74c3c; padding:10px; border-radius:8px; margin-bottom:15px;">
            <div style="font-weight:bold; color:#c0392b;">âš ï¸ PCãƒ»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å°‚ç”¨</div>
            <div style="font-size:0.85em; text-align:left; margin-top:5px; color:#c0392b;">
                ã“ã®ãƒ¢ãƒ¼ãƒ‰ã¯ç‰©ç†ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚<br>
                ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã®ãƒ•ãƒªãƒƒã‚¯å…¥åŠ›ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚
            </div>
        </div>

        <div style="margin: 15px 0;">
            <label style="font-weight:bold; color:#2c3e50;">æŒ‘æˆ¦ã™ã‚‹å­¦å¹´</label>
            <select id="typing-grade-select" class="select-box" style="width:100%; margin-top:5px; font-size:1.1em; padding:10px;">
                <option value="">å­¦å¹´ã‚’é¸æŠ...</option>
            </select>
        </div>

        <button class="menu-btn" style="background:#8e44ad;" onclick="startTypingGame()">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§å‡ºæ’ƒ</button>
        <button class="menu-btn" style="margin-top:10px; background:#95a5a6;" onclick="closeTypingMenu()">ã‚„ã‚ã‚‹</button>
    </div>
</div>

<div id="version-overlay" class="overlay hidden"><div class="modal" style="max-width:500px;"><h2 style="color:#2c3e50;">æ›´æ–°å±¥æ­´</h2><div class="version-list">
    <h4 style="color:#e67e22; border-bottom:2px solid #e67e22;">Ver 7.1.1 (Items Update)</h4>
    
    <h5 style="margin:10px 0 5px; color:#d35400;">âœ¨ æ–°ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…</h5>
    <ul>
        <li><b>ğŸ“• ã‚¢ã‚¤ãƒ†ãƒ åé›†</b>: ã‚¯ã‚¨ã‚¹ãƒˆã‚¯ãƒªã‚¢ã§ã€Œãƒšãƒ¼ã‚¸ã®ç ´ç‰‡ã€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã€‚</li>
        <li><b>âš–ï¸ äº¤æ›æ‰€</b>: æ–‡ç³»ãƒ»ç†ç³»ã®ãƒšãƒ¼ã‚¸ã‚’é›†ã‚ã¦ã€ŒçµŒé¨“å€¤ã®æ›¸ã€ã¨äº¤æ›ã€‚</li>
        <li><b>ğŸ’ª ç†Ÿç·´åº¦</b>: æˆ¦é—˜å‹åˆ©æ™‚ã«è£…å‚™ã‚­ãƒ£ãƒ©ãŒå°‘ã—æˆé•·ã—ã¾ã™ã€‚</li>
    </ul>

    <hr style="margin:15px 0; border:1px dashed #ccc;">
    <div style="color:#7f8c8d; font-size:0.9em;">
        <div><b>Ver 6.0.0</b>: ç§°å·ãƒ»ã‚¯ãƒ©ã‚¦ãƒ‰ã‚»ãƒ¼ãƒ–</div>
    </div>
</div><button class="menu-btn" style="margin-top:20px;" onclick="closeVersionHistory()">é–‰ã˜ã‚‹</button></div></div>

<div id="howto-overlay" class="overlay hidden" style="z-index: 500;">
    <div class="modal" style="max-width:550px; text-align:left;">
        <h2 style="color:#1abc9c; margin-top:0; text-align:center; border-bottom:2px solid #1abc9c; padding-bottom:5px;">ğŸ“– ãƒ—ãƒ¬ã‚¤ã‚¬ã‚¤ãƒ‰</h2>
        <div style="flex: 1; overflow-y: auto; padding: 5px; font-size: 0.9em; line-height: 1.6;">
            <h4 style="background:#ecf0f1; padding:5px; border-left:5px solid #2c3e50; margin:10px 0 5px;">âš”ï¸ åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h4>
            <ul style="padding-left:20px; margin:5px 0;">
                <li>åˆ¶é™æ™‚é–“å†…ã«æ­£è§£ã‚’é¸ã‚“ã§ãƒœã‚¹ã‚’æ”»æ’ƒï¼</li>
                <li><b>ã‚³ãƒ³ãƒœ</b>ã‚’ç¹‹ãã¨ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ï¼</li>
            </ul>
            <h4 style="background:#ecf0f1; padding:5px; border-left:5px solid #e74c3c; margin:15px 0 5px;">ğŸ“• ã‚¢ã‚¤ãƒ†ãƒ ã¨è‚²æˆ</h4>
            <ul style="padding-left:20px; margin:5px 0;">
                <li>æ–‡ç³»ç§‘ç›®ã§<b>èµ¤ãƒšãƒ¼ã‚¸</b>ã€ç†ç³»ç§‘ç›®ã§<b>é’ãƒšãƒ¼ã‚¸</b>ãŒãƒ‰ãƒ­ãƒƒãƒ—ã—ã¾ã™ã€‚</li>
                <li>ã‚·ãƒ§ãƒƒãƒ—ã®ã€Œäº¤æ›æ‰€ã€ã§ã€ãƒšãƒ¼ã‚¸ã‚’æ¶ˆè²»ã—ã¦<b>çµŒé¨“å€¤ã®æ›¸</b>ã‚’å…¥æ‰‹ã§ãã¾ã™ã€‚</li>
                <li>ã€Œå›³é‘‘ã€â†’ã€Œã‚­ãƒ£ãƒ©è©³ç´°ã€ã‹ã‚‰æ›¸ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</li>
            </ul>
        </div>
        <button class="menu-btn" style="margin-top:15px; background:#95a5a6; border-bottom-color:#7f8c8d;" onclick="closeHowToPlay()">é–‰ã˜ã‚‹</button>
    </div>
</div>
    
<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyG3MnjSn1D1flR3-LR1AzfoijF_ID7GJzZ1d5gYgemZd504kGwou02cV-M8c8kfJwi/exec';
    
    // Settings
    const RARITY_CAPS = { 'N': 5, 'R': 10, 'SR': 15, 'SSR': 20, 'UR': 30 };
    const EVO_COST_XP = { 'N': 10000, 'R': 50000, 'SR': 200000, 'SSR': 500000 };
    const EVO_STOCK_REQ = 10;
    const REBORN_COST_XP = 100000;
    const RARITY_ORDER = ['N', 'R', 'SR', 'SSR', 'UR'];
    const SKILL_TYPES = ['ATK', 'TIME', 'EXP'];
    const getRarityIndex = (r) => RARITY_ORDER.indexOf(r);

    const LV_BONUS_RATE = 0.01;
    const EXP_REQ = 100;
    const MAT_EXP = { 'N': 25, 'R': 50, 'SR': 100, 'SSR': 200, 'UR': 500 };
    const SELL_PRICES = { 'N': 250, 'R': 500, 'SR': 1000, 'SSR': 2000, 'UR': 5000 };
    const LOGIN_BONUS_EXP = 3000;
    const MAX_ITEM_LEVEL = 10;
    const MASTER_COUNT = 10;
    
    const TITLES = [
        { id:'t01', name:'ä¸‰æ—¥åŠä¸»å’æ¥­', req:'loginDays>=3', val:3, reward:5000, desc:'é€šç®—3æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t02', name:'ä¸€é€±é–“ã®å¥‡è·¡', req:'loginDays>=7', val:7, reward:10000, desc:'é€šç®—7æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t03', name:'ç¿’æ…£åŒ–ã®é”äºº', req:'loginDays>=14', val:14, reward:20000, desc:'é€šç®—14æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t04', name:'æœˆé–“MVP', req:'loginDays>=30', val:30, reward:50000, desc:'é€šç®—30æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t05', name:'å­£ç¯€ã‚’è¶…ãˆã¦', req:'loginDays>=100', val:100, reward:200000, desc:'é€šç®—100æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t06', name:'ä¼èª¬ã®å¸¸é€£', req:'loginDays>=365', val:365, reward:1000000, desc:'é€šç®—365æ—¥ãƒ—ãƒ¬ã‚¤' },
        { id:'t07', name:'ãƒ“ã‚®ãƒŠãƒ¼', req:'totalKill>=5', val:5, reward:5000, desc:'ç´¯è¨ˆ5ä½“æ’ƒç ´' },
        { id:'t08', name:'ã‚¨ãƒ¼ã‚¹', req:'totalKill>=20', val:20, reward:15000, desc:'ç´¯è¨ˆ20ä½“æ’ƒç ´' },
        { id:'t09', name:'ãƒ™ãƒ†ãƒ©ãƒ³', req:'totalKill>=50', val:50, reward:40000, desc:'ç´¯è¨ˆ50ä½“æ’ƒç ´' },
        { id:'t10', name:'ãƒ’ãƒ¼ãƒ­ãƒ¼', req:'totalKill>=100', val:100, reward:100000, desc:'ç´¯è¨ˆ100ä½“æ’ƒç ´' },
        { id:'t11', name:'ç ´å£Šç¥', req:'totalKill>=500', val:500, reward:500000, desc:'ç´¯è¨ˆ500ä½“æ’ƒç ´' },
        { id:'t12', name:'çŸ¥è­˜ã®èŠ½ç”Ÿãˆ', req:'totalCorrect>=50', val:50, reward:5000, desc:'ç´¯è¨ˆ50å•æ­£è§£' },
        { id:'t13', name:'çŸ¥è­˜ã®æ¢æ±‚è€…', req:'totalCorrect>=200', val:200, reward:20000, desc:'ç´¯è¨ˆ200å•æ­£è§£' },
        { id:'t14', name:'çŸ¥ã®å·¨äºº', req:'totalCorrect>=500', val:500, reward:50000, desc:'ç´¯è¨ˆ500å•æ­£è§£' },
        { id:'t15', name:'æ­©ãç™¾ç§‘äº‹å…¸', req:'totalCorrect>=1000', val:1000, reward:100000, desc:'ç´¯è¨ˆ1000å•æ­£è§£' },
        { id:'t16', name:'å…¨çŸ¥å…¨èƒ½', req:'totalCorrect>=5000', val:5000, reward:1000000, desc:'ç´¯è¨ˆ5000å•æ­£è§£' },
        { id:'t17', name:'é›†ä¸­ãƒ¢ãƒ¼ãƒ‰', req:'maxCombo>=20', val:20, reward:10000, desc:'1ãƒ—ãƒ¬ã‚¤20ã‚³ãƒ³ãƒœ' },
        { id:'t18', name:'ã‚¾ãƒ¼ãƒ³çªå…¥', req:'maxCombo>=40', val:40, reward:30000, desc:'1ãƒ—ãƒ¬ã‚¤40ã‚³ãƒ³ãƒœ' },
        { id:'t19', name:'ç¥ã®é ˜åŸŸ', req:'maxCombo>=60', val:60, reward:100000, desc:'1ãƒ—ãƒ¬ã‚¤60ã‚³ãƒ³ãƒœ' },
        { id:'t20', name:'å®Œå…¨ç„¡æ¬ ', req:'perfect', val:1, reward:20000, desc:'HPæº€ã‚¿ãƒ³ã§ã‚¯ãƒªã‚¢' },
        { id:'t21', name:'ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¹ã‚¿ãƒ¼', req:'speed', val:1, reward:5000, desc:'æ®‹ã‚Š9ç§’ä»¥ä¸Šã§æ­£è§£' },
        { id:'t22', name:'ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼', req:'collection>=5', val:5, reward:10000, desc:'å›³é‘‘5ç¨®åé›†' },
        { id:'t23', name:'ãƒãƒ‹ã‚¢', req:'collection>=15', val:15, reward:30000, desc:'å›³é‘‘15ç¨®åé›†' },
        { id:'t24', name:'åšç‰©é¤¨é¤¨é•·', req:'collection>=30', val:30, reward:100000, desc:'å›³é‘‘30ç¨®åé›†' },
        { id:'t25', name:'ã‚¢ã‚¤ãƒ†ãƒ æ„›å¥½å®¶', req:'itemMax', val:1, reward:50000, desc:'ã‚¢ã‚¤ãƒ†ãƒ Lv.MAX' },
        { id:'t26', name:'å°é‡‘æŒã¡', req:'xp>=100000', val:100000, reward:10000, desc:'æ‰€æŒEXP 10ä¸‡é”æˆ' },
        { id:'t27', name:'å¤§å¯Œè±ª', req:'xp>=1000000', val:1000000, reward:100000, desc:'æ‰€æŒEXP 100ä¸‡é”æˆ' },
        { id:'t28', name:'å„„ä¸‡é•·è€…', req:'xp>=10000000', val:10000000, reward:1000000, desc:'æ‰€æŒEXP 1000ä¸‡é”æˆ' },
        { id:'t29', name:'å¥‡è·¡ã®å‡ºä¼šã„', req:'ssr', val:1, reward:50000, desc:'SSRå…¥æ‰‹' },
        { id:'t30', name:'é™ç•Œçªç ´', req:'lvMax', val:1, reward:50000, desc:'ã‚­ãƒ£ãƒ©Lv.20åˆ°é”' }
    ];

    const MISSIONS = [
        { id: 'play', target: 1, reward: 500, title: "æœ¬æ—¥ã®æŒ‘æˆ¦", desc: "ã‚¯ã‚¨ã‚¹ãƒˆã‚’1å›ãƒ—ãƒ¬ã‚¤" },
        { id: 'kill', target: 1, reward: 1000, title: "ãƒœã‚¹æ’ƒç ´ï¼", desc: "ãƒœã‚¹ã‚’1ä½“å€’ã™" },
        { id: 'correct', target: 10, reward: 1000, title: "ä¿®è¡Œã®æˆæœ", desc: "åˆè¨ˆ10å•æ­£è§£ã™ã‚‹" },
        { id: 'maxCombo', target: 5, reward: 1000, title: "ã‚³ãƒ³ãƒœãƒã‚¹ã‚¿ãƒ¼", desc: "5ã‚³ãƒ³ãƒœä»¥ä¸Šé”æˆ" },
        { id: 'enhance', target: 1, reward: 500, title: "è£…å‚™ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹", desc: "ã‚­ãƒ£ãƒ©ã‚’1å›å¼·åŒ–" }
    ];
    const MISSION_ALL_CLEAR = 3000;

    let rawData = {};
    let playData = { questions: [], qIndex: 0, currentBoss: null, isRevenge: false, activeOaths: [], isRandom: false, isTyping: false, typingTarget: null, typingIndex: 0 };
    let countdownTimer = null;
    
    let gameState = { 
        score: 0, combo: 0, lives: 3, enemyHP: 100, maxHP: 100, timer: null, timeLeft: 0, maxTime: 10, 
        xp: 0, equipped: '1', itemLevels: {}, charaInventory: {},
        stats: { totalPlay:0, totalKill:0, totalCorrect:0, maxCombo:0, loginDays:0 },
        subjectStats: {},
        unlockedTitles: [],
        claimedGifts: [], 
        revengeList: [],
        inventory: { redPages:0, bluePages:0, xpBookSmall:0, xpBookMedium:0, xpBookLarge:0 }
    };
    
    let dailyMissions = { date: "", progress: { play: 0, kill: 0, correct: 0, maxCombo: 0, enhance: 0 }, claimed: { play: false, kill: false, correct: false, maxCombo: false, enhance: false, allClear: false } };
    let currentUserId = ""; 
    let viewingCharaId = null, isGameActive = false, isPaused = false;

    window.onload = async () => { 
        initUserId(); 
        loadSaveData(); 
        await fetchData(); 
        initTitle(); 
        checkLoginBonus(); 
        checkMissionDate(); 
        checkTitles();
    };

    function initUserId() {
        let id = localStorage.getItem('sq_user_id');
        if (!id) {
            id = Math.random().toString(36).substring(2, 10);
        localStorage.setItem('sq_user_id', id);
    }
    currentUserId = id;
}

    function loadSaveData() {
        const safeParse = (key, defaultVal) => {
            try {
                const raw = localStorage.getItem(key);
                if (raw === null || raw === undefined || raw === "undefined") return defaultVal;
                let parsed = JSON.parse(raw);
                if (typeof parsed === 'string') { try { parsed = JSON.parse(parsed); } catch(e){} }
                return parsed || defaultVal;
            } catch (e) { return defaultVal; }
        };

        try { gameState.xp = parseInt(localStorage.getItem('sq_xp') || '0'); } catch(e) { gameState.xp = 0; }
        gameState.equipped = localStorage.getItem('sq_equip') || '1';
        gameState.itemLevels = safeParse('sq_items_v2', {});
        gameState.charaInventory = safeParse('sq_inventory', {});
        
        if (!gameState.charaInventory || Object.keys(gameState.charaInventory).length === 0) {
            const oldCharas = localStorage.getItem('sq_charas');
            if (oldCharas) {
                try {
                    const idList = JSON.parse(oldCharas);
                    if (Array.isArray(idList) && idList.length > 0) {
                        idList.forEach(id => { gameState.charaInventory[id] = { level: 1, count: 1, exp: 0 }; });
                        localStorage.setItem('sq_inventory', JSON.stringify(gameState.charaInventory));
                    }
                } catch(e) {}
            }
            if (Object.keys(gameState.charaInventory).length === 0) gameState.charaInventory = { "1": { level: 1, count: 1, exp: 0 } };
        }
        
        gameState.stats = safeParse('sq_stats', { totalPlay:0, totalKill:0, totalCorrect:0, maxCombo:0, loginDays:0 });
        gameState.subjectStats = safeParse('sq_subject_stats', {});
        gameState.unlockedTitles = safeParse('sq_titles', []);
        gameState.claimedGifts = safeParse('sq_claimed_gifts', []);
        gameState.revengeList = safeParse('sq_revenge', []);
        gameState.unitProgress = safeParse('sq_unit_progress', {});
        
        // --- ä¿®æ­£: èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®æ•°å€¤ãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–ã‚’å¼·åŒ– ---
        const loadedInv = safeParse('sq_item_inventory', {});
        gameState.inventory = {
            redPages: Number(loadedInv.redPages) || 0,
            bluePages: Number(loadedInv.bluePages) || 0,
            xpBookSmall: Number(loadedInv.xpBookSmall) || 0,
            xpBookMedium: Number(loadedInv.xpBookMedium) || 0,
            xpBookLarge: Number(loadedInv.xpBookLarge) || 0
        };
        
        try { dailyMissions = safeParse('sq_missions', { date:"", progress:{}, claimed:{} }); } catch(e){}
    }

function saveGame() {
    localStorage.setItem('sq_xp', gameState.xp);
        localStorage.setItem('sq_equip', gameState.equipped);
        localStorage.setItem('sq_items_v2', JSON.stringify(gameState.itemLevels));
        localStorage.setItem('sq_inventory', JSON.stringify(gameState.charaInventory));
        localStorage.setItem('sq_missions', JSON.stringify(dailyMissions));
        localStorage.setItem('sq_stats', JSON.stringify(gameState.stats));
        localStorage.setItem('sq_titles', JSON.stringify(gameState.unlockedTitles));
        localStorage.setItem('sq_claimed_gifts', JSON.stringify(gameState.claimedGifts));
        localStorage.setItem('sq_revenge', JSON.stringify(gameState.revengeList || []));
        localStorage.setItem('sq_unit_progress', JSON.stringify(gameState.unitProgress || {}));
        localStorage.setItem('sq_item_inventory', JSON.stringify(gameState.inventory));
    }

    function checkTitles(tempCondition = null) {
        let count = 0;
        let collectionCount = 0;
        let hasSSR = false;
        let hasLvMax = false;
        if(gameState.charaInventory) {
            collectionCount = Object.keys(gameState.charaInventory).length;
            Object.keys(gameState.charaInventory).forEach(id => {
                const c = rawData.characters.find(x => x.id === id);
                const inv = gameState.charaInventory[id];
                if(c && c.rarity === 'SSR') hasSSR = true;
                if(inv && inv.level >= 20) hasLvMax = true;
            });
        }
        let hasItemMax = false;
        if(gameState.itemLevels) Object.values(gameState.itemLevels).forEach(lv => { if(lv >= MAX_ITEM_LEVEL) hasItemMax = true; });

        TITLES.forEach(t => {
            if (gameState.unlockedTitles.includes(t.id)) return;
            let cleared = false;
            if (t.req === 'perfect' && gameState.stats.achieved_perfect) cleared = true;
            else if (t.req === 'speed' && gameState.stats.achieved_speed) cleared = true;
            else if (t.req === 'ssr' && hasSSR) cleared = true;
            else if (t.req === 'lvMax' && hasLvMax) cleared = true;
            else if (t.req === 'itemMax' && hasItemMax) cleared = true;
            else if (t.req.includes('collection')) { if (collectionCount >= t.val) cleared = true; }
            else if (t.req.includes('xp')) { if (gameState.xp >= t.val) cleared = true; }
            else {
                try {
                    const key = t.req.split('>')[0];
                    const val = gameState.stats[key] || 0;
                    if (val >= t.val) cleared = true;
                } catch(e){}
            }
            if (cleared) count++;
        });
        const badge = document.getElementById('title-badge');
        if(count > 0) { badge.classList.remove('hidden'); badge.innerText = count > 9 ? '!' : count; } else { badge.classList.add('hidden'); }
    }

    function openTitles() { document.getElementById('titles-overlay').classList.remove('hidden'); renderTitles(); }
    function closeTitles() { document.getElementById('titles-overlay').classList.add('hidden'); }

    function renderTitles() {
        const list = document.getElementById('titles-list');
        list.innerHTML = '';
        let collectionCount = 0;
        if(gameState.charaInventory) collectionCount = Object.keys(gameState.charaInventory).length;

        TITLES.forEach(t => {
            const isClaimed = gameState.unlockedTitles.includes(t.id);
            let isUnlocked = false;
            if (isClaimed) isUnlocked = true;
            else {
                if (t.req.includes('collection') && collectionCount >= t.val) isUnlocked = true;
                else if (t.req.includes('xp') && gameState.xp >= t.val) isUnlocked = true;
                else if (t.req === 'ssr' && Object.keys(gameState.charaInventory).some(id => rawData.characters.find(c=>c.id==id)?.rarity=='SSR')) isUnlocked = true;
                else if (t.req === 'lvMax' && Object.values(gameState.charaInventory).some(inv => inv.level >= 20)) isUnlocked = true;
                else if (t.req === 'itemMax' && Object.values(gameState.itemLevels).some(lv => lv >= MAX_ITEM_LEVEL)) isUnlocked = true;
                else if (t.req === 'perfect' && gameState.stats.achieved_perfect) isUnlocked = true;
                else if (t.req === 'speed' && gameState.stats.achieved_speed) isUnlocked = true;
                else { const key = t.req.split('>')[0]; if (gameState.stats[key] >= t.val) isUnlocked = true; }
            }
            let statusClass = isClaimed ? 'claimed' : (isUnlocked ? 'unlocked' : '');
            let btnText = isClaimed ? 'å—å–æ¸ˆ' : (isUnlocked ? `å—å–: ${t.reward}XP` : 'æœªé”æˆ');
            let btnAction = (isUnlocked && !isClaimed) ? `onclick="claimTitle('${t.id}', ${t.reward})"` : '';
            list.innerHTML += `<div class="title-item ${statusClass}"><div class="title-header"><span class="title-name">${t.name}</span><button class="title-reward-btn" ${btnAction}>${btnText}</button></div><div class="title-req">${t.desc}</div></div>`;
        });
    }

    function claimTitle(id, reward) {
        if(gameState.unlockedTitles.includes(id)) return;
        gameState.unlockedTitles.push(id);
        gameState.xp += reward;
        saveGame();
        renderTitles();
        updateTitleInfo();
        checkTitles();
        alert(`ç§°å·ã‚’ç²å¾—ã—ã¾ã—ãŸï¼\nå ±é…¬: ${reward} XP`);
    }

    function openSyncMenu() { document.getElementById('sync-overlay').classList.remove('hidden'); document.getElementById('my-user-id').innerText = currentUserId; }
    function closeSyncMenu() { document.getElementById('sync-overlay').classList.add('hidden'); }

    async function uploadData() {
        if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåŒã˜IDã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰")) return;
        saveGame();
        const backupData = { xp: gameState.xp, equipped: gameState.equipped, itemLevels: gameState.itemLevels, charaInventory: gameState.charaInventory, missions: dailyMissions, stats: gameState.stats, unlockedTitles: gameState.unlockedTitles, claimedGifts: gameState.claimedGifts, revengeList: gameState.revengeList, unitProgress: gameState.unitProgress, inventory: gameState.inventory };
        const btn = document.querySelector('#sync-overlay button'); const originalText = btn.innerText;
        btn.innerText = "é€ä¿¡ä¸­..."; btn.disabled = true;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'save', userId: currentUserId, data: backupData }) });
            const json = await res.json();
            if(json.status === 'success') alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼"); else alert("ä¿å­˜å¤±æ•—: " + json.message);
        } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

    async function downloadData() {
        const inputId = document.getElementById('input-sync-id').value.trim();
        if(!inputId) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(!confirm("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚")) return;
        const btns = document.querySelectorAll('#sync-overlay button');
        let btn = null; for(let i=0; i<btns.length; i++) { if(btns[i].innerText.includes('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰')) btn = btns[i]; }
        if(!btn) btn = btns[btns.length - 2]; 
        const originalText = btn.innerText; btn.innerText = "å—ä¿¡ä¸­..."; btn.disabled = true;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'load', userId: inputId }) });
            const json = await res.json();
            if (json.questions || json.appVersion) return alert("ã€ã‚¨ãƒ©ãƒ¼ã€‘\nã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒåæ˜ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            if(json.status === 'success') {
                let data = json.data;
                if (typeof data === 'string') { try { data = JSON.parse(data); } catch(e) {} }
                if(!data) { alert("ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ãŒç©ºã§ã—ãŸã€‚"); return; }
                const forceObj = (v) => { if(!v)return{}; if(typeof v==='string'){try{return JSON.parse(v)}catch(e){return{}}} return v; };
                const forceArr = (v) => { if(!v)return[]; if(typeof v==='string'){try{return JSON.parse(v)}catch(e){return[]}} return Array.isArray(v)?v:[]; };
                gameState.xp = parseInt(data.xp || 0);
                gameState.equipped = String(data.equipped || '1');
                gameState.itemLevels = forceObj(data.itemLevels);
                gameState.charaInventory = forceObj(data.charaInventory);
                dailyMissions = forceObj(data.missions);
                gameState.stats = forceObj(data.stats);
                gameState.unlockedTitles = forceArr(data.unlockedTitles);
                gameState.claimedGifts = forceArr(data.claimedGifts);
                gameState.revengeList = forceArr(data.revengeList);
                gameState.unitProgress = forceObj(data.unitProgress);
                
                // --- ä¿®æ­£: ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ™‚ã®æ•°å€¤è£œæ­£ ---
                const cInv = forceObj(data.inventory);
                gameState.inventory = {
                    redPages: Number(cInv.redPages) || 0,
                    bluePages: Number(cInv.bluePages) || 0,
                    xpBookSmall: Number(cInv.xpBookSmall) || 0,
                    xpBookMedium: Number(cInv.xpBookMedium) || 0,
                    xpBookLarge: Number(cInv.xpBookLarge) || 0
                };

                currentUserId = inputId;
                localStorage.setItem('sq_user_id', inputId);
                saveGame();
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸï¼\nãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
                location.reload();
            } else alert("èª­ã¿è¾¼ã¿å¤±æ•—: " + (json.message || "Unknown error"));
        } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); } finally { btn.innerText = originalText; btn.disabled = false; }
    }

async function fetchData() {
    try {
            const res = await fetch(API_URL + '?t=' + new Date().getTime());
            if (!res.ok) throw new Error("Network response was not ok");
            const data = await res.json();
            const getVal = (obj, keys) => { for (const k of keys) { const v = obj[k]; if (v !== undefined && v !== null && v !== "") return String(v); } return ""; };
            const getFuzzyVal = (obj, keyword, defaultVal) => { const key = Object.keys(obj).find(k => k.includes(keyword)); const val = key ? obj[key] : ""; return (val !== undefined && val !== null && val !== "") ? String(val) : defaultVal; };
            const convertDriveUrl = (url) => { if(!url || !url.startsWith('http')) return url; if(url.includes('drive.google.com') && (url.includes('/file/d/') || url.includes('id='))) { let id = ""; const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(match1) id = match1[1]; else { const match2 = url.match(/id=([a-zA-Z0-9_-]+)/); if(match2) id = match2[1]; } if(id) return `https://drive.google.com/thumbnail?sz=w1000&id=${id}`; } return url; };
            rawData = {};
            const generateHashId = (str, prefix) => { let hash = 0; for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i) | 0; return prefix + "_" + Math.abs(hash); };

            for (let key in data) {
                const lowerKey = key.toLowerCase();
                try {
                    if (lowerKey.includes('questions') || lowerKey.includes('question')) {
                        rawData.questions = data[key].filter(d => d).map(q => {
                            const qText = getVal(q, ['q', 'question', 'å•é¡Œ', 'å•é¡Œæ–‡']);
                            const aText = getVal(q, ['a', 'answer', 'æ­£è§£']);
                            let hash = 0; const str = qText + aText; for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash |= 0; }
                            return { id: "q_" + Math.abs(hash), grade: getVal(q, ['grade', 'å­¦å¹´']), subject: getVal(q, ['subject', 'æ•™ç§‘']), unit: getVal(q, ['unit', 'å˜å…ƒ']), q: qText, a: aText, choices: q.choices ? String(q.choices).split(',') : [ getVal(q, ['èª¤ç­”1']), getVal(q, ['èª¤ç­”2']), getVal(q, ['èª¤ç­”3']), getVal(q, ['a', 'æ­£è§£']) ].filter(x => x !== "") };
                        });
                    } else if (lowerKey.includes('character')) {
                        rawData.characters = data[key].filter(d => d).map(c => { const name = getVal(c, ['name', 'åå‰']) || "Unknown"; return { id: String(c.id || c.ID || generateHashId(name, 'chara')), name: name, rarity: getVal(c, ['rarity', 'ãƒ¬ã‚¢']) || "N", type: getVal(c, ['type', 'ã‚¿ã‚¤ãƒ—']) || "ATK", value: Number(getVal(c, ['value', 'è£œæ­£å€¤', 'åŠ¹æœå€¤']) || 1.0), desc: getVal(c, ['desc', 'è§£èª¬']), imageUrl: convertDriveUrl(getVal(c, ['imageUrl', 'ç”»åƒURL', 'ç”»åƒ'])) }; });
                    } else if (lowerKey.includes('boss')) {
                        rawData.bosses = data[key].filter(d => d).map(b => ({ grade: getVal(b, ['grade', 'å­¦å¹´']), unit: getVal(b, ['unit', 'å˜å…ƒ']), name: getVal(b, ['name', 'bossName', 'ãƒœã‚¹å']) || "Boss", hp: Number(getVal(b, ['hp', 'bossHP', 'ãƒœã‚¹HP']) || 3000), icon: convertDriveUrl(getFuzzyVal(b, 'ãƒœã‚¹ç”»åƒ', "ğŸ‘¾")) }));
                    } else if (lowerKey.includes('shop')) {
                        rawData.shopItems = data[key].filter(d => d).map(i => { const name = getVal(i, ['name', 'ã‚¢ã‚¤ãƒ†ãƒ å']) || "Item"; return { id: String(i.id || i.ID || generateHashId(name, 'item')), name: name, price: Number(getVal(i, ['price', 'ä¾¡æ ¼']) || 1000), type: getVal(i, ['type', 'ã‚¿ã‚¤ãƒ—']) || "ATK", value: Number(getVal(i, ['value', 'åŠ¹æœå€¤']) || 0.1), desc: getVal(i, ['desc', 'èª¬æ˜']), icon: getVal(i, ['icon', 'ã‚¢ã‚¤ã‚³ãƒ³']) || "ğŸ" }; });
                    } else if (lowerKey.includes('typing')) {
                        rawData.typing = data[key].filter(d => d).map(t => ({ id: String(t.id || t.ID || generateHashId(getVal(t, ['japanese','æ—¥æœ¬èª']), 'type')), japanese: getVal(t, ['japanese', 'æ—¥æœ¬èª', 'display']), romaji: getVal(t, ['romaji', 'ãƒ­ãƒ¼ãƒå­—', 'input']).toLowerCase().replace(/\s+/g, ''), grade: getVal(t, ['grade', 'å­¦å¹´']) })).filter(t => t.japanese && t.romaji);
                    } else if (lowerKey.includes('randomboss')) { rawData.randomBosses = data[key];
                    } else if (lowerKey.includes('config')) { rawData.config = data[key];
                    } else if (lowerKey.includes('gift')) { rawData.gifts = data[key]; }
                } catch(e) { console.warn("Skip row"); }
            }

            if (rawData.bosses && rawData.characters) {
                rawData.bosses.forEach(b => {
                    const bossCharId = "boss_" + b.name;
                    if (!rawData.characters.find(c => c.id === bossCharId)) {
                        rawData.characters.push({ id: bossCharId, name: "ã€é­”äººã€‘" + b.name, rarity: "UR", type: "ALL", value: 1.3, desc: "ã‹ã¤ã¦ç«‹ã¡ã¯ã ã‹ã£ãŸå¼·æ•µã€‚ä»Šã¯é ¼ã‚‚ã—ã„å‘³æ–¹ã ã€‚", imageUrl: b.icon });
                    }
                });
            }

            if (!rawData.questions || rawData.questions.length === 0) throw new Error("Questions not found.");
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
            checkTitles();
            checkAdminGifts();
        } catch(e) { 
            document.getElementById('error-message').innerText = e.message;
            document.getElementById('error-message').style.display = 'block';
        }
    }

    function initTitle() {
        if(!rawData.questions) return;
        const grades = [...new Set(rawData.questions.map(q => q.grade))].filter(g=>g);
        const gSelect = document.getElementById('grade-select');
        gSelect.innerHTML = '<option value="">å­¦å¹´ã‚’é¸æŠ</option>';
        grades.forEach(g => gSelect.innerHTML += `<option value="${g}">${g}</option>`);
        filterSubjects(); updateTitleInfo();
    }
    function filterSubjects() {
        const gVal = document.getElementById('grade-select').value;
        const sSelect = document.getElementById('subject-select');
        sSelect.innerHTML = '<option value="">æ•™ç§‘ã‚’é¸æŠ</option>';
        document.getElementById('unit-select').innerHTML = '<option value="">å˜å…ƒã‚’é¸æŠ</option>';
        if(!gVal) return;
        let targetList = rawData.questions.filter(q => q.grade == gVal);
        const subjects = [...new Set(targetList.map(q => q.subject))].filter(s=>s);
        subjects.forEach(s => sSelect.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function filterUnits() {
        const gVal = document.getElementById('grade-select').value;
        const sVal = document.getElementById('subject-select').value;
        const uSelect = document.getElementById('unit-select');
        uSelect.innerHTML = '<option value="">å˜å…ƒã‚’é¸æŠ</option>';
        if(!gVal || !sVal) return;
        let targetList = rawData.questions.filter(q => q.grade == gVal && q.subject == sVal);
        const units = [...new Set(targetList.map(q => q.unit))].filter(u=>u);
        const activeConfigs = rawData.config ? rawData.config.filter(c => c.message && c.message !== "") : [];
        units.forEach(u => {
            let label = u;
            const isTarget = activeConfigs.some(c => String(c.grade) === String(gVal) && String(c.subject) === String(sVal) && String(c.unit) === String(u));
            if (isTarget) label = "â˜… " + u;
            if (gameState.unitProgress) {
                const key = `${gVal}_${sVal}_${u}`;
                const prog = gameState.unitProgress[key];
                if (prog) { if (prog.cleared) label += " â—"; else if (prog.played) label += " â—¯"; }
            }
            uSelect.innerHTML += `<option value="${u}">${label}</option>`;
        });
    }

    function updateTitleInfo() {
        const chara = rawData.characters ? rawData.characters.find(c => c.id == gameState.equipped) : null;
        let lv = (gameState.charaInventory[gameState.equipped] || {}).level || 0;
        document.getElementById('title-equipped-name').innerText = (chara ? chara.name : "ãªã—") + " Lv." + lv;
        document.getElementById('title-xp').innerText = gameState.xp;
        const imgContainer = document.getElementById('title-chara-img');
        if(chara?.imageUrl && chara.imageUrl.startsWith('http')) imgContainer.innerHTML = `<img src="${chara.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
        else imgContainer.innerHTML = `<div style="text-align:center;line-height:40px;">âœï¸</div>`;

        const rBtn = document.getElementById('btn-revenge');
        const rCount = (gameState.revengeList || []).length;
        if (rCount > 0) { rBtn.disabled = false; rBtn.innerHTML = `ğŸ’€ ãƒªãƒ™ãƒ³ã‚¸ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ <div class="badge">${rCount}</div>`; } else { rBtn.disabled = true; rBtn.innerHTML = `ğŸ’€ ãƒªãƒ™ãƒ³ã‚¸ãƒ»ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ <div class="badge hidden">0</div>`; }

        const banner = document.getElementById('campaign-banner');
        const bannerText = document.getElementById('campaign-text');
        let activeConfigs = [];
        if (rawData.config) activeConfigs = rawData.config.filter(c => c.message && c.message !== "");
        if (activeConfigs.length > 0) {
            banner.classList.remove('hidden'); banner.style.display = 'block';
            const combinedText = activeConfigs.map(c => `ğŸ“¢ ${c.message} ï¼ˆå¼·åŒ–å¯¾è±¡: ${c.grade} ${c.subject} ${c.unit}ï¼‰`).join("ã€€ã€€ã€€"); 
            bannerText.innerText = combinedText;
        } else { banner.style.display = 'none'; }
    }

    function startGame() {
        const g = document.getElementById('grade-select').value, s = document.getElementById('subject-select').value, u = document.getElementById('unit-select').value;
        if(!g || !s || !u) return alert("å…¨ã¦é¸æŠã—ã¦ãã ã•ã„");
        let qList = rawData.questions.filter(q => q.grade == g && q.subject == s && q.unit == u);
        if(qList.length === 0) return alert("å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
        let boss = rawData.bosses ? rawData.bosses.find(b => b.unit == u && b.grade == g) : null;
        if(!boss) boss = { name: "ãƒ†ã‚¹ãƒˆã®é­”äºº", hp: 1000, icon: "ğŸ˜ˆ" };
        playData.questions = qList.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        playData.isRevenge = false; playData.activeOaths = []; playData.isRandom = false;
        playData.context = { grade: g, subject: s, unit: u };
        const charaStats = getCharaStats();
        gameState.score = 0; gameState.combo = 0; gameState.lives = 3; gameState.enemyHP = Number(boss.hp)||3000; gameState.maxHP = gameState.enemyHP; gameState.maxTime = 10 * charaStats.time;
        isGameActive = false; isPaused = false;
        document.getElementById('pause-overlay').classList.add('hidden');
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        const enemyBox = document.querySelector('.enemy-visual-box');
        const enemyIcon = document.getElementById('ui-enemy-icon');
        enemyBox.classList.remove('anim-paused', 'fade-out');
        enemyIcon.classList.remove('shake-anim');
        document.getElementById('ui-enemy-name').innerText = boss.name;
        if(boss.icon.startsWith('http')) { enemyIcon.innerHTML = `<img src="${boss.icon}">`; } else { enemyIcon.innerHTML = boss.icon; }
        document.getElementById('ui-timer').style.width = '100%';
        document.getElementById('ui-timer-text').innerText = gameState.maxTime.toFixed(1);
        updateUI(); startCountdown();
    }

    function startRevengeMode() {
        if (!gameState.revengeList || gameState.revengeList.length === 0) return;
        const targetQuestions = rawData.questions.filter(q => gameState.revengeList.includes(q.id));
        if (targetQuestions.length !== gameState.revengeList.length) { gameState.revengeList = targetQuestions.map(q => q.id); saveGame(); updateTitleInfo(); }
        if (targetQuestions.length === 0) { alert("å¾©ç¿’ã™ã¹ãå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); gameState.revengeList = []; saveGame(); updateTitleInfo(); return; }
        const boss = { name: "å¿˜å´ã®äº¡éœŠ", hp: targetQuestions.length * 100, icon: "ğŸ‘»" };
        playData.questions = targetQuestions.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        playData.isRevenge = true; playData.activeOaths = []; playData.isRandom = false; 
        const charaStats = getCharaStats();
        gameState.score = 0; gameState.combo = 0; gameState.lives = 3; gameState.enemyHP = boss.hp; gameState.maxHP = boss.hp; gameState.maxTime = 10 * charaStats.time;
        isGameActive = false; isPaused = false;
        document.getElementById('pause-overlay').classList.add('hidden');
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        const enemyBox = document.querySelector('.enemy-visual-box');
        const enemyIcon = document.getElementById('ui-enemy-icon');
        enemyBox.classList.remove('anim-paused', 'fade-out');
        enemyIcon.classList.remove('shake-anim');
        document.getElementById('ui-enemy-name').innerText = boss.name;
        enemyIcon.innerHTML = boss.icon; 
        document.getElementById('ui-timer').style.width = '100%';
        document.getElementById('ui-timer-text').innerText = gameState.maxTime.toFixed(1);
        updateUI(); startCountdown();
    }

    function startCountdown() {
        const qBox = document.getElementById('ui-question'); const cGrid = document.getElementById('ui-choices');
        qBox.innerText = "READY..."; cGrid.innerHTML = ""; 
        let count = 3; showCutIn(count); playSE('count'); 
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(() => {
            if (document.getElementById('game-screen').classList.contains('hidden')) { clearInterval(countdownTimer); return; }
            count--;
            if(count > 0) { showCutIn(count); playSE('count'); } else if(count === 0) { showCutIn("GO!"); playSE('start'); } else {
                clearInterval(countdownTimer);
                isGameActive = true;
                if(playData.isTyping) nextTypingQuestion(); else nextQuestion();
                playBGM();
            }
        }, 1000);
    }

    function getCharaStats() {
        let stats = { atk: 1.0, time: 1.0, exp: 1.0 };
        if(rawData.characters) {
            const charId = gameState.equipped;
            const charaData = rawData.characters.find(c => c.id == charId);
            if(charaData) {
                let userChara = gameState.charaInventory[charId];
                let level = userChara ? userChara.level : 0;
                let baseVal = (userChara && userChara.isEvolved && userChara.customValue) ? userChara.customValue : Number(charaData.value);
                let finalVal = baseVal + (level * LV_BONUS_RATE);
                let skills = (userChara && userChara.skills && userChara.skills.length > 0) ? userChara.skills : [charaData.type];
                skills.forEach(type => {
                    if(type === 'ALL') { stats.atk = finalVal; stats.time = finalVal; stats.exp = finalVal; } else {
                        if(type === 'ATK') stats.atk = finalVal;
                        if(type === 'TIME') stats.time = finalVal;
                        if(type === 'EXP') stats.exp = finalVal;
                    }
                });
            }
        }
        if(gameState.itemLevels && rawData.shopItems) {
            Object.keys(gameState.itemLevels).forEach(itemId => {
                const item = rawData.shopItems.find(i => i.id === itemId);
                const level = gameState.itemLevels[itemId];
                if(item && level > 0) {
                    if(item.type === 'ATK') stats.atk += (Number(item.value) * level);
                    if(item.type === 'TIME') stats.time += (Number(item.value) * level);
                    if(item.type === 'EXP') stats.exp += (Number(item.value) * level);
                }
            });
        }
        if (playData.activeOaths && playData.activeOaths.includes('weak')) stats.atk *= 0.5;
        return stats;
    }

    function getDisplayName(char, inv) {
        if (!inv) return char.name;
        let name = char.name;
        const currentR = inv.currentRarity || char.rarity;
        if (getRarityIndex(currentR) > getRarityIndex(char.rarity)) name += '<span class="name-deco-evo">âœ¨ï¸</span>';
        if (inv.reincarnationCount && inv.reincarnationCount > 0) name += '<span class="name-deco-reborn">ğŸª½</span>';
        return name;
    }

    function executeEvolution() {
        const id = viewingCharaId; const char = rawData.characters.find(c => c.id == id); const inv = gameState.charaInventory[id]; if (!inv) return;
        const currentR = inv.currentRarity || char.rarity; const costXP = EVO_COST_XP[currentR];
        if (gameState.xp < costXP) return alert(`EXPãŒè¶³ã‚Šã¾ã›ã‚“ (å¿…è¦: ${costXP})`);
        if (!confirm(`ã€é€²åŒ–ç¢ºèªã€‘\næ¶ˆè²»: ${costXP} XP, åœ¨åº«${EVO_STOCK_REQ}å€‹\n\nãƒ»ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãŒä¸Šæ˜‡ã—ã¾ã™\nãƒ»ãƒ¬ãƒ™ãƒ«ã¯0ã«æˆ»ã‚Šã¾ã™\nãƒ»åŸºç¤åŠ¹æœå€¤ãŒãƒ©ãƒ³ãƒ€ãƒ å¼·åŒ–ã•ã‚Œã¾ã™\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
        gameState.xp -= costXP; inv.count -= EVO_STOCK_REQ;
        const nextIdx = getRarityIndex(currentR) + 1; inv.currentRarity = RARITY_ORDER[nextIdx]; inv.level = 0; inv.exp = 0;
        const baseVal = (inv.isEvolved && inv.customValue) ? inv.customValue : Number(char.value);
        const bonus = [0.25, 0.30, 0.35][Math.floor(Math.random() * 3)]; inv.customValue = baseVal + bonus;
        if (!inv.skills) inv.skills = [char.type];
        if (!inv.skills.includes('ALL')) {
            if (Math.random() < 0.30) {
                const missing = SKILL_TYPES.filter(s => !inv.skills.includes(s));
                if (missing.length > 0) { const addSkill = missing[Math.floor(Math.random() * missing.length)]; inv.skills.push(addSkill); alert(`âœ¨ ã‚¹ã‚­ãƒ«è¿½åŠ æˆåŠŸï¼\n[${addSkill}] ã‚’ç¿’å¾—ã—ã¾ã—ãŸï¼`); }
                if (SKILL_TYPES.every(s => inv.skills.includes(s))) { inv.skills = ['ALL']; alert(`ğŸ‘‘ å…¨å±æ€§åˆ¶è¦‡ï¼ã‚¹ã‚­ãƒ«ãŒ [ALL] ã«é€²åŒ–ã—ã¾ã—ãŸï¼`); }
            }
        }
        inv.isEvolved = true; saveGame(); playSE('win');
        alert(`é€²åŒ–æˆåŠŸï¼\nãƒ¬ã‚¢ãƒªãƒ†ã‚£: ${inv.currentRarity}\nåŸºç¤åŠ¹æœ: x${inv.customValue.toFixed(2)} (+${bonus.toFixed(2)})`);
        openCharaDetail(id); renderZukan(); updateTitleInfo();
    }

    function executeReincarnation() {
        const id = viewingCharaId; const char = rawData.characters.find(c => c.id == id); const inv = gameState.charaInventory[id]; if (!inv) return;
        if (gameState.xp < REBORN_COST_XP) return alert(`EXPãŒè¶³ã‚Šã¾ã›ã‚“ (å¿…è¦: ${REBORN_COST_XP})`);
        if (!confirm(`ã€è»¢ç”Ÿç¢ºèªã€‘\næ¶ˆè²»: ${REBORN_COST_XP} EXP\n\nãƒ»ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã¨åŸºç¤å€¤ãŒåˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™\nãƒ»ãƒ¬ãƒ™ãƒ«ã¯0ã«æˆ»ã‚Šã¾ã™\nãƒ»ç¿’å¾—ã—ãŸã‚¹ã‚­ãƒ«ã¯å¼•ãç¶™ãã¾ã™\nãƒ»è»¢ç”Ÿå›æ•°ãŒå¢—ãˆã€åå‰ã«ğŸª½ãŒã¤ãã¾ã™\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;
        gameState.xp -= REBORN_COST_XP;
        inv.currentRarity = char.rarity; inv.customValue = Number(char.value); inv.level = 1; inv.exp = 0;
        inv.reincarnationCount = (inv.reincarnationCount || 0) + 1; inv.isEvolved = false;
        saveGame(); playSE('start'); alert("è»¢ç”Ÿå®Œäº†ï¼\nå¼·ãã¦ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ã®å§‹ã¾ã‚Šã§ã™ï¼"); openCharaDetail(id); renderZukan(); updateTitleInfo();
    }

    function nextQuestion() {
        if(!isGameActive) return;
        if(playData.qIndex >= playData.questions.length) { playData.questions.sort(()=>Math.random()-0.5); playData.qIndex = 0; }
        const q = playData.questions[playData.qIndex]; playData.currentQ = q;
        document.getElementById('ui-question').innerText = q.q;
        const choices = [...q.choices].sort(() => Math.random() - 0.5);
        const div = document.getElementById('ui-choices'); div.innerHTML = '';
        choices.forEach(c => { const btn = document.createElement('button'); btn.className = 'choice-btn'; btn.innerText = c; btn.onclick = () => judge(String(c) === String(q.a), btn); div.appendChild(btn); });
        startTimer();
    }

    function startTimer() { if(gameState.timer) clearInterval(gameState.timer); if(!isGameActive) return; gameState.timeLeft = gameState.maxTime; const bar = document.getElementById('ui-timer'); gameState.timer = setInterval(() => { if(isPaused || !isGameActive) return; gameState.timeLeft -= 0.1; bar.style.width = (gameState.timeLeft / gameState.maxTime * 100) + '%'; document.getElementById('ui-timer-text').innerText = Math.max(0, gameState.timeLeft).toFixed(1); if(gameState.timeLeft <= 0) { clearInterval(gameState.timer); judge(false, null); } }, 100); }
    
    function judge(isCorrect, btn) {
        if(isPaused || !isGameActive) return;
        clearInterval(gameState.timer);
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
        if(btn) btn.classList.add(isCorrect ? 'btn-correct' : 'btn-wrong');
        
        if(!isCorrect) {
            playSE('miss');
            if (playData.currentQ && playData.currentQ.id) {
                if (!gameState.revengeList) gameState.revengeList = [];
                if (!gameState.revengeList.includes(playData.currentQ.id)) { gameState.revengeList.push(playData.currentQ.id); saveGame(); }
            }
            document.querySelectorAll('.choice-btn').forEach(b => { if(String(b.innerText) === String(playData.currentQ.a)) b.classList.add('btn-miss-answer'); });
        }

        if (playData.currentQ && playData.currentQ.subject) {
            const subj = playData.currentQ.subject;
            if (!gameState.subjectStats[subj]) gameState.subjectStats[subj] = { correct: 0, total: 0 };
            gameState.subjectStats[subj].total++;
            if (isCorrect) gameState.subjectStats[subj].correct++;
        }

        if(isCorrect) {
            playSE('hit');
            if (playData.isRevenge && playData.currentQ && playData.currentQ.id) { gameState.revengeList = gameState.revengeList.filter(id => String(id) !== String(playData.currentQ.id)); saveGame(); }
            document.querySelectorAll('.choice-btn').forEach(b => { if(String(b.innerText) === String(playData.currentQ.a)) b.classList.add('btn-miss-answer'); });
            
            let damage = 0;
            if (playData.isRevenge) { damage = Math.ceil(gameState.maxHP / playData.questions.length); } 
            else {
                // --- ãƒãƒ©ãƒ³ã‚¹èª¿æ•´(Ver 7.2) ---
                const stats = getCharaStats();
                
                // 1. åŸºç¤æ”»æ’ƒåŠ›
                const baseAtk = 100;
                
                // 2. æ™‚é–“ä¿‚æ•° (0.2 ~ 1.0)
                // é…ã‚Œã‚‹ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸å…¨ä½“ãŒæ¸›å°‘ã™ã‚‹ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ€§é‡è¦–ï¼‰
                const rawRatio = gameState.timeLeft / gameState.maxTime;
                const timeFactor = 0.2 + (rawRatio * 0.8);

                // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è£œæ­£ (ATKãã®ã¾ã¾, TIMEã¯ä¿‚æ•°0.5)
                // ä¾‹: ATK2.8 => 2.8, TIME2.8 => 1.9
                const statFactor = stats.atk + ((stats.time - 1) * 0.5);

                // 4. ã‚³ãƒ³ãƒœè£œæ­£ (2.5%/å›, æœ€å¤§1.0)
                // 40ã‚³ãƒ³ãƒœã§æœ€å¤§è£œæ­£(+100%)ã«åˆ°é”
                const comboAdd = Math.min(gameState.combo * 0.025, 1.0);

                // æœ€çµ‚è¨ˆç®—: åŸºç¤æ”»æ’ƒåŠ› Ã— æ™‚é–“ä¿‚æ•° Ã— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ + ã‚³ãƒ³ãƒœ)
                damage = Math.floor(baseAtk * timeFactor * (statFactor + comboAdd));
            }
            gameState.enemyHP = Math.max(0, gameState.enemyHP - damage);
            gameState.score += damage; gameState.combo++;
            showCutIn("-" + damage);
            gameState.stats.totalCorrect = (gameState.stats.totalCorrect || 0) + 1;
            gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo || 0, gameState.combo);
            if ((gameState.maxTime - gameState.timeLeft) <= 1.0) { gameState.stats.achieved_speed = true; saveGame(); }
            const enemyIcon = document.getElementById('ui-enemy-icon');
            enemyIcon.classList.remove('shake-anim'); void enemyIcon.offsetWidth; enemyIcon.classList.add('shake-anim');
            updateMissionProgress('correct', 1); updateMissionProgress('maxCombo', gameState.combo);
            updateUI();
            
            if(gameState.enemyHP <= 0) {
                const enemyBox = document.querySelector('.enemy-visual-box');
                enemyBox.classList.add('anim-paused'); enemyBox.classList.add('fade-out');
                setTimeout(() => isGameActive && finishGame(true), 1200);
            } else { playData.qIndex++; setTimeout(() => isGameActive && nextQuestion(), 1000); }
        } else {
            gameState.lives--; gameState.combo = 0; showCutIn("MISS..."); updateUI();
            if(gameState.lives <= 0) { setTimeout(() => isGameActive && finishGame(false), 1500); } 
            else { setTimeout(() => { if(!isGameActive) return; if(playData.isTyping) nextTypingQuestion(); else nextQuestion(); }, 1500); }
        }
    }
    
    function showCutIn(t) { const d = document.createElement('div'); d.className='cutin'; d.innerText=t; if(String(t).includes('MISS')) { d.style.color='#bdc3c7'; d.style.webkitTextStroke='2px #2c3e50'; } document.body.appendChild(d); setTimeout(()=>d.remove(), 1500); }
    function updateUI() { document.getElementById('ui-life').innerText = 'â¤ï¸'.repeat(Math.max(0, gameState.lives)); document.getElementById('ui-score').innerText = gameState.score; document.getElementById('ui-combo').innerText = gameState.combo; document.getElementById('ui-hp').style.width = (gameState.enemyHP/gameState.maxHP*100)+'%'; document.getElementById('ui-hp-text').innerText = `${gameState.enemyHP}/${gameState.maxHP}`; }
    
    function togglePause() { 
        isPaused = !isPaused; document.getElementById('pause-overlay').classList.toggle('hidden', !isPaused);
        if(isPaused) {
            const infoBox = document.getElementById('pause-chara-info');
            const charaId = gameState.equipped;
            const chara = rawData.characters ? rawData.characters.find(c => c.id == charaId) : null;
            if(chara) {
                const inv = gameState.charaInventory[charaId] || { level: 1 };
                const baseVal = (inv.isEvolved && inv.customValue) ? inv.customValue : chara.value;
                const r = inv.currentRarity || chara.rarity;
                const name = getDisplayName(chara, inv);
                let val = Number(baseVal) + (inv.level * LV_BONUS_RATE);
                let visual = "";
                if(chara.imageUrl && chara.imageUrl.startsWith('http')) visual = `<img src="${chara.imageUrl}" style="width:60px;height:60px;object-fit:contain;background:#fff;border-radius:5px;">`; else visual = `<div style="font-size:40px;">âœï¸</div>`;
                infoBox.innerHTML = `<div style="display:flex; align-items:center; gap:10px; text-align:left;">${visual}<div><div style="font-weight:bold; color:#ecf0f1; font-size:0.9em;">${name}</div><div style="color:#f39c12; font-weight:bold; font-size:0.8em;">Lv.${inv.level}</div><div style="font-size:0.7em; color:#bdc3c7;"><span class="rarity-${r}" style="font-weight:bold; font-size:1.2em; margin-right:5px;">${r}</span>åŠ¹æœ: x${val.toFixed(2)}</div></div></div>`;
            } else { infoBox.innerHTML = `<div style="color:#bdc3c7; font-size:0.8em;">è£…å‚™ãªã—</div>`; }
        }
    }
    
    function resumeGame() { isPaused = false; document.getElementById('pause-overlay').classList.add('hidden'); }
    function retryGame() { if(confirm("ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")){ isGameActive=false; clearInterval(gameState.timer); resumeGame(); startGame(); } }
    function backToTitleFromPause() { if(confirm("æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")){ isGameActive=false; clearInterval(gameState.timer); backToTitle(); } }
    
    function finishGame(isClear) { 
        isGameActive=false; clearInterval(gameState.timer); 
        document.removeEventListener('keydown', handleTypingInput);
        stopBGM();

        let dropInfo = { count: 0, icon: '' };
        if(isClear) {
            playSE('win');
            const eqInv = gameState.charaInventory[gameState.equipped];
            if (eqInv) {
                eqInv.exp = (Number(eqInv.exp) || 0) + 1;
                const cMaster = rawData.characters.find(c => c.id == gameState.equipped);
                const maxL = RARITY_CAPS[eqInv.currentRarity || cMaster.rarity] || 10;
                if (eqInv.exp >= EXP_REQ && eqInv.level < maxL) { eqInv.exp -= EXP_REQ; eqInv.level++; }
            }
            if (!playData.isRevenge) {
                const subj = (playData.context ? playData.context.subject : "") || "";
                let dType = "";
                if (["å›½èª", "ç¤¾ä¼š", "è‹±èª"].some(k => subj.includes(k))) dType = "red";
                else if (["ç®—æ•°", "æ•°å­¦", "ç†ç§‘"].some(k => subj.includes(k))) dType = "blue";
                else dType = Math.random() < 0.5 ? "red" : "blue";
                const dCount = Math.floor(Math.random() * 4) + 2; 
                if (dType === "red") { gameState.inventory.redPages += dCount; dropInfo = { count: dCount, icon: 'ğŸ“•' }; }
                else { gameState.inventory.bluePages += dCount; dropInfo = { count: dCount, icon: 'ğŸ“˜' }; }
            }
        } else playSE('lose');

        const stats=getCharaStats(); 
        let conditionRate = 1.0;
        const CAMPAIGN_RATE = 3.0;
        let isCampaign = false;
        if (playData.context && rawData.config && !playData.isRevenge && !playData.isRandom && !playData.isTyping) { isCampaign = rawData.config.some(c => c.message && c.message !== "" && String(c.grade) === String(playData.context.grade) && String(c.subject) === String(playData.context.subject) && String(c.unit) === String(playData.context.unit)); }
        if (playData.activeOaths && playData.activeOaths.length > 0) { const count = playData.activeOaths.length; if (count >= 3) conditionRate = 2.0; else if (count === 2) conditionRate = 1.75; else conditionRate = 1.5; if (isCampaign) conditionRate = Math.max(conditionRate, CAMPAIGN_RATE); }
        else if (playData.isRevenge || playData.isRandom) { conditionRate = 1.5; }
        else if (isCampaign) { conditionRate = CAMPAIGN_RATE; }

        const partA = gameState.score * stats.exp;
        const partB = isClear ? (gameState.score * 0.2) : 0;
        const partC = gameState.score * (conditionRate - 1.0);
        let earned = Math.floor(partA + partB + partC);
        gameState.xp += earned; 
        
        if (playData.context && !playData.isRevenge && !playData.isRandom) {
            const key = `${playData.context.grade}_${playData.context.subject}_${playData.context.unit}`;
            if (!gameState.unitProgress) gameState.unitProgress = {};
            if (!gameState.unitProgress[key]) gameState.unitProgress[key] = { played: false, cleared: false };
            gameState.unitProgress[key].played = true;
            if (isClear) gameState.unitProgress[key].cleared = true;
        }
        
        gameState.stats.totalPlay = (gameState.stats.totalPlay || 0) + 1;
        if(isClear) {
            gameState.stats.totalKill = (gameState.stats.totalKill || 0) + 1;
            let requiredLives = 3; if (playData.activeOaths && playData.activeOaths.includes('backwater')) requiredLives = 1;
            if(gameState.lives >= requiredLives) { gameState.stats.achieved_perfect = true; saveGame(); }
            if (playData.isRevenge) gameState.revengeList = [];
        }

        saveGame(); 
        updateMissionProgress('play',1); if(isClear) updateMissionProgress('kill',1); 
        document.getElementById('res-title').innerText=isClear?"QUEST CLEAR!":"GAME OVER"; 
        document.getElementById('res-icon').innerText=isClear?"ğŸ‰":"ğŸ’”"; 
        document.getElementById('res-title').style.color=isClear?"#f1c40f":"#bdc3c7"; 
        document.getElementById('res-score').innerText=gameState.score; 
        
        const dropText = dropInfo.count > 0 ? `<div style="font-size:0.4em; color:#2c3e50; margin-top:5px;">å…¥æ‰‹: ${dropInfo.icon} Ã— ${dropInfo.count}</div>` : "";
        
        if (isCampaign && isClear) { document.getElementById('res-xp').innerHTML = `<span style="font-size:0.5em; color:#e74c3c;">CAMPAIGN x3.0</span><br>+${earned}${dropText}`; } 
        else { document.getElementById('res-xp').innerHTML = "+" + earned + dropText; }

        document.getElementById('game-screen').classList.add('hidden'); 
        document.getElementById('result-overlay').classList.remove('hidden'); 
        checkTitles();
    }
    
    function backToTitle() { 
        document.getElementById('result-overlay').classList.add('hidden'); 
        document.getElementById('game-screen').classList.add('hidden'); 
        document.getElementById('title-screen').classList.remove('hidden'); 
        document.getElementById('pause-overlay').classList.add('hidden'); 
        if (countdownTimer) clearInterval(countdownTimer);
        clearInterval(gameState.timer); 
        isGameActive = false; isPaused = false; 
        document.removeEventListener('keydown', handleTypingInput);
        document.getElementById('ui-choices').classList.remove('hidden');
        document.getElementById('ui-typing-area').classList.add('hidden');
        document.getElementById('ui-question').classList.remove('hidden');
        playData.isTyping = false; 
        stopBGM();
        updateTitleInfo(); updateMissionBadge(); checkTitles();
    }
    
    function checkLoginBonus() { 
        const d=new Date().toLocaleDateString('ja-JP'); 
        if(localStorage.getItem('sq_last_login')!==d){ 
            gameState.xp+=LOGIN_BONUS_EXP; localStorage.setItem('sq_last_login',d); 
            gameState.stats.loginDays = (gameState.stats.loginDays || 0) + 1;
            saveGame(); document.getElementById('login-bonus-overlay').classList.remove('hidden'); updateTitleInfo(); checkTitles();
        } 
    }
    function closeLoginBonus() { document.getElementById('login-bonus-overlay').classList.add('hidden'); }
    function checkMissionDate() { const d=new Date().toLocaleDateString('ja-JP'); dailyMissions=JSON.parse(localStorage.getItem('sq_missions')||'{"date":"","progress":{},"claimed":{}}'); if(dailyMissions.date!==d){ dailyMissions={date:d,progress:{play:0,kill:0,correct:0,maxCombo:0,enhance:0},claimed:{}}; saveGame(); } updateMissionBadge(); }
    function updateMissionProgress(t,v) { if(t==='maxCombo') dailyMissions.progress[t]=Math.max(dailyMissions.progress[t]||0,v); else dailyMissions.progress[t]=(dailyMissions.progress[t]||0)+v; saveGame(); updateMissionBadge(); }
    function updateMissionBadge() { let c=0; MISSIONS.forEach(m=>{ if((dailyMissions.progress[m.id]||0)>=m.target && !dailyMissions.claimed[m.id]) c++; }); document.getElementById('mission-badge').classList.toggle('hidden', c===0); }
    
    function openMissions() { document.getElementById('mission-overlay').classList.remove('hidden'); renderMissions(); }
    function closeMissions() { document.getElementById('mission-overlay').classList.add('hidden'); }
    function renderMissions() { const l=document.getElementById('mission-list'); l.innerHTML=''; let all=true; MISSIONS.forEach(m=>{ const p=dailyMissions.progress[m.id]||0; const fin=p>=m.target; const clm=dailyMissions.claimed[m.id]; if(!fin)all=false; l.innerHTML+=`<div class="mission-item"><b>${m.title}</b> (${p}/${m.target})<br><small>${m.desc}</small><button class="mission-btn ${fin&&!clm?'active':'disabled'}" onclick="claimMission('${m.id}',${m.reward})">${clm?'å—å–æ¸ˆ':'å—å–'}</button></div>`; }); 
        const ac=document.getElementById('mission-all-clear'); if(all){ 
            const isClaimed = dailyMissions.claimed.allClear;
            let btnStyle = isClaimed ? '' : 'background:#f1c40f; border-color:#d35400;'; 
            let btnClass = isClaimed ? 'disabled' : ''; 
            let btnText = isClaimed ? 'å—å–æ¸ˆ' : `${MISSION_ALL_CLEAR} EXPã‚’å—ã‘å–ã‚‹`;
            let btnAction = isClaimed ? '' : 'onclick="claimAllClear()"';
            l.innerHTML += `<div style="margin-top:10px; padding:10px; background:#fef5e7; border:2px solid #e67e22; border-radius:10px;"><div style="font-weight:bold; color:#e67e22;">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå ±é…¬</div><button class="mission-btn ${btnClass}" style="width:100%; margin-top:5px; ${btnStyle}" ${btnAction}>${btnText}</button></div>`; 
        } 
    }
    function claimMission(id,r) { if(dailyMissions.claimed[id])return; dailyMissions.claimed[id]=true; gameState.xp+=r; saveGame(); renderMissions(); updateTitleInfo(); updateMissionBadge(); alert(r+"EXPç²å¾—"); }
    function claimAllClear() { if(dailyMissions.claimed.allClear)return; dailyMissions.claimed.allClear=true; gameState.xp+=MISSION_ALL_CLEAR; saveGame(); renderMissions(); updateTitleInfo(); updateMissionBadge(); alert(MISSION_ALL_CLEAR+"EXPç²å¾—"); }

    function openGacha() { document.getElementById('gacha-overlay').classList.remove('hidden'); document.getElementById('gacha-xp').innerText=gameState.xp; renderZukan(); }
    function closeGacha() { document.getElementById('gacha-overlay').classList.add('hidden'); updateTitleInfo(); }
    
    function rollGacha(count) {
        const cost = 3000 * count;
        if (gameState.xp < cost) return alert("EXPãŒè¶³ã‚Šã¾ã›ã‚“ï¼\nå¿…è¦: " + cost + " EXP");
        gameState.xp -= cost;
        let results = [];
        for (let i = 0; i < count; i++) {
            let rand = Math.random(), rarity = 'N';
            if (rand < 0.01) rarity = 'UR'; else if (rand < 0.04) rarity = 'SSR'; else if (rand < 0.15) rarity = 'SR'; else if (rand < 0.45) rarity = 'R';
            let targets = rawData.characters.filter(c => c.rarity === rarity);
            if (targets.length === 0) targets = rawData.characters;
            const hit = targets[Math.floor(Math.random() * targets.length)];
            if (!gameState.charaInventory[hit.id]) { gameState.charaInventory[hit.id] = { level: 0, count: 0, exp: 0 }; results.push({ char: hit, isNew: true }); } 
            else { gameState.charaInventory[hit.id].count++; results.push({ char: hit, isNew: false }); }
        }
        saveGame(); renderZukan(); updateTitleInfo(); checkTitles(); showGachaResults(results);
    }

    function rollGuaranteedTenGacha(guaranteedRarity, cost) {
        if (gameState.xp < cost) return alert("XPãŒè¶³ã‚Šã¾ã›ã‚“ï¼\nå¿…è¦: " + cost + " EXP");
        if (!confirm(`ã€ç¢ºèªã€‘\n${cost} EXPã‚’æ¶ˆè²»ã—ã¦ã€\n${guaranteedRarity}ä»¥ä¸Šç¢ºå®š10é€£ã‚¹ã‚«ã‚¦ãƒˆã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ`)) return;
        gameState.xp -= cost; let results = [];
        const addResult = (char) => { if (!gameState.charaInventory[char.id]) { gameState.charaInventory[char.id] = { level: 0, count: 0, exp: 0 }; results.push({ char: char, isNew: true }); } else { gameState.charaInventory[char.id].count++; results.push({ char: char, isNew: false }); } };
        for (let i = 0; i < 9; i++) {
            let rand = Math.random(); let r = 'N';
            if (rand < 0.003) r = 'UR'; else if (rand < 0.033) r = 'SSR'; else if (rand < 0.133) r = 'SR'; else if (rand < 0.433) r = 'R';
            let targets = rawData.characters.filter(c => c.rarity === r); if (targets.length === 0) targets = rawData.characters; 
            const hit = targets[Math.floor(Math.random() * targets.length)]; addResult(hit);
        }
        let guaranteedTargets = []; if (guaranteedRarity === 'UR') { guaranteedTargets = rawData.characters.filter(c => c.rarity === 'UR'); } else { guaranteedTargets = rawData.characters.filter(c => c.rarity === 'SSR'); }
        if (guaranteedTargets.length === 0) guaranteedTargets = rawData.characters;
        const finalHit = guaranteedTargets[Math.floor(Math.random() * guaranteedTargets.length)]; addResult(finalHit);
        saveGame(); renderZukan(); updateTitleInfo(); checkTitles(); playSE('win'); showGachaResults(results);
    }

    function showGachaResults(results) {
        const container = document.getElementById('gr-container');
        if(results.length === 1) {
            const r = results[0]; let visual = (r.char.imageUrl && r.char.imageUrl.startsWith('http')) ? `<img src="${r.char.imageUrl}" style="width:120px;height:120px;">` : `<div style="font-size:80px;">ğŸ“¦</div>`;
            container.innerHTML = `<div class="gacha-result-card">${r.isNew?'<div class="gr-new">NEW!</div>':''}<div class="gr-rarity rarity-${r.char.rarity}">â˜… ${r.char.rarity}</div>${visual}<div style="font-weight:bold;font-size:1.5em;">${r.char.name}</div><div style="color:#7f8c8d;">${r.isNew?'æ–°è¦å…¥æ‰‹':'åœ¨åº«(ç´ æ)+1'}</div></div>`; 
        } else { 
            let html = '<h3 style="color:#f1c40f;">10é€£çµæœ!</h3><div class="gr-grid">'; 
            results.forEach(r => { let visual = (r.char.imageUrl && r.char.imageUrl.startsWith('http')) ? `<img src="${r.char.imageUrl}" class="gr-mini-img">` : `<div style="font-size:30px;">ğŸ“¦</div>`; html += `<div class="gr-mini-card">${r.isNew?'<div class="gr-mini-new">NEW</div>':''}<div class="rarity-${r.char.rarity}" style="font-size:0.8em;">${r.char.rarity}</div>${visual}<div style="font-size:0.7em;font-weight:bold;">${r.char.name}</div></div>`; }); 
            container.innerHTML = html + '</div>'; 
        }
        document.getElementById('gacha-overlay').classList.add('hidden'); document.getElementById('gacha-result-overlay').classList.remove('hidden');
    }
    function closeGachaResult() { document.getElementById('gacha-result-overlay').classList.add('hidden'); document.getElementById('gacha-overlay').classList.remove('hidden'); document.getElementById('gacha-xp').innerText = gameState.xp; renderZukan(); }

    let zukanSortMode = 'default';
    function changeZukanSort() { const sel = document.getElementById('zukan-sort-select'); if(sel) zukanSortMode = sel.value; renderZukan(); }

    function renderZukan() { 
        const g=document.getElementById('zukan-grid'); g.innerHTML=''; 
        if(!rawData.characters) return;
        let list = [...rawData.characters];
        list.sort((a, b) => {
            const invA = gameState.charaInventory[a.id]; const invB = gameState.charaInventory[b.id];
            if (zukanSortMode === 'rarity_desc' || zukanSortMode === 'rarity_asc') { const rOrder = { 'UR':5, 'SSR':4, 'SR':3, 'R':2, 'N':1 }; const valA = rOrder[a.rarity] || 0; const valB = rOrder[b.rarity] || 0; return zukanSortMode === 'rarity_desc' ? valB - valA : valA - valB; }
            if (zukanSortMode === 'type') { return a.type.localeCompare(b.type); }
            if (zukanSortMode === 'level') { const lvA = invA ? invA.level : -1; const lvB = invB ? invB.level : -1; if (lvA !== lvB) return lvB - lvA; }
            if (zukanSortMode === 'stock') { const cntA = invA ? invA.count : -1; const cntB = invB ? invB.count : -1; if (cntA !== cntB) return cntB - cntA; }
            return 0;
        });
        list.forEach(c=>{ 
            const data = gameState.charaInventory[c.id]; const isOwned = !!data; const div = document.createElement('div');
            let masterClass = ''; if (isOwned && data.count >= MASTER_COUNT) masterClass = 'mastered';
            div.className = `char-card ${isOwned?'owned':''} ${gameState.equipped==c.id?'active':''} ${masterClass}`;
            let visual, nameText, lvlBadge = '', stockBadge = ''; let decoName = "???"; 
            if(isOwned) {
                visual = (c.imageUrl && c.imageUrl.startsWith('http')) ? `<img src="${c.imageUrl}" class="char-img">` : `<div style="font-size:2em;line-height:50px">ğŸ“¦</div>`;
                const currentRarity = data.currentRarity || c.rarity; decoName = getDisplayName(c, data); nameText = `<span class="rarity-${currentRarity}">${currentRarity}</span> / ${c.type}`;
                lvlBadge = `<div class="char-lvl-badge">Lv.${data.level}</div>`; if(data.count > 0) stockBadge = `<div class="char-stock-badge">+${data.count}</div>`;
                div.onclick = () => openCharaDetail(c.id);
            } else { visual = `<div style="font-size:2em;line-height:50px;color:#bdc3c7;">?</div>`; nameText = "???"; }
            div.innerHTML = `${lvlBadge}${stockBadge}${visual}<div style="font-weight:bold;font-size:0.8em;">${nameText}</div><div style="font-size:0.7em; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${decoName}</div>`;
            g.appendChild(div);
        });
    }

    function openCharaDetail(id) { 
        viewingCharaId=id; const c=rawData.characters.find(x=>x.id==id); const o=gameState.charaInventory[id]; if(!c||!o)return; 
        const currentR = o.currentRarity || c.rarity; const currentSkills = (o.skills && o.skills.length > 0) ? o.skills : [c.type];
        const baseVal = (o.isEvolved && o.customValue) ? o.customValue : Number(c.value);
        document.getElementById('cd-name').innerHTML = getDisplayName(c, o);
        document.getElementById('cd-rarity').innerText = currentR; document.getElementById('cd-rarity').className = "rarity-" + currentR; 
        const maxLv = RARITY_CAPS[currentR] || 10;
        document.getElementById('cd-lv').innerText = 'Lv.' + o.level + ' / ' + maxLv;
        let skillHtml = ''; currentSkills.forEach(s => { skillHtml += `<span class="skill-tag ${s}">${s}</span>`; });
        document.getElementById('cd-type').innerHTML = `<div class="skill-tag-container">${skillHtml}</div>`;
        let val = baseVal + (o.level * LV_BONUS_RATE); document.getElementById('cd-val').innerText='x'+val.toFixed(2); 
        document.getElementById('cd-stock').innerText=o.count + "å€‹"; document.getElementById('cd-desc').innerText = c.desc || "";
        
        const detailBtnRow = document.querySelector('.detail-btn-row');
        if (document.querySelector('.item-use-area')) document.querySelector('.item-use-area').remove();
        detailBtnRow.insertAdjacentHTML('beforebegin', `<div class="item-use-area"><div style="font-weight:bold; font-size:0.8em; color:#2c3e50; margin-bottom:5px;">è‚²æˆã‚¢ã‚¤ãƒ†ãƒ </div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;"><button class="book-use-btn" onclick="useExpItem('xpBookSmall', 200)" ${(gameState.inventory.xpBookSmall||0)>0?'':'disabled'}>å°(${gameState.inventory.xpBookSmall||0})</button><button class="book-use-btn" onclick="useExpItem('xpBookMedium', 500)" ${(gameState.inventory.xpBookMedium||0)>0?'':'disabled'}>ä¸­(${gameState.inventory.xpBookMedium||0})</button><button class="book-use-btn" onclick="useExpItem('xpBookLarge', 1000)" ${(gameState.inventory.xpBookLarge||0)>0?'':'disabled'}>å¤§(${gameState.inventory.xpBookLarge||0})</button></div></div>`);
        
        document.getElementById('cd-exp-text').innerText = o.exp + ' / ' + EXP_REQ; document.getElementById('cd-exp-bar').style.width = (o.exp / EXP_REQ * 100) + '%';
        if(c.imageUrl.startsWith('http')) document.getElementById('cd-img').src=c.imageUrl; else document.getElementById('cd-img').src=''; 
        document.getElementById('chara-detail-overlay').classList.remove('hidden'); 
        
        const evoContainer = document.getElementById('evo-container'); evoContainer.innerHTML = ''; evoContainer.classList.add('hidden');
        if (o.level >= maxLv && o.count >= EVO_STOCK_REQ && currentR !== 'UR') {
            const cost = EVO_COST_XP[currentR]; const btn = document.createElement('button'); btn.className = 'detail-btn'; btn.style.background = 'linear-gradient(to bottom, #f1c40f, #e67e22)'; btn.style.borderBottom = '5px solid #d35400'; btn.style.marginBottom = '10px'; btn.style.height = '60px'; 
            btn.innerHTML = `ğŸŒŸ é™ç•Œçªç ´ãƒ»é€²åŒ–ï¼<br><span style="font-size:0.75em">æ¶ˆè²»: ${cost.toLocaleString()} XP ï¼ ç´ æ ${EVO_STOCK_REQ}å€‹</span>`; btn.onclick = executeEvolution; evoContainer.appendChild(btn); evoContainer.classList.remove('hidden');
        }
        if (currentR === 'UR' && c.rarity !== 'UR') {
            const btn = document.createElement('button'); btn.className = 'detail-btn'; btn.style.background = 'linear-gradient(to right, #3498db, #8e44ad)'; btn.style.borderBottom = '5px solid #5b2c6f'; btn.style.marginBottom = '10px'; btn.style.height = '60px';
            btn.innerHTML = `ğŸª½ è»¢ç”Ÿã™ã‚‹<br><span style="font-size:0.75em">æ¶ˆè²»: ${REBORN_COST_XP.toLocaleString()} XP ï¼ ã‚¹ã‚­ãƒ«ç¶™æ‰¿</span>`; btn.onclick = executeReincarnation; evoContainer.appendChild(btn); evoContainer.classList.remove('hidden');
        }
    }
    
    function closeCharaDetail() { document.getElementById('chara-detail-overlay').classList.add('hidden'); renderZukan(); }
    function equipCurrentChara() { gameState.equipped=viewingCharaId; saveGame(); alert("è£…å‚™ã—ã¾ã—ãŸ"); closeCharaDetail(); renderZukan(); updateTitleInfo(); }
    function sellCharaStock() { const o=gameState.charaInventory[viewingCharaId]; if(o.count>0 && confirm("å£²å´ã—ã¾ã™ã‹ï¼Ÿ")){ o.count--; gameState.xp+=200; saveGame(); openCharaDetail(viewingCharaId); } }
    
    function useExpItem(itemId, gain) {
        if ((gameState.inventory[itemId] || 0) <= 0) return;
        
        // --- ä¿®æ­£: ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¿½åŠ  ---
        const itemNames = { 'xpBookSmall':'å°ã®æ›¸', 'xpBookMedium':'ä¸­ã®æ›¸', 'xpBookLarge':'å¤§ã®æ›¸' };
        const itemName = itemNames[itemId] || 'çµŒé¨“å€¤ã‚¢ã‚¤ãƒ†ãƒ ';
        if (!confirm(`ã€ç¢ºèªã€‘\n${itemName} ã‚’ä½¿ç”¨ã—ã¦ã€çµŒé¨“å€¤ã‚’ +${gain} ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        const inv = gameState.charaInventory[viewingCharaId];
        const master = rawData.characters.find(c => c.id == viewingCharaId);
        const maxL = RARITY_CAPS[inv.currentRarity || master.rarity] || 10;
        
        if (inv.level >= maxL) return alert("Lv.MAXã§ã™");

        gameState.inventory[itemId]--;
        inv.exp = (Number(inv.exp) || 0) + gain;
        
        let lvUp = 0;
        while (inv.exp >= EXP_REQ && inv.level < maxL) { 
            inv.exp -= EXP_REQ; 
            inv.level++; 
            lvUp++;
        }
        if (inv.level >= maxL) inv.exp = 0;
        
        saveGame(); 
        playSE('start'); 
        if (lvUp > 0) alert(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${inv.level}`);
        openCharaDetail(viewingCharaId);
    }

    let selectedMaterials = {};
    function openEnhanceMenu() { selectedMaterials = {}; document.getElementById('material-select-overlay').classList.remove('hidden'); document.getElementById('chara-detail-overlay').classList.add('hidden'); renderEnhanceList(); }
    function closeEnhanceMenu() { document.getElementById('material-select-overlay').classList.add('hidden'); openCharaDetail(viewingCharaId); }

    function renderEnhanceList() {
        const list = document.getElementById('material-list'); list.innerHTML = ''; let totalGain = 0;
        rawData.characters.forEach(c => {
            if (c.id === viewingCharaId) return; const inv = gameState.charaInventory[c.id]; if (!inv || inv.count <= 0) return;
            const selectCount = selectedMaterials[c.id] || 0; const expVal = MAT_EXP[c.rarity] || 25; if(selectCount > 0) totalGain += (expVal * selectCount);
            let visual = (c.imageUrl && c.imageUrl.startsWith('http')) ? `<img src="${c.imageUrl}" style="width:40px;height:40px;">` : `<span>ğŸ“¦</span>`;
            let activeClass = selectCount > 0 ? 'selected' : ''; let badge = selectCount > 0 ? `<div class="mat-select-badge">${selectCount}</div>` : '';
            list.innerHTML += `<div class="mat-card ${activeClass}" onclick="toggleMaterial('${c.id}', ${inv.count})">${badge}<div class="rarity-${c.rarity}">${c.rarity}</div>${visual}<div style="font-weight:bold; font-size:0.8em; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.name}</div><div style="font-size:0.7em;">æ‰€æŒ: ${inv.count}</div><div class="mat-exp-val">+${expVal}</div></div>`;
        });
        updateEnhancePreview(totalGain);
    }

    function toggleMaterial(id, maxCount) { if (!selectedMaterials[id]) selectedMaterials[id] = 0; selectedMaterials[id]++; if (selectedMaterials[id] > maxCount) { selectedMaterials[id] = 0; } renderEnhanceList(); }

    function updateEnhancePreview(gainExp) {
        document.getElementById('enhance-total-exp').innerText = gainExp;
        const t = gameState.charaInventory[viewingCharaId]; const chara = rawData.characters.find(x => x.id === viewingCharaId); if (!t || !chara) return;
        const currentR = t.currentRarity || chara.rarity; const maxLv = RARITY_CAPS[currentR] || 10;
        let simExp = t.exp + gainExp; let simLv = t.level;
        while (simExp >= EXP_REQ) { if (simLv >= maxLv) { simExp = 0; break; } simExp -= EXP_REQ; simLv++; }
        const preview = document.getElementById('enhance-lv-preview');
        if (simLv > t.level) { preview.innerHTML = `Lv.${t.level} <span style="font-weight:bold;">â ${simLv}</span>`; preview.style.color = '#e67e22'; } else { preview.innerText = `Lv.${t.level} (ã‚ã¨${EXP_REQ - simExp})`; preview.style.color = '#7f8c8d'; }
    }

    function executeBulkEnhance() {
        const totalSelected = Object.values(selectedMaterials).reduce((a, b) => a + b, 0); if (totalSelected === 0) return alert("ç´ æã‚’é¸æŠã—ã¦ãã ã•ã„");
        let totalGain = 0; Object.keys(selectedMaterials).forEach(id => { const count = selectedMaterials[id]; if (count > 0) { const matChar = rawData.characters.find(c => c.id === id); const expVal = MAT_EXP[matChar.rarity] || 25; totalGain += (expVal * count); } });
        if (!confirm(`é¸æŠã—ãŸ${totalSelected}ä½“ã‚’æ¶ˆè²»ã—ã¦å¼·åŒ–ã—ã¾ã™ã‹ï¼Ÿ\nç²å¾—EXP: ${totalGain}`)) return;
        Object.keys(selectedMaterials).forEach(id => { const count = selectedMaterials[id]; if (gameState.charaInventory[id]) { gameState.charaInventory[id].count -= count; if (gameState.charaInventory[id].count < 0) gameState.charaInventory[id].count = 0; } });
        const t = gameState.charaInventory[viewingCharaId]; const chara = rawData.characters.find(x => x.id === viewingCharaId);
        const currentR = t.currentRarity || chara.rarity; const maxLv = RARITY_CAPS[currentR] || 10;
        t.exp = (Number(t.exp) || 0) + totalGain; let lvUpCount = 0;
        while (t.exp >= EXP_REQ) { if (t.level >= maxLv) { t.exp = 0; break; } t.exp -= EXP_REQ; t.level++; lvUpCount++; }
        updateMissionProgress('enhance', 1); checkTitles(); saveGame();
        alert(`å¼·åŒ–å®Œäº†ï¼\nçµŒé¨“å€¤ +${totalGain} ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚${lvUpCount > 0 ? '\nãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸï¼' : ''}`);
        selectedMaterials = {}; renderEnhanceList(); updateEnhancePreview(0);
        if(chara) {
            document.getElementById('cd-lv').innerText = 'Lv.' + t.level + ' / ' + maxLv; document.getElementById('cd-exp-text').innerText = t.exp + ' / ' + EXP_REQ; document.getElementById('cd-exp-bar').style.width = (t.exp / EXP_REQ * 100) + '%';
            const baseVal = (t.isEvolved && t.customValue) ? t.customValue : Number(chara.value); document.getElementById('cd-val').innerText='x'+(baseVal+(t.level*LV_BONUS_RATE)).toFixed(2);
        }
    }
    
    function openShop() { document.getElementById('shop-overlay').classList.remove('hidden'); renderShop(); }
    let currentShopTab = 'buy'; 
    function renderShop() {
        document.getElementById('shop-xp').innerText = gameState.xp;
        const l=document.getElementById('shop-list'); 
        // --- ä¿®æ­£: è¡¨ç¤ºæ™‚ã« || 0 ã‚’è¿½åŠ  ---
        l.innerHTML=`<div class="page-counter-container"><div class="page-item">ğŸ“• <span>${gameState.inventory.redPages||0}</span></div><div class="page-item">ğŸ“˜ <span>${gameState.inventory.bluePages||0}</span></div></div><div class="item-tab-container"><div class="item-tab ${currentShopTab==='buy'?'active':''}" onclick="currentShopTab='buy'; renderShop();">å­¦ç¿’ã‚¢ã‚¤ãƒ†ãƒ </div><div class="item-tab ${currentShopTab==='exchange'?'active':''}" onclick="currentShopTab='exchange'; renderShop();">ã‚¢ã‚¤ãƒ†ãƒ äº¤æ›</div></div>`; 
        
        if(currentShopTab === 'buy') {
            if(rawData.shopItems) rawData.shopItems.forEach(i=>{ 
                const lv = (gameState.itemLevels && gameState.itemLevels[i.id]) ? gameState.itemLevels[i.id] : 0; const p=i.price*(lv+1); 
                l.innerHTML+=`<div class="shop-item"><div class="shop-icon">${i.icon}</div><div class="shop-info"><div class="shop-name">${i.name}</div><div class="shop-desc">${i.desc}</div></div><div class="shop-right"><div class="shop-level-tag">Lv.${lv} / ${MAX_ITEM_LEVEL}</div><button class="shop-buy-btn" onclick="buyItem('${i.id}',${p})">${lv>=10?'MAX':'â¬† '+p+'XP'}</button></div></div>`; 
            }); 
        } else {
            const rates = [ 
                { id: 'xpBookSmall', name: 'å°ã®æ›¸', cost: 20, gain: 100, icon: 'ğŸ“”' }, 
                { id: 'xpBookMedium', name: 'ä¸­ã®æ›¸', cost: 35, gain: 500, icon: 'ğŸ“•' }, 
                { id: 'xpBookLarge', name: 'å¤§ã®æ›¸', cost: 50, gain: 1000, icon: 'ğŸ“˜' } 
            ];
            rates.forEach(ex => {
                const canEx = (gameState.inventory.redPages >= ex.cost && gameState.inventory.bluePages >= ex.cost);
                // --- ä¿®æ­£: ç¾åœ¨ã®æ‰€æŒæ•°ã‚’è¡¨ç¤ºã«è¿½åŠ  ---
                const currentCount = gameState.inventory[ex.id] || 0;
                
                l.innerHTML += `<div class="shop-item">
                    <div class="shop-icon">${ex.icon}</div>
                    <div class="shop-info">
                        <div class="shop-name">${ex.name}</div>
                        <div class="shop-desc">ã‚­ãƒ£ãƒ©XP +${ex.gain}</div>
                        <div style="font-size:0.8em; color:#7f8c8d;">æ‰€æŒ: ${currentCount}å†Š</div>
                        <div style="font-size:0.8em; color:#e67e22; font-weight:bold;">å¿…è¦: ğŸ“•${ex.cost} & ğŸ“˜${ex.cost}</div>
                    </div>
                    <div class="shop-right">
                        <button class="shop-buy-btn" ${canEx?'':'disabled'} onclick="exchangeBook('${ex.id}', ${ex.cost})">äº¤æ›</button>
                    </div>
                </div>`;
            });
        }
    }
    function exchangeBook(bookId, cost) {
        if (gameState.inventory.redPages < cost || gameState.inventory.bluePages < cost) return;
        gameState.inventory.redPages -= cost; gameState.inventory.bluePages -= cost; gameState.inventory[bookId]++;
        saveGame(); renderShop(); playSE('win');
    }
    function closeShop() { document.getElementById('shop-overlay').classList.add('hidden'); }
    function buyItem(id,p) { if (!gameState.itemLevels) gameState.itemLevels = {}; if((gameState.itemLevels[id]||0)>=10)return; if(gameState.xp<p)return alert("XPä¸è¶³"); gameState.xp-=p; gameState.itemLevels[id]=(gameState.itemLevels[id]||0)+1; saveGame(); openShop(); updateTitleInfo(); checkTitles(); }

    function openVersionHistory() { document.getElementById('version-overlay').classList.remove('hidden'); }
    function closeVersionHistory() { document.getElementById('version-overlay').classList.add('hidden'); }
    function openHowToPlay() { document.getElementById('howto-overlay').classList.remove('hidden'); }
    function closeHowToPlay() { document.getElementById('howto-overlay').classList.add('hidden'); }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = true;
    function toggleMute() { isMuted = !isMuted; const btn = document.getElementById('btn-mute'); if(isMuted) { btn.innerText = "ğŸ”‡ éŸ³é‡: OFF"; btn.style.background = "#95a5a6"; btn.style.borderColor = "#7f8c8d"; stopBGM(); } else { btn.innerText = "ğŸ”Š éŸ³é‡: ON"; btn.style.background = "#34495e"; btn.style.borderColor = "#2c3e50"; playSE('hit'); if(isGameActive) playBGM(); } }
    function playSE(type) {
        if(isMuted) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); osc.connect(gainNode); gainNode.connect(audioCtx.destination); const now = audioCtx.currentTime;
        if (type === 'type_hit') { osc.type = 'triangle'; osc.frequency.setValueAtTime(1500, now); gainNode.gain.setValueAtTime(0.15, now); gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.08); osc.start(now); osc.stop(now + 0.08); }
        else if (type === 'type_miss') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.15); gainNode.gain.setValueAtTime(0.2, now); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.15); osc.start(now); osc.stop(now + 0.15); }
        else if (type === 'hit') { osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
        else if (type === 'miss') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
        else if (type === 'win') { osc.type = 'square'; gainNode.gain.value = 0.1; [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => { const t = now + i * 0.1; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = 'square'; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.1); o.start(t); o.stop(t + 0.1); }); }
        else if (type === 'lose') { osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 1.0); gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 1.0); osc.start(now); osc.stop(now + 1.0); }
        else if (type === 'count') { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'start') { osc.type = 'square'; osc.frequency.setValueAtTime(880, now); osc.frequency.exponentialRampToValueAtTime(1760, now + 0.3); gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
    }

    const BGM_MML = "T150 L8 O3 G G > C C D C E F G G A G F E D C < B > C4 R4";
    let bgmOscillators = []; let bgmTimeout = null;
    function playBGM() {
        if (isMuted) return; stopBGM(); if (audioCtx.state === 'suspended') audioCtx.resume();
        const mml = BGM_MML.replace(/\s+/g, '').toUpperCase(); let index = 0; let nextTime = audioCtx.currentTime + 0.1; let octave = 4; let defaultLen = 4; let tempo = 120;
        const scheduleNote = () => {
            if (!isGameActive) return;
            while (nextTime < audioCtx.currentTime + 2.0 && index < mml.length) {
                let char = mml[index++];
                if (char === 'T') { let num = parseInt(mml.slice(index)); if (!isNaN(num)) { tempo = num; index += String(num).length; } } 
                else if (char === 'L') { let num = parseInt(mml.slice(index)); if (!isNaN(num)) { defaultLen = num; index += String(num).length; } } 
                else if (char === 'O') { let num = parseInt(mml.slice(index)); if (!isNaN(num)) { octave = num; index += String(num).length; } } 
                else if (char === '>') octave++; else if (char === '<') octave--;
                else if (char === 'R') { let len = defaultLen; let num = parseInt(mml.slice(index)); if (!isNaN(num)) { len = num; index += String(num).length; } nextTime += (60 / tempo) * (4 / len); } 
                else if ("CDEFGAB".includes(char)) {
                    let note = char; if (mml[index] === '#' || mml[index] === '+') { note += '#'; index++; } else if (mml[index] === '-') { note += '-'; index++; }
                    let len = defaultLen; let num = parseInt(mml.slice(index)); if (!isNaN(num)) { len = num; index += String(num).length; }
                    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]; let keyIndex = notes.indexOf(note.replace('-', '')); if (keyIndex === -1) keyIndex = 0;
                    const freq = 440 * Math.pow(2, (octave - 4) + (keyIndex - 9) / 12);
                    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.value = freq; osc.connect(gain); gain.connect(audioCtx.destination);
                    const duration = (60 / tempo) * (4 / len); osc.start(nextTime); osc.stop(nextTime + duration - 0.05); gain.gain.setValueAtTime(0.05, nextTime); gain.gain.linearRampToValueAtTime(0.02, nextTime + duration - 0.05); gain.gain.setValueAtTime(0, nextTime + duration);
                    bgmOscillators.push(osc); nextTime += duration;
                }
            }
            if (index >= mml.length) index = 0; if (isGameActive && !isMuted) bgmTimeout = setTimeout(scheduleNote, 500);
        };
        scheduleNote();
    }
    function stopBGM() { if (bgmTimeout) clearTimeout(bgmTimeout); bgmOscillators.forEach(osc => { try { osc.stop(); } catch(e){} }); bgmOscillators = []; }

    function openRecord() { document.getElementById('record-overlay').classList.remove('hidden'); renderRecord(); }
    function closeRecord() { document.getElementById('record-overlay').classList.add('hidden'); }
    function renderRecord() {
        const tbody = document.getElementById('grade-tbody'); tbody.innerHTML = '';
        const subjects = Object.keys(gameState.subjectStats).sort();
        if (subjects.length === 0) { tbody.innerHTML = '<tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„ã€‚</td></tr>'; drawRadarChart([], []); return; }
        const labels = []; const dataPoints = [];
        subjects.forEach(subj => {
            const d = gameState.subjectStats[subj]; const rate = d.total > 0 ? (d.correct / d.total * 100) : 0;
            let rank = 'G'; if (rate >= 90) rank = 'S'; else if (rate >= 80) rank = 'A'; else if (rate >= 70) rank = 'B'; else if (rate >= 60) rank = 'C'; else if (rate >= 50) rank = 'D'; else if (rate >= 40) rank = 'E'; else if (rate >= 20) rank = 'F';
            labels.push(subj); dataPoints.push(rate);
            tbody.innerHTML += `<tr><td>${subj}</td><td>${rate.toFixed(1)}% <span style="font-size:0.8em; color:#7f8c8d;">(${d.correct}/${d.total})</span></td><td class="rank-${rank}">${rank}</td></tr>`;
        });
        drawRadarChart(labels, dataPoints);
    }
    function drawRadarChart(labels, data) {
        const canvas = document.getElementById('radar-chart'); if (!canvas) return; const ctx = canvas.getContext('2d');
        const w = canvas.width; const h = canvas.height; const cx = w / 2; const cy = h / 2; const radius = w / 2 - 40;
        ctx.clearRect(0, 0, w, h); const sides = Math.max(5, labels.length); 
        ctx.strokeStyle = '#e0e0e0'; ctx.lineWidth = 1;
        for (let i = 1; i <= 5; i++) { const r = radius * (i / 5); ctx.beginPath(); for (let j = 0; j < sides; j++) { const angle = (Math.PI * 2 * j) / sides - Math.PI / 2; const x = cx + Math.cos(angle) * r; const y = cy + Math.sin(angle) * r; if (j === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); } ctx.closePath(); ctx.stroke(); }
        ctx.fillStyle = '#333'; ctx.font = 'bold 12px "BIZ UDPGothic"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        for (let j = 0; j < sides; j++) {
            const angle = (Math.PI * 2 * j) / sides - Math.PI / 2; const x = cx + Math.cos(angle) * radius; const y = cy + Math.sin(angle) * radius;
            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(x, y); ctx.stroke();
            if (j < labels.length) { const lx = cx + Math.cos(angle) * (radius + 20); const ly = cy + Math.sin(angle) * (radius + 20); ctx.fillText(labels[j], lx, ly); }
        }
        if (data.length === 0) return;
        ctx.beginPath();
        for (let j = 0; j < sides; j++) { if (j >= data.length) break; const val = Math.min(100, Math.max(0, data[j])); const r = radius * (val / 100); const angle = (Math.PI * 2 * j) / sides - Math.PI / 2; const x = cx + Math.cos(angle) * r; const y = cy + Math.sin(angle) * r; if (j === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
        ctx.closePath(); ctx.fillStyle = 'rgba(142, 68, 173, 0.5)'; ctx.fill(); ctx.strokeStyle = '#8e44ad'; ctx.lineWidth = 2; ctx.stroke();
    }

    let tempOaths = [];
    function openOathMenu() { tempOaths = []; document.querySelectorAll('.oath-option').forEach(el => el.classList.remove('selected')); document.getElementById('oath-overlay').classList.remove('hidden'); }
    function closeOathMenu() { document.getElementById('oath-overlay').classList.add('hidden'); }
    function toggleOath(type) { const el = document.getElementById('oath-' + type); if (tempOaths.includes(type)) { tempOaths = tempOaths.filter(t => t !== type); el.classList.remove('selected'); } else { tempOaths.push(type); el.classList.add('selected'); } }
    function startOathGame() {
        if (tempOaths.length === 0) return alert("èª“ç´„ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„");
        const g = document.getElementById('grade-select').value; const s = document.getElementById('subject-select').value; const u = document.getElementById('unit-select').value;
        let qList = rawData.questions.filter(q => q.grade == g && q.subject == s && q.unit == u);
        if(qList.length === 0) return alert("å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
        let boss = rawData.bosses ? rawData.bosses.find(b => b.unit == u && b.grade == g) : null;
        if(!boss) boss = { name: "è©¦ç·´ã®é­”äºº", hp: 1500, icon: "ğŸ‘¿" };
        playData.questions = qList.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        playData.isRevenge = false; playData.activeOaths = [...tempOaths]; playData.isRandom = false; 
        playData.context = { grade: g, subject: s, unit: u };
        const charaStats = getCharaStats();
        gameState.score = 0; gameState.combo = 0; gameState.lives = playData.activeOaths.includes('backwater') ? 1 : 3;
        gameState.enemyHP = Number(boss.hp)||3000; gameState.maxHP = gameState.enemyHP; 
        let timeMulti = playData.activeOaths.includes('rapid') ? 0.5 : 1.0; gameState.maxTime = 10 * charaStats.time * timeMulti;
        isGameActive = false; isPaused = false;
        document.getElementById('oath-overlay').classList.add('hidden'); document.getElementById('title-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
        const enemyBox = document.querySelector('.enemy-visual-box'); const enemyIcon = document.getElementById('ui-enemy-icon');
        enemyBox.classList.remove('anim-paused', 'fade-out'); enemyIcon.classList.remove('shake-anim');
        document.getElementById('ui-enemy-name').innerText = "ã€èª“ç´„ã€‘" + boss.name;
        if(boss.icon.startsWith('http')) { enemyIcon.innerHTML = `<img src="${boss.icon}">`; } else { enemyIcon.innerHTML = boss.icon; }
        document.getElementById('ui-timer').style.width = '100%'; document.getElementById('ui-timer-text').innerText = gameState.maxTime.toFixed(1);
        updateUI(); startCountdown();
    }

    function openRandomMenu() {
        if(!rawData.questions) return;
        const grades = [...new Set(rawData.questions.map(q => q.grade))].filter(g=>g);
        const sel = document.getElementById('random-grade-select'); sel.innerHTML = '<option value="">å­¦å¹´ã‚’é¸æŠ...</option>';
        grades.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
        document.getElementById('random-overlay').classList.remove('hidden');
    }
    function closeRandomMenu() { document.getElementById('random-overlay').classList.add('hidden'); }
    function startRandomGame() {
        const g = document.getElementById('random-grade-select').value; if(!g) return alert("å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„");
        const qList = rawData.questions.filter(q => q.grade == g); if(qList.length === 0) return alert("å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        let possibleBosses = []; if (rawData.randomBosses) { possibleBosses = rawData.randomBosses.filter(b => b.grade == g || b.grade == 'å…¨å­¦å¹´'); }
        let boss; if (possibleBosses.length > 0) { const b = possibleBosses[Math.floor(Math.random() * possibleBosses.length)]; boss = { name: b.name, hp: Number(b.hp) || 3000, icon: b.icon }; } else { boss = { name: "è¿·å®®ã®ãƒŒã‚·", hp: 3000, icon: "ğŸ²" }; }
        playData.questions = qList.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        playData.isRevenge = false; playData.activeOaths = []; playData.isRandom = true;
        const charaStats = getCharaStats();
        gameState.score = 0; gameState.combo = 0; gameState.lives = 3; gameState.enemyHP = boss.hp; gameState.maxHP = boss.hp; gameState.maxTime = 10 * charaStats.time;
        isGameActive = false; isPaused = false;
        document.getElementById('random-overlay').classList.add('hidden'); document.getElementById('title-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
        const enemyBox = document.querySelector('.enemy-visual-box'); const enemyIcon = document.getElementById('ui-enemy-icon');
        enemyBox.classList.remove('anim-paused', 'fade-out'); enemyIcon.classList.remove('shake-anim');
        document.getElementById('ui-enemy-name').innerText = "ã€è¿·å®®ã€‘" + boss.name;
        if(boss.icon && boss.icon.startsWith('http')) { enemyIcon.innerHTML = `<img src="${boss.icon}">`; } else { enemyIcon.innerHTML = boss.icon || "ğŸ‘¾"; }
        document.getElementById('ui-timer').style.width = '100%'; document.getElementById('ui-timer-text').innerText = gameState.maxTime.toFixed(1);
        updateUI(); startCountdown();
    }

    function openTypingMenu() {
        if(!rawData.typing || rawData.typing.length === 0) return alert("ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å•é¡Œãƒ‡ãƒ¼ã‚¿(typingã‚·ãƒ¼ãƒˆ)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        const grades = [...new Set(rawData.typing.map(t => t.grade))].filter(g=>g);
        const sel = document.getElementById('typing-grade-select'); sel.innerHTML = '<option value="">å­¦å¹´ã‚’é¸æŠ...</option>';
        grades.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
        document.getElementById('typing-menu-overlay').classList.remove('hidden');
    }
    function closeTypingMenu() { document.getElementById('typing-menu-overlay').classList.add('hidden'); }
    function startTypingGame() {
        const g = document.getElementById('typing-grade-select').value; if(!g) return alert("å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„");
        if (!rawData.typing) return alert("ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
        const qList = rawData.typing.filter(t => t.grade == g); if(qList.length === 0) return alert("é¸æŠã—ãŸå­¦å¹´ã®å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“");
        let boss = { name: "ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®é­”äºº", hp: qList.length * 50, icon: "âŒ¨ï¸" };
        try { if(rawData.bosses) { const specificBoss = rawData.bosses.find(b => b.grade == g && b.unit == 'ã‚¿ã‚¤ãƒ”ãƒ³ã‚°'); if(specificBoss) { boss = { ...specificBoss }; if(!boss.hp) boss.hp = qList.length * 50; } else { const gradeBoss = rawData.bosses.find(b => b.grade == g); if(gradeBoss) { boss = { ...gradeBoss }; boss.hp = qList.length * 50; boss.name = "ã€æ‰“éµã€‘" + boss.name; } } } } catch(e) {}
        playData.questions = qList.sort(() => Math.random() - 0.5); playData.qIndex = 0; playData.currentBoss = boss;
        playData.isRevenge = false; playData.activeOaths = []; playData.isRandom = false; playData.isTyping = true; playData.context = null;
        const charaStats = getCharaStats();
        gameState.score = 0; gameState.combo = 0; gameState.lives = 5; gameState.enemyHP = Number(boss.hp) || 3000; gameState.maxHP = gameState.enemyHP; gameState.maxTime = 10 * charaStats.time; 
        isGameActive = false; isPaused = false;
        document.getElementById('typing-menu-overlay').classList.add('hidden'); document.getElementById('title-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('ui-choices').classList.add('hidden'); document.getElementById('ui-typing-area').classList.remove('hidden'); document.getElementById('ui-question').classList.add('hidden');
        const enemyBox = document.querySelector('.enemy-visual-box'); const enemyIcon = document.getElementById('ui-enemy-icon');
        enemyBox.classList.remove('anim-paused', 'fade-out'); enemyIcon.classList.remove('shake-anim');
        document.getElementById('ui-enemy-name').innerText = boss.name;
        if(boss.icon && boss.icon.startsWith('http')) { enemyIcon.innerHTML = `<img src="${boss.icon}">`; } else { enemyIcon.innerHTML = boss.icon || "ğŸ‘¾"; }
        document.removeEventListener('keydown', handleTypingInput); document.addEventListener('keydown', handleTypingInput);
        document.getElementById('ui-timer').style.width = '100%'; document.getElementById('ui-timer-text').innerText = gameState.maxTime.toFixed(1);
        updateUI(); startCountdown();
    }
    function nextTypingQuestion() { if(playData.qIndex >= playData.questions.length) { playData.questions.sort(()=>Math.random()-0.5); playData.qIndex = 0; } const q = playData.questions[playData.qIndex]; playData.typingTarget = q; playData.typingIndex = 0; renderTypingUI(); startTimer(); }
    function renderTypingUI() {
        const q = playData.typingTarget; const idx = playData.typingIndex; const str = q.romaji;
        document.getElementById('ui-typing-jp').innerText = q.japanese;
        let html = ''; for(let i=0; i<str.length; i++) { if(i < idx) html += `<span class="typing-char-done">${str[i]}</span>`; else if(i === idx) html += `<span class="typing-char-current">${str[i]}</span>`; else html += `<span class="typing-char-rest">${str[i]}</span>`; }
        document.getElementById('ui-typing-romaji').innerHTML = html;
    }
    function handleTypingInput(e) {
        if(!isGameActive || isPaused || !playData.isTyping) return; if(e.key.length > 1) return;
        const inputKey = e.key.toLowerCase(); let targetStr = playData.typingTarget.romaji; let idx = playData.typingIndex;
        let isMatch = (inputKey === targetStr[idx]);
        if (!isMatch) {
            const remainder = targetStr.substring(idx);
            const startPatterns = [ {t:'chi', r:'ti'}, {t:'tsu', r:'tu'}, {t:'fu', r:'hu'}, {t:'ji', r:'zi'}, {t:'ka', r:'ca'}, {t:'ku', r:'cu'}, {t:'ko', r:'co'}, {t:'se', r:'ce'}, {t:'ja', r:'zya'}, {t:'ju', r:'zyu'}, {t:'jo', r:'zyo'}, {t:'cha', r:'tya'}, {t:'chu', r:'tyu'}, {t:'cho', r:'tyo'} ];
            for (let p of startPatterns) { if (remainder.startsWith(p.t) && p.r.startsWith(inputKey)) { const newStr = targetStr.substring(0, idx) + p.r + targetStr.substring(idx + p.t.length); playData.typingTarget.romaji = newStr; targetStr = newStr; renderTypingUI(); isMatch = true; break; } }
            if (!isMatch && idx > 0) {
                const context = targetStr.substring(idx - 1); 
                const skipPatterns = [ {t:'shi', r:'si'}, {t:'tsu', r:'tu'}, {t:'chi', r:'ti'}, {t:'sha', r:'sya'}, {t:'shu', r:'syu'}, {t:'sho', r:'syo'}, {t:'sya', r:'sha'}, {t:'syu', r:'shu'}, {t:'syo', r:'sho'}, {t:'cha', r:'cya'}, {t:'chu', r:'cyu'}, {t:'cho', r:'cyo'}, {t:'cya', r:'cha'}, {t:'cyu', r:'chu'}, {t:'cyo', r:'cho'}, {t:'ja', r:'jya'}, {t:'ju', r:'jyu'}, {t:'jo', r:'jyo'}, {t:'jya', r:'ja'}, {t:'jyu', r:'ju'}, {t:'jyo', r:'jo'} ];
                for (let s of skipPatterns) { if (context.startsWith(s.t) && s.r[1] === inputKey) { const pre = targetStr.substring(0, idx - 1); const post = targetStr.substring(idx - 1 + s.t.length); const newStr = pre + s.r + post; playData.typingTarget.romaji = newStr; targetStr = newStr; renderTypingUI(); isMatch = true; break; } }
            }
            if (!isMatch && inputKey === 'n' && idx > 0) { if (targetStr[idx-1] === 'n') { const pre = targetStr.substring(0, idx); const post = targetStr.substring(idx); const newStr = pre + 'n' + post; playData.typingTarget.romaji = newStr; targetStr = newStr; renderTypingUI(); isMatch = true; } }
        }
        if(isMatch) {
            playData.typingIndex++; playSE('type_hit'); renderTypingUI();
            if(playData.typingIndex >= playData.typingTarget.romaji.length) {
                clearInterval(gameState.timer);
                const stats = getCharaStats(); const speedMultiplier = 1.8 * stats.time; let damage = Math.floor(80 * stats.atk * (0.2 + (gameState.timeLeft / gameState.maxTime) * speedMultiplier) * (1 + (gameState.combo * 0.05)));
                gameState.enemyHP = Math.max(0, gameState.enemyHP - damage); gameState.score += damage; gameState.combo++; showCutIn("-" + damage);
                const enemyIcon = document.getElementById('ui-enemy-icon'); enemyIcon.classList.remove('shake-anim'); void enemyIcon.offsetWidth; enemyIcon.classList.add('shake-anim'); updateUI();
                if(gameState.enemyHP <= 0) { setTimeout(() => isGameActive && finishGame(true), 500); } else { playData.qIndex++; setTimeout(() => { if(isGameActive) nextTypingQuestion(); }, 200); }
            }
        } else { playSE('type_miss'); gameState.lives--; gameState.combo = 0; showCutIn("MISS"); updateUI(); const romeBox = document.getElementById('ui-typing-romaji'); romeBox.classList.add('shake-anim'); setTimeout(()=>romeBox.classList.remove('shake-anim'), 400); if(gameState.lives <= 0) { finishGame(false); } }
    }

    function openUnitSelection() { document.getElementById('unit-select-title').innerText = "ã‚¯ã‚¨ã‚¹ãƒˆå‡ºç™º"; document.getElementById('unit-select-title').style.color = "#2c3e50"; document.getElementById('unit-select-overlay').classList.remove('hidden'); }
    function closeUnitSelection() { document.getElementById('unit-select-overlay').classList.add('hidden'); }
    function startNormalGameCheck() { const g = document.getElementById('grade-select').value; const s = document.getElementById('subject-select').value; const u = document.getElementById('unit-select').value; if(!g || !s || !u) return alert("å…¨ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„"); closeUnitSelection(); startGame(); }
    function goToOathMenuCheck() { const g = document.getElementById('grade-select').value; const s = document.getElementById('subject-select').value; const u = document.getElementById('unit-select').value; if(!g || !s || !u) return alert("å…¨ã¦ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„"); closeUnitSelection(); openOathMenu(); }
    
    function checkAdminGifts() { 
        if (!rawData.gifts || rawData.gifts.length === 0) { updateGiftButtonState(); return; }
        const unclaimed = rawData.gifts.filter(g => { const id = g.id || g['ID']; return id && !gameState.claimedGifts.includes(id); });
        updateGiftButtonState(); if (unclaimed.length > 0) openGiftMenu(unclaimed);
    }
    function openGiftMenu(giftsToShow = null) {
        if (!giftsToShow) { if (!rawData.gifts) return; giftsToShow = rawData.gifts.filter(g => { const id = g.id || g['ID']; return id && !gameState.claimedGifts.includes(id); }); }
        if (giftsToShow.length === 0) { alert("å—ã‘å–ã‚‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); updateGiftButtonState(); return; }
        const list = document.getElementById('gift-list'); list.innerHTML = '';
        giftsToShow.forEach(g => { const id = g.id || g['ID'] || 'unknown'; const title = g.title || g['ã‚¿ã‚¤ãƒˆãƒ«'] || 'No Title'; const msg = g.message || g['ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'] || 'No Message'; const exp = g.exp || g['EXP'] || 0; list.innerHTML += `<div class="gift-item" data-id="${id}" data-exp="${exp}"><div class="gift-header"><span class="gift-title">${title}</span><span class="gift-exp">+${exp} XP</span></div><div class="gift-msg">${msg}</div></div>`; });
        document.getElementById('gift-overlay').classList.remove('hidden');
    }
    function closeGiftMenu() { document.getElementById('gift-overlay').classList.add('hidden'); }
    function receiveAllGifts() {
        const items = document.querySelectorAll('.gift-item'); if (items.length === 0) return;
        let totalExp = 0; let count = 0;
        items.forEach(item => { const id = item.getAttribute('data-id'); const expVal = item.getAttribute('data-exp'); const exp = parseInt(expVal, 10); if (id && id !== 'undefined' && id !== 'unknown' && !gameState.claimedGifts.includes(id)) { gameState.claimedGifts.push(id); if (!isNaN(exp)) totalExp += exp; count++; } });
        if (count > 0) { gameState.xp += totalExp; saveGame(); updateTitleInfo(); playSE('win'); alert(`ğŸ ã‚®ãƒ•ãƒˆã‚’${count}ä»¶å—ã‘å–ã‚Šã¾ã—ãŸï¼\nåˆè¨ˆ: +${totalExp} XP`); closeGiftMenu(); checkTitles(); updateGiftButtonState(); } else { closeGiftMenu(); }
    }
    function updateGiftButtonState() { if (!rawData.gifts) return; const unclaimed = rawData.gifts.filter(g => { const id = g.id || g['ID']; return id && !gameState.claimedGifts.includes(id); }); const btn = document.getElementById('btn-gift'); const badge = document.getElementById('gift-badge'); if (unclaimed.length > 0) { btn.disabled = false; btn.style.opacity = "1.0"; btn.style.filter = "none"; badge.innerText = unclaimed.length; badge.classList.remove('hidden'); } else { btn.disabled = true; btn.style.opacity = "0.7"; badge.classList.add('hidden'); } }
</script>
</body>
</html>
