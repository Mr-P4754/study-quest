<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STUDY QUEST | Stationary Master</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        /* Base & Reset */
        body { font-family: 'DotGothic16', sans-serif; text-align: center; background-color: #2c3e50; color: #ecf0f1; margin: 0; padding: 0; touch-action: manipulation; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        button { cursor: pointer; font-family: inherit; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Layout */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: #2c3e50; z-index: 10; transition: opacity 0.3s; }
        .hidden { display: none !important; }
        
        /* UI Components */
        .header { padding: 10px; background: #34495e; border-bottom: 4px solid #2c3e50; display: flex; justify-content: space-between; align-items: center; height: 50px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 20; flex-shrink: 0; }
        .life-container { font-size: 1.5em; color: #e74c3c; letter-spacing: 2px; }
        .stats-box { font-size: 0.9em; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; border: 1px solid #555; }
        
        /* Timer Bar */
        .timer-container { 
            width: 85%; margin: 15px auto 10px; background: #444; height: 30px; min-height: 30px; 
            position: relative; border: 3px solid #fff; border-radius: 15px; overflow: hidden; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); flex-shrink: 0; z-index: 30;
        }
        .timer-bar-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.1s linear; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-timer-text { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; 
            line-height: 30px; font-weight: bold; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; font-size: 1.2em; color: #fff;
        }

        /* Battle Area */
        .battle-area { 
            flex: 1; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            position: relative; 
            background: #222; 
            background-image: radial-gradient(#333 15%, transparent 16%), radial-gradient(#333 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden; padding-top: 10px; 
        }

        .enemy-visual-box {
            animation: float 3s ease-in-out infinite; margin-bottom: 10px;
            flex-grow: 1; display: flex; align-items: center; justify-content: center; max-height: 150px;
        }
        .enemy-visual { font-size: 100px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.2)); display: flex; justify-content: center; align-items: center; }
        .enemy-visual img { width: 120px; height: 120px; object-fit: contain; image-rendering: pixelated; }

        .enemy-stats-row {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 90%; max-width: 500px; margin-bottom: 10px;
            background: rgba(0,0,0,0.4); padding: 8px 15px; border-radius: 12px; border: 1px solid #555; flex-shrink: 0;
        }
        #ui-enemy-name { font-weight: bold; color: #f1c40f; text-shadow: 1px 1px 0 #000; white-space: nowrap; font-size: 1.1em; max-width: 40%; overflow: hidden; text-overflow: ellipsis; }
        .enemy-hp-frame { flex-grow: 1; height: 24px; background: #111; border: 2px solid #fff; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 2px 0 rgba(0,0,0,0.5); }
        .enemy-hp-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); width: 100%; transition: width 0.3s ease-out; }
        #ui-hp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; text-shadow: 1px 1px 2px #000; color: #fff; z-index: 5; }

        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .question-box { background: #fff; color: #2c3e50; width: 90%; max-width: 600px; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 1.4em; min-height: 80px; display: flex; align-items: center; justify-content: center; border: 4px solid #bdc3c7; box-shadow: 0 6px 0 #7f8c8d; margin-bottom: 15px; text-align: center; line-height: 1.4; flex-shrink: 0; }
        
        .choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 94%; max-width: 600px; padding: 10px; padding-bottom: 20px; margin: 0 auto; flex-shrink: 0; }
        .choice-btn { padding: 20px 10px; background: #3498db; border: none; border-radius: 12px; color: white; font-size: 1.1em; font-weight: bold; border-bottom: 6px solid #2980b9; transition: transform 0.05s, background 0.2s; position: relative; overflow: hidden; }
        .choice-btn:active { transform: translateY(6px); border-bottom: none; margin-bottom: 6px; background: #2980b9; }
        
        /* Button Feedback */
        .choice-btn.btn-correct { background: #27ae60 !important; border-bottom: 6px solid #1e8449 !important; transform: translateY(4px); border-bottom-width: 2px !important; margin-bottom: 4px; opacity: 1 !important; }
        .choice-btn.btn-wrong { background: #7f8c8d !important; border-bottom: 6px solid #555 !important; opacity: 0.6 !important; }
        .choice-btn.btn-miss-answer { background: #e74c3c !important; border-color: #c0392b !important; color: #fff !important; opacity: 1 !important; animation: pulseRed 0.8s ease-in-out infinite alternate; }
        @keyframes pulseRed { from { transform: scale(1); box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); } to { transform: scale(1.05); box-shadow: 0 0 20px rgba(231, 76, 60, 0.8); } }

        /* Title & Menus */
        .title-screen-bg { background: linear-gradient(135deg, #2c3e50, #1a252f); }
        .title-logo { font-size: 3.5em; font-weight: 900; margin-top: 40px; color: #f1c40f; text-shadow: 4px 4px 0 #e67e22, 0 0 20px rgba(241, 196, 15, 0.5); line-height: 1; }
        .menu-btn-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 30px; width: 90%; max-width: 400px; margin-left: auto; margin-right: auto; }
        .menu-btn { flex: 1; min-width: 120px; padding: 15px 5px; margin: 0; background: #e67e22; color: white; border: none; border-radius: 50px; font-size: 1.1em; font-weight: bold; border-bottom: 6px solid #d35400; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: all 0.1s; }
        .menu-btn:active { transform: translateY(6px); border-bottom: none; box-shadow: none; }
        .select-box { margin: 10px; padding: 12px; font-size: 1.1em; width: 85%; max-width: 320px; border-radius: 8px; border: 2px solid #95a5a6; background: #ecf0f1; font-family: inherit; }
        
        /* Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #fdfefe; color: #333; width: 92%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; text-align: center; border: 6px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3); }
        
        /* Gacha Cards & Shop */
        .char-card { border: 2px solid #ddd; padding: 8px; border-radius: 10px; margin: 4px; display: inline-block; width: 70px; font-size: 0.7em; cursor: pointer; background: #f9f9f9; vertical-align: top; transition: all 0.2s; }
        .char-card:hover { transform: translateY(-3px); }
        .char-card.owned { background: #fff; border-color: #bdc3c7; }
        .char-card.active { background: #fffbe6; border: 3px solid #e67e22; transform: scale(1.05); box-shadow: 0 0 10px rgba(230, 126, 34, 0.4); }
        .char-img { width: 50px; height: 50px; object-fit: contain; image-rendering: pixelated; margin-bottom: 4px; }
        
        .shop-item { display: flex; align-items: center; background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 10px; border: 2px solid #bdc3c7; text-align: left; transition: transform 0.1s; }
        .shop-item:active { transform: scale(0.98); }
        .shop-icon { font-size: 2em; margin-right: 15px; width: 50px; text-align: center; }
        .shop-info { flex: 1; }
        .shop-name { font-weight: bold; font-size: 1.1em; color: #2c3e50; }
        .shop-level { font-size: 0.8em; color: #fff; background: #3498db; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .shop-desc { font-size: 0.8em; color: #7f8c8d; margin-top: 2px; }
        .shop-buy-btn { background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; border-bottom: 4px solid #1e8449; min-width: 80px; }
        .shop-buy-btn:active { transform: translateY(4px); border-bottom: none; }
        .shop-buy-btn:disabled { background: #95a5a6; border-bottom: none; cursor: default; transform: none; }

        .rarity-SSR { color: #f1c40f; text-shadow: 0 0 2px #000; font-weight: 900; }
        .rarity-SR { color: #e74c3c; font-weight: bold; }
        .rarity-R { color: #3498db; font-weight: bold; }
        .rarity-N { color: #7f8c8d; }
        .cutin { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 5em; font-weight: 900; color: #f1c40f; -webkit-text-stroke: 3px #c0392b; text-shadow: 4px 4px 0 #000; pointer-events: none; z-index: 2000; animation: damageFloat 1.2s ease-out forwards; white-space: nowrap; }
        @keyframes damageFloat { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 15% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1.0); opacity: 0; } }
        
        .gacha-result-card { background: #fff; padding: 20px; border-radius: 15px; border: 4px solid #ccc; text-align: center; margin-bottom: 20px; animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .gr-rarity { font-size: 2em; font-weight: 900; margin-bottom: 10px; }
        .gr-img { width: 120px; height: 120px; object-fit: contain; margin: 10px auto; display: block; }
        .gr-name { font-size: 1.5em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; }
        .gr-desc { color: #7f8c8d; font-size: 0.9em; margin-bottom: 10px; }
        .gr-effect { background: #ecf0f1; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #2980b9; display: inline-block; }
        .gr-new { position: absolute; top: -10px; right: -10px; background: #e74c3c; color: white; padding: 5px 10px; border-radius: 20px; font-weight: bold; transform: rotate(10deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #loading-screen { z-index: 200; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #fff; border-top: 5px solid #f1c40f; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-screen" class="screen">
    <div style="margin: auto;">
        <div class="spinner"></div>
        <h2 style="margin:0;">CONNECTING...</h2>
        <p style="color:#bdc3c7;">„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô</p>
    </div>
</div>

<div id="title-screen" class="screen title-screen-bg hidden">
    <div class="title-logo">STUDY<br>QUEST</div>
    <div style="color:#bdc3c7; margin-bottom: 20px;">Ver 4.4 Economy Tune</div>
    
    <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; width: 90%; max-width: 350px; margin: 0 auto;">
        <select id="grade-select" class="select-box" onchange="filterUnits()">
            <option value="">Â≠¶Âπ¥„ÇíÈÅ∏Êäû</option>
        </select>
        <select id="unit-select" class="select-box">
            <option value="">ÂÖ®„Å¶„ÅÆÂçòÂÖÉ</option>
        </select>
    </div>
    
    <div class="menu-btn-container">
        <button class="menu-btn" onclick="startGame()">‚ñ∂ „ÇØ„Ç®„Çπ„Éà</button>
        <button class="menu-btn" style="background:#8e44ad; border-color:#6c3483;" onclick="openGacha()">üíé „Ç¨„ÉÅ„É£/Âõ≥Èëë</button>
        <button class="menu-btn" style="background:#27ae60; border-color:#1e8449;" onclick="openShop()">üõí „Ç∑„Éß„ÉÉ„Éó</button>
    </div>
    
    <div style="position: absolute; bottom: 15px; width: 100%; color: #95a5a6; font-size: 0.9em; display: flex; justify-content: center; align-items: center; gap: 10px;">
        <div id="title-chara-img" style="width: 40px; height: 40px; background: #333; border-radius: 5px; overflow: hidden;"></div>
        <div>Ë£ÖÂÇô: <span id="title-equipped-name" style="color:#fff; font-weight:bold;">„Å™„Åó</span><br>ÊâÄÊåÅXP: <span id="title-xp" style="color:#f1c40f;">0</span></div>
    </div>
</div>

<div id="game-screen" class="screen hidden">
    <div class="header">
        <div class="life-container" id="ui-life">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div style="display:flex; gap:15px;">
            <div class="stats-box">SCORE <span id="ui-score">0</span></div>
            <div class="stats-box">COMBO <span id="ui-combo" style="color:#f1c40f; font-weight:bold; font-size:1.2em;">0</span></div>
        </div>
    </div>
    
    <div class="timer-container">
        <div id="ui-timer" class="timer-bar-fill"></div>
        <div id="ui-timer-text">10.0</div>
    </div>
    
    <div class="battle-area">
        <div class="enemy-visual-box">
            <div class="enemy-visual" id="ui-enemy-icon">üëæ</div>
        </div>
        <div class="enemy-stats-row">
            <div id="ui-enemy-name">BOSS</div>
            <div class="enemy-hp-frame">
                <div id="ui-hp" class="enemy-hp-fill"></div>
                <div id="ui-hp-text">1000 / 1000</div> 
            </div>
        </div>
        <div id="ui-question" class="question-box">READY?</div>
    </div>
    
    <div class="choices-grid" id="ui-choices">
        <button class="choice-btn"></button>
        <button class="choice-btn"></button>
        <button class="choice-btn"></button>
        <button class="choice-btn"></button>
    </div>
</div>

<div id="result-overlay" class="overlay hidden">
    <div class="modal">
        <h2 id="res-title" style="font-size: 2em; margin-bottom: 10px;"></h2>
        <div id="res-icon" style="font-size: 4em;"></div>
        <p>Áç≤Âæó„Çπ„Ç≥„Ç¢: <span id="res-score" style="font-weight:bold;">0</span></p>
        <div style="background:#eee; padding:15px; border-radius:10px; margin:10px 0;">
            Áç≤ÂæóXP<br>
            <span id="res-xp" style="color:#f1c40f; font-weight:900; font-size:2.5em;">+0</span>
            <div id="res-bonus" style="color:#e67e22; font-weight:bold; font-size:0.9em; margin-top:5px;"></div>
        </div>
        <button class="menu-btn" onclick="backToTitle()">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
    </div>
</div>

<div id="gacha-overlay" class="overlay hidden">
    <div class="modal" style="max-width:500px;">
        <h2 style="color:#8e44ad; margin-top:0;">ÊñáÊàøÂÖ∑Âõ≥Èëë & „Ç¨„ÉÅ„É£</h2>
        <div style="background:#f0f0f0; padding:10px; border-radius:10px; margin-bottom:15px; border: 2px solid #ccc;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span>ÊâÄÊåÅXP: <span id="gacha-xp" style="font-weight:bold; font-size:1.2em; color:#f39c12;">0</span></span>
            </div>
            <button onclick="rollGacha()" style="background:linear-gradient(to bottom, #f1c40f, #f39c12); border:none; padding:12px 25px; border-radius:25px; font-weight:bold; color:#fff; cursor:pointer; box-shadow: 0 4px 0 #d35400; width:100%; font-size:1em;">üíé 3000XP„Åß„Ç¨„ÉÅ„É£„ÇíÂõû„Åô</button>
        </div>
        <h3 style="border-left: 4px solid #8e44ad; padding-left: 10px; text-align: left;">Ë£ÖÂÇôÂ§âÊõ¥</h3>
        <p style="font-size:0.8em; color:#666; text-align: left; margin-top:-10px;">„Ç¢„Ç§„Ç≥„É≥„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë£ÖÂÇô</p>
        <div id="zukan-grid" style="max-height: 400px; overflow-y: auto; text-align: left;"></div>
        <button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeGacha()">Èñâ„Åò„Çã</button>
    </div>
</div>

<div id="gacha-result-overlay" class="overlay hidden">
    <div class="modal" style="max-width:400px; border-color:#f1c40f;">
        <div id="gr-container" style="position:relative;"></div>
        <button class="menu-btn" style="margin-top:20px;" onclick="closeGachaResult()">OK</button>
    </div>
</div>

<div id="shop-overlay" class="overlay hidden">
    <div class="modal" style="max-width:500px;">
        <h2 style="color:#27ae60; margin-top:0;">üõí Â≠¶Áøí„Ç¢„Ç§„ÉÜ„É†</h2>
        <div style="background:#f0f0f0; padding:10px; border-radius:10px; margin-bottom:15px; text-align:right;">
            ÊâÄÊåÅXP: <span id="shop-xp" style="font-weight:bold; font-size:1.2em; color:#f39c12;">0</span>
        </div>
        <div id="shop-list" style="max-height: 400px; overflow-y: auto;"></div>
        <button class="menu-btn" style="margin-top:20px; font-size:1em; padding:10px; background:#95a5a6; border-color:#7f8c8d;" onclick="closeShop()">Èñâ„Åò„Çã</button>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxEt3T8ylMpKhafJSKBG7s_TWYAwY-PxilRq75jef0NYnkB1-MvP1ruW3wnGBCHj1bN/exec';
    
    // === GAME STATE ===
    let rawData = { bosses: [], questions: [], characters: [], shopItems: [] };
    let playData = { questions: [], qIndex: 0, currentBoss: null };
    let gameState = { 
        score: 0, combo: 0, lives: 3, 
        enemyHP: 100, maxHP: 100, 
        timer: null, timeLeft: 0, maxTime: 10,
        xp: 0, ownedCharas: ['001'], equipped: '001',
        itemLevels: {}
    };
    
    // === INIT ===
    window.onload = async () => {
        loadSaveData();
        await fetchData();
        initTitle();
    };

    function loadSaveData() {
        gameState.xp = parseInt(localStorage.getItem('sq_xp') || '0');
        gameState.ownedCharas = JSON.parse(localStorage.getItem('sq_charas') || '["001"]');
        gameState.equipped = localStorage.getItem('sq_equip') || '001';
        
        const savedItems = localStorage.getItem('sq_items_v2');
        if(savedItems) {
            gameState.itemLevels = JSON.parse(savedItems);
        } else {
            const oldItems = JSON.parse(localStorage.getItem('sq_items') || '[]');
            if(Array.isArray(oldItems)) {
                gameState.itemLevels = {};
                oldItems.forEach(id => gameState.itemLevels[id] = 1);
            } else {
                gameState.itemLevels = {};
            }
        }
    }

    function saveGame() {
        localStorage.setItem('sq_xp', gameState.xp);
        localStorage.setItem('sq_charas', JSON.stringify(gameState.ownedCharas));
        localStorage.setItem('sq_equip', gameState.equipped);
        localStorage.setItem('sq_items_v2', JSON.stringify(gameState.itemLevels));
    }

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            rawData = await res.json();
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('title-screen').classList.remove('hidden');
        } catch(e) {
            alert("„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂ§±Êïó: " + e + "\nÈÄö‰ø°„Ç®„É©„Éº„Åæ„Åü„ÅØURL„ÅåÈñìÈÅï„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
        }
    }

    // === TITLE & FILTER ===
    function initTitle() {
        if(!rawData.questions) rawData.questions = [];
        const grades = [...new Set(rawData.questions.map(q => q.grade))].filter(g=>g);
        const gSelect = document.getElementById('grade-select');
        gSelect.innerHTML = '<option value="">Â≠¶Âπ¥„ÇíÈÅ∏Êäû (ÂÖ®‰ª∂)</option>';
        grades.forEach(g => gSelect.innerHTML += `<option value="${g}">${g}</option>`);
        filterUnits();
        updateTitleInfo();
    }

    function filterUnits() {
        const gVal = document.getElementById('grade-select').value;
        const uSelect = document.getElementById('unit-select');
        uSelect.innerHTML = '<option value="">ÂÖ®„Å¶„ÅÆÂçòÂÖÉ</option>';
        let targetList = rawData.questions || [];
        if(gVal) targetList = targetList.filter(q => q.grade === gVal);
        const units = [...new Set(targetList.map(q => q.unit))].filter(u=>u);
        units.forEach(u => uSelect.innerHTML += `<option value="${u}">${u}</option>`);
    }
    
    function updateTitleInfo() {
        if(!rawData.characters) rawData.characters = [];
        const chara = rawData.characters.find(c => c.id == gameState.equipped) || rawData.characters[0];
        document.getElementById('title-equipped-name').innerText = chara ? chara.name : "„Å™„Åó";
        document.getElementById('title-xp').innerText = gameState.xp;
        const imgContainer = document.getElementById('title-chara-img');
        if(chara && chara.imageUrl) {
            imgContainer.innerHTML = `<img src="${chara.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
            imgContainer.innerHTML = `<div style="text-align:center;line-height:40px;">‚úèÔ∏è</div>`;
        }
    }

    // === GAME LOGIC ===
    function startGame() {
        try {
            const gVal = String(document.getElementById('grade-select').value);
            const uVal = String(document.getElementById('unit-select').value);
            let qList = rawData.questions.filter(q => {
                const matchGrade = !gVal || String(q.grade) == gVal;
                const matchUnit = !uVal || String(q.unit) == uVal;
                return matchGrade && matchUnit;
            });
            if(qList.length === 0) { alert("ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"); return; }
            let boss = null;
            if(rawData.bosses) {
                boss = rawData.bosses.find(b => String(b.unit) == uVal && String(b.grade) == gVal);
            }
            if(!boss) boss = { name: "„ÉÜ„Çπ„Éà„ÅÆÈ≠î‰∫∫", hp: 1000, icon: "üòà" };

            playData.questions = qList.sort(() => Math.random() - 0.5);
            playData.qIndex = 0;
            playData.currentBoss = boss;
            
            const charaStats = getCharaStats(); 
            gameState.score = 0;
            gameState.combo = 0;
            gameState.lives = 3;
            gameState.maxHP = Number(boss.hp) || 1000;
            gameState.enemyHP = gameState.maxHP;
            gameState.maxTime = 10 * charaStats.time; 
            
            document.getElementById('title-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('ui-enemy-name').innerText = boss.name;
            document.getElementById('ui-question').innerText = "LOADING..."; 
            
            const iconContainer = document.getElementById('ui-enemy-icon');
            const iconVal = boss.icon || "üëæ"; 
            if(String(iconVal).length > 4 || String(iconVal).includes('/')) {
                 iconContainer.innerHTML = `<img src="${iconVal}" style="width:100px;height:100px;object-fit:contain;">`;
            } else {
                 iconContainer.innerHTML = iconVal;
            }
            
            updateUI();
            nextQuestion(); 
        } catch (e) { alert("„Ç®„É©„Éº: " + e.message); }
    }
    
    function getCharaStats() {
        const chara = rawData.characters.find(c => c.id == gameState.equipped);
        let stats = { atk: 1.0, time: 1.0, exp: 1.0 };
        
        if(chara) {
            if(chara.type === 'ATK') stats.atk = Number(chara.value);
            if(chara.type === 'TIME') stats.time = Number(chara.value);
            if(chara.type === 'EXP') stats.exp = Number(chara.value);
        }

        if(gameState.itemLevels && rawData.shopItems) {
            Object.keys(gameState.itemLevels).forEach(itemId => {
                const item = rawData.shopItems.find(i => i.id === itemId);
                const level = gameState.itemLevels[itemId];
                if(item && level > 0) {
                    if(item.type === 'ATK') stats.atk += (Number(item.value) * level);
                    if(item.type === 'TIME') stats.time += (Number(item.value) * level);
                    if(item.type === 'EXP') stats.exp += (Number(item.value) * level);
                }
            });
        }
        return stats;
    }

    function nextQuestion() {
        if(playData.qIndex >= playData.questions.length) {
            playData.questions = playData.questions.sort(() => Math.random() - 0.5); 
            playData.qIndex = 0;
        }
        const q = playData.questions[playData.qIndex];
        playData.currentQ = q;
        document.getElementById('ui-question').innerText = q.q;
        
        const safeChoices = q.choices || []; 
        const choices = [...safeChoices].sort(() => Math.random() - 0.5);
        const btns = document.querySelectorAll('.choice-btn');
        btns.forEach((btn, i) => {
            if(choices[i]) {
                btn.style.display = 'block';
                btn.innerText = choices[i];
                btn.className = 'choice-btn'; 
                btn.disabled = false;
                btn.onclick = () => judge(choices[i] === q.a, btn);
            } else {
                btn.style.display = 'none';
            }
        });
        startTimer();
    }
    
    function startTimer() {
        if(gameState.timer) clearInterval(gameState.timer);
        gameState.timeLeft = gameState.maxTime;
        const bar = document.getElementById('ui-timer');
        const txt = document.getElementById('ui-timer-text');
        bar.style.width = '100%';
        bar.style.background = '#2ecc71';
        
        gameState.timer = setInterval(() => {
            gameState.timeLeft -= 0.1;
            const pct = (gameState.timeLeft / gameState.maxTime) * 100;
            bar.style.width = pct + '%';
            txt.innerText = Math.max(0, gameState.timeLeft).toFixed(1);
            if(pct < 50) bar.style.background = '#f1c40f';
            if(pct < 20) bar.style.background = '#e74c3c';
            if(gameState.timeLeft <= 0) {
                clearInterval(gameState.timer);
                judge(false, null); 
            }
        }, 100);
    }

    function judge(isCorrect, clickedBtn) {
        clearInterval(gameState.timer);
        const allBtns = document.querySelectorAll('.choice-btn');
        allBtns.forEach(b => b.disabled = true);
        
        if(clickedBtn) {
            if(isCorrect) {
                clickedBtn.classList.add('btn-correct');
            } else {
                clickedBtn.classList.add('btn-wrong');
            }
        }
        
        if(!isCorrect) {
            const correctText = String(playData.currentQ.a);
            allBtns.forEach(b => {
                if(String(b.innerText) === correctText) { 
                    b.classList.add('btn-miss-answer'); 
                }
            });
        }

        if(isCorrect) {
            const stats = getCharaStats();
            const timeBonus = 0.2 + (gameState.timeLeft / gameState.maxTime) * 1.8; 
            const comboBonus = 1 + (gameState.combo * 0.1);
            const damage = Math.floor(50 * stats.atk * timeBonus * comboBonus);
            
            gameState.enemyHP -= damage;
            if(gameState.enemyHP < 0) gameState.enemyHP = 0;
            gameState.score += damage;
            gameState.combo++;
            
            showCutIn("-" + damage); 
            updateUI();
            
            if(gameState.enemyHP <= 0) {
                setTimeout(gameClear, 1000);
            } else {
                playData.qIndex++;
                setTimeout(nextQuestion, 1000);
            }
        } else {
            gameState.lives--;
            gameState.combo = 0;
            showCutIn("MISS...");
            updateUI();
            
            if(gameState.lives <= 0) {
                setTimeout(gameOver, 1500);
            } else {
                setTimeout(() => { startTimer(); nextQuestion(); }, 1500);
            }
        }
    }
    
    function updateUI() {
        document.getElementById('ui-life').innerText = '‚ù§Ô∏è'.repeat(Math.max(0, gameState.lives));
        document.getElementById('ui-score').innerText = gameState.score;
        document.getElementById('ui-combo').innerText = gameState.combo;
        const hpPct = (gameState.enemyHP / gameState.maxHP) * 100;
        document.getElementById('ui-hp').style.width = hpPct + '%';
        document.getElementById('ui-hp-text').innerText = `${gameState.enemyHP} / ${gameState.maxHP}`;
    }
    
    function showCutIn(text) {
        const div = document.createElement('div');
        div.className = 'cutin';
        div.innerText = text;
        if(text.includes('MISS')) { div.style.color = '#bdc3c7'; div.style.webkitTextStroke = '2px #2c3e50'; }
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    }
    
    function gameClear() { finishGame(true); }
    function gameOver() { finishGame(false); }
    
    // ‚òÖ‰øÆÊ≠£: „É™„Ç∂„É´„ÉàË®àÁÆó„ÉªÊºîÂá∫
    function finishGame(isClear) {
        const stats = getCharaStats();
        
        // Âü∫Êú¨XP = „Çπ„Ç≥„Ç¢
        let baseXP = gameState.score; 
        let bonusText = ""; 
        
        // ‚òÖ‰øÆÊ≠£: „ÇØ„É™„Ç¢ÊôÇ 1.2ÂÄç
        if(isClear) {
            baseXP = Math.floor(baseXP * 1.2); 
            bonusText = "CLEAR BONUS +20%";
        } else {
            // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÅØ„Çπ„Ç≥„Ç¢„ÅÆÂçäÂàÜ („Éö„Éä„É´„ÉÜ„Ç£)
            baseXP = Math.floor(baseXP * 0.5);
        }
        
        const earnedXP = Math.floor(baseXP * stats.exp);
        gameState.xp += earnedXP;
        saveGame();
        
        const titleEl = document.getElementById('res-title');
        const iconEl = document.getElementById('res-icon');
        const bonusEl = document.getElementById('res-bonus');
        
        if(isClear) {
            titleEl.innerText = "QUEST CLEAR!";
            titleEl.style.color = "#f1c40f";
            iconEl.innerText = "üéâ";
            bonusEl.innerText = bonusText;
        } else {
            titleEl.innerText = "GAME OVER...";
            titleEl.style.color = "#bdc3c7";
            iconEl.innerText = ""; // ‚òÖ„Éâ„ÇØ„É≠„Å™„Åó
            bonusEl.innerText = "";
        }

        document.getElementById('res-score').innerText = gameState.score;
        document.getElementById('res-xp').innerText = "+" + earnedXP;
        
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-overlay').classList.remove('hidden');
    }
    
    function backToTitle() {
        document.getElementById('result-overlay').classList.add('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('title-screen').classList.remove('hidden');
        updateTitleInfo();
    }

    // === SHOP Logic ===
    function openShop() {
        document.getElementById('shop-overlay').classList.remove('hidden');
        renderShop();
    }
    function closeShop() {
        document.getElementById('shop-overlay').classList.add('hidden');
        updateTitleInfo();
    }
    function renderShop() {
        document.getElementById('shop-xp').innerText = gameState.xp;
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        
        if(!rawData.shopItems || rawData.shopItems.length === 0) {
            list.innerHTML = '<p>„Ç¢„Ç§„ÉÜ„É†„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br>„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´„ÄåShop„Äç„Ç∑„Éº„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
            return;
        }

        rawData.shopItems.forEach(item => {
            const level = gameState.itemLevels[item.id] || 0;
            const currentPrice = item.price * (level + 1);
            
            const div = document.createElement('div');
            div.className = `shop-item`;
            div.innerHTML = `
                <div class="shop-icon">${item.icon}</div>
                <div class="shop-info">
                    <div class="shop-name">
                        ${item.name} 
                        <span class="shop-level">Lv.${level}</span>
                    </div>
                    <div class="shop-desc">${item.desc}</div>
                </div>
                <div>
                    <button class="shop-buy-btn" onclick="buyItem('${item.id}', ${currentPrice})">
                        ‚¨Ü ${currentPrice} XP
                    </button>
                </div>
            `;
            list.appendChild(div);
        });
    }
    
    function buyItem(id, price) {
        if(gameState.xp < price) { alert("XP„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ"); return; }
        if(confirm("Âº∑Âåñ„Åó„Åæ„Åô„ÅãÔºü (" + price + " XPÊ∂àË≤ª)")) {
            gameState.xp -= price;
            if(!gameState.itemLevels[id]) gameState.itemLevels[id] = 0;
            gameState.itemLevels[id]++;
            
            saveGame();
            renderShop();
            alert("„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅÂäπÊûú„ÅåÂº∑Âåñ„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
        }
    }

    // === GACHA ===
    function openGacha() { document.getElementById('gacha-overlay').classList.remove('hidden'); renderZukan(); }
    function closeGacha() { document.getElementById('gacha-overlay').classList.add('hidden'); updateTitleInfo(); }
    function renderZukan() {
        if(!rawData.characters) rawData.characters = [];
        document.getElementById('gacha-xp').innerText = gameState.xp;
        const grid = document.getElementById('zukan-grid');
        grid.innerHTML = '';
        rawData.characters.forEach(c => {
            const isOwned = gameState.ownedCharas.includes(c.id);
            const isEquipped = gameState.equipped === c.id;
            const div = document.createElement('div');
            div.className = `char-card ${isOwned?'owned':''} ${isEquipped?'active':''}`;
            let visualHtml = '';
            if(c.imageUrl && String(c.imageUrl).startsWith('http')) {
                visualHtml = `<img src="${c.imageUrl}" class="char-img">`;
            } else {
                visualHtml = `<div style="font-size:2em;line-height:50px;">üì¶</div>`;
            }
            if(isOwned) {
                div.innerHTML = `<div class="rarity-${c.rarity}">${c.rarity}</div>${visualHtml}<div style="font-weight:bold; font-size:0.9em;">${c.name}</div><div style="font-size:0.7em;color:#666;">${c.type} x${c.value}</div>`;
                div.onclick = () => equipChara(c.id);
            } else {
                div.innerHTML = `<div style="padding:15px; color:#ccc; font-size:1.5em;">?</div>`;
            }
            grid.appendChild(div);
        });
    }
    function equipChara(id) { gameState.equipped = id; saveGame(); renderZukan(); }
    
    function rollGacha() {
        // ‚òÖ‰øÆÊ≠£: „Ç¨„ÉÅ„É£‰æ°Ê†º 3000 XP
        const COST = 3000;
        if(gameState.xp < COST) { alert("XP„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ"); return; }
        gameState.xp -= COST;
        
        const rand = Math.random();
        let rarity = 'N';
        if(rand < 0.05) rarity = 'SSR';      
        else if(rand < 0.20) rarity = 'SR';  
        else if(rand < 0.50) rarity = 'R';   

        const targets = rawData.characters.filter(c => c.rarity === rarity);
        if(targets.length === 0) { alert("„Ç®„É©„Éº: " + rarity + "„ÅÆ„Ç≠„É£„É©„Åå„ÅÑ„Åæ„Åõ„Çì"); gameState.xp += COST; return; }
        
        const hit = targets[Math.floor(Math.random() * targets.length)];
        
        let isNew = false;
        if(!gameState.ownedCharas.includes(hit.id)) {
            gameState.ownedCharas.push(hit.id);
            isNew = true;
        } else {
            gameState.xp += 200; 
        }
        
        saveGame();
        renderZukan();
        updateTitleInfo();
        
        showGachaResult(hit, isNew);
    }
    
    function showGachaResult(char, isNew) {
        const overlay = document.getElementById('gacha-result-overlay');
        const container = document.getElementById('gr-container');
        
        let imgHtml = '';
        if(char.imageUrl && char.imageUrl.startsWith('http')) {
            imgHtml = `<img src="${char.imageUrl}" class="gr-img">`;
        } else {
            imgHtml = `<div style="font-size:80px;">üì¶</div>`;
        }
        
        container.innerHTML = `
            <div class="gacha-result-card">
                ${isNew ? '<div class="gr-new">NEW!</div>' : ''}
                <div class="gr-rarity rarity-${char.rarity}">‚òÖ ${char.rarity}</div>
                ${imgHtml}
                <div class="gr-name">${char.name}</div>
                <div class="gr-desc">${char.desc}</div>
                <div class="gr-effect">${char.type} x${char.value}</div>
                ${!isNew ? '<div style="color:#7f8c8d; font-size:0.9em; margin-top:10px;">„Åô„Åß„Å´ÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô (XP+200)</div>' : ''}
            </div>
        `;
        
        document.getElementById('gacha-overlay').classList.add('hidden'); 
        overlay.classList.remove('hidden');
    }
    
    function closeGachaResult() {
        document.getElementById('gacha-result-overlay').classList.add('hidden');
        updateTitleInfo();
    }
</script>
</body>
</html>